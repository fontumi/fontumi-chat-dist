var __awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(a,s)}u((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}};FontumiChat.loadBundle("znh1acmq",["exports"],function(t){var e=this,n=window.FontumiChat.h,r=function(){function t(){this.opened=!1}return t.prototype.toggleBtn=function(){this.toggle.emit(),this.opened=!this.opened},t.prototype.render=function(){var t=this,e=window.fontumiConfig;return n("div",{id:"bubble-button",style:{background:e.colors.a},onClick:function(){t.toggleBtn()}},this.opened?n("close-icon",{style:{height:"30px"}}):n("messages-icon",{width:"30px"}))},Object.defineProperty(t,"is",{get:function(){return"bubble-button"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{opened:{state:!0},toggleBtn:{method:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"events",{get:function(){return[{name:"toggle",method:"toggle",bubbles:!0,cancelable:!0,composed:!0}]},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"#bubble-button.sc-bubble-button{position:fixed;bottom:15px;right:15px;width:50px;height:50px;border-radius:50%;z-index:1000000!important;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;color:#fff;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-box-shadow:var(--fontumi-shadow);-moz-box-shadow:var(--fontumi-shadow);box-shadow:var(--fontumi-shadow)}#message-icon.sc-bubble-button{display:block;width:25px;background:var(--fontumi-message-icon)}"},enumerable:!0,configurable:!0}),t}(),i=function(){function t(){}return t.prototype.render=function(){return n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"white",version:"1.1",id:"Layer_1",x:"0px",y:"0px",viewBox:"0 0 513 513",width:this.width},n("path",{d:"M513,256.5c0,68.38-26.629,132.667-74.98,181.02C389.667,485.871,325.38,512.5,257,512.5  c-52.59,0-103.121-15.831-146.131-45.78C82.215,446.767,58.23,421.541,40,392.438V446.5H0v-120h120v40H70.978  c38.392,65.347,108.17,106,186.022,106c119.103,0,216-96.897,216-216H513z M255,40.5c77.853,0,147.631,40.654,186.022,106H393v40  h119v-120h-40v54.061c-18.23-29.102-42.215-54.329-70.869-74.281C358.121,16.331,307.59,0.5,255,0.5  c-68.341,0-132.465,26.644-180.561,75.022C26.437,123.808,0,188.08,0,256.5h40C40,137.397,136.448,40.5,255,40.5z M179.354,141.5  l-25.857,25.642c-11.558,11.556-12.78,27.601-7.504,43.872c9.132,28.166,18.733,50.284,62.715,94.256  c43.981,43.973,67.283,51.094,94.663,62.379c6.303,2.598,12.257,3.85,17.836,3.85c9.917,0,18.648-3.958,26.045-11.353L373,334.297  l-66.149-66.245l-34.111,33.352c-9.043-6.616-19.285-15.482-31.988-28.182c-12.849-12.846-22.641-23.755-30.036-33.488  l33.113-33.385L179.354,141.5z"}))},Object.defineProperty(t,"is",{get:function(){return"callback-icon"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{width:{type:String,attr:"width"}}},enumerable:!0,configurable:!0}),t}();function o(t){window.fontumiConfig.debug&&console.warn("FONTUMI:DEBUG",t)}var a=function(){function t(){this.fontumi=window.fontumi,this.fontumiConfig=window.fontumiConfig,this.inCall=this.fontumiConfig.call&&this.fontumiConfig.call.only}return t.prototype.onToggleCall=function(){o("chat-card toggled"),this.inCall?(this.el.shadowRoot.querySelector("chat-card-call").hangup(),this.inCall=!1):this.inCall=!0},t.prototype.render=function(){return n("div",{id:"chat-card"},n("chat-card-header",null),this.inCall&&n("chat-card-call",null),n("chat-card-messages",{style:{display:this.inCall?"none":""}}),"",n("chat-card-byfontumi",null))},Object.defineProperty(t,"is",{get:function(){return"chat-card"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{el:{elementRef:!0},inCall:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"listeners",{get:function(){return[{name:"toggleCall",method:"onToggleCall"}]},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"\@-webkit-keyframes Gradient{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}\@-moz-keyframes Gradient{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}\@keyframes Gradient{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}#chat-card.sc-chat-card, #chat-card-footer.sc-chat-card, #chat-card-header.sc-chat-card{display:-ms-flexbox;display:flex}#chat-card.sc-chat-card{-ms-flex-direction:column;flex-direction:column;margin-bottom:10px!important;background:#fff!important;border-radius:1px!important;-webkit-box-shadow:var(--fontumi-shadow)!important;box-shadow:var(--fontumi-shadow)!important;margin:20px;font-family:Work Sans,sans-serif}#chat-card-header.sc-chat-card{-ms-flex-align:center;align-items:center;min-height:50px;border-radius:0 0;padding:var(--fontumi-flex-padding);color:#fff;-ms-flex-wrap:wrap;flex-wrap:wrap;background-size:400% 400%;-webkit-animation:Gradient 15s ease infinite;-moz-animation:Gradient 15s ease infinite;animation:Gradient 15s ease infinite}#chat-card-header.sc-chat-card, #icons-header.sc-chat-card{-ms-flex-pack:center;justify-content:center}#icons-header.sc-chat-card{display:-ms-flexbox;display:flex;width:100%}#logo.sc-chat-card{display:block;border-radius:50%;-o-object-fit:cover;object-fit:cover;overflow:hidden;width:50px;height:50px}#logo-name.sc-chat-card{font-family:var(--fontumi-font);margin:0 10px}#logo-name.sc-chat-card > h2.sc-chat-card{font-size:1.2rem!important;text-align:center!important}#call-back-icon.sc-chat-card, #call-icon.sc-chat-card, #messages-icon.sc-chat-card, #video-call-icon.sc-chat-card{padding:3px;margin:3px;text-align:center;font-size:10px}#chat-card-content.sc-chat-card{-ms-flex-direction:column;flex-direction:column;max-height:calc(100vh - 400px);min-height:80px;overflow:scroll;overflow-y:visible;overflow-x:hidden;padding:10px}#chat-card-content.sc-chat-card::-webkit-scrollbar{-webkit-appearance:none;width:7px}#chat-card-content.sc-chat-card::-webkit-scrollbar-thumb{border-radius:1px;background-color:rgba(0,0,0,.5);box-shadow:0 0 1px hsla(0,0%,100%,.5);-webkit-box-shadow:0 0 1px hsla(0,0%,100%,.5)}#chat-card-footer.sc-chat-card{height:30px;-ms-flex-align:center;align-items:center;padding:10px;border-top:1px solid #a7a7a7}button.sc-chat-card{padding:6px 10px!important;border-style:solid!important;border-width:1px!important}button.sc-chat-card, input.sc-chat-card{width:100%;outline:none;padding:10px 0;border:0;font-size:15px;background:transparent}#chat-byfontumi.sc-chat-card{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;justify-items:center;margin-top:3px}#chat-byfontumi.sc-chat-card > div.sc-chat-card{width:100%;text-align:center}#chat-byfontumi.sc-chat-card   img.sc-chat-card{height:15px;margin:2px}#chat-card-call.sc-chat-card{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;justify-items:center;background-size:400% 400%;-webkit-animation:Gradient 15s ease infinite;-moz-animation:Gradient 15s ease infinite;animation:Gradient 15s ease infinite}#chat-card-call.sc-chat-card > div.sc-chat-card{margin:40px 0}.call-note.sc-chat-card{color:#fff;font-size:10px;width:80%;margin:auto}"},enumerable:!0,configurable:!0}),t}(),s=function(){function t(){}return t.prototype.render=function(){return n("div",{id:"chat-byfontumi"},n("div",null,n("img",{src:"https://www.fontumi.co/empresas/logos/byfontumilogo.png",onClick:function(){return window.open("https://www.fontumi.co","_blank")}})))},Object.defineProperty(t,"is",{get:function(){return"chat-card-byfontumi"},enumerable:!0,configurable:!0}),t}(),u="undefined"!=typeof VoxImplant?VoxImplant.getInstance():null,c=function(){return ur(e,void 0,void 0,function(){return cr(this,function(t){return VoxImplant?[2,u.call(window.fontumiConfig.call.number)]:[2]})})},h=function(){function t(){this.fontumiConfig=window.fontumiConfig,this.call=null,this.isInCall=!1}return t.prototype.makeCall=function(){return ur(this,void 0,void 0,function(){var t,e,n=this;return cr(this,function(r){switch(r.label){case 0:o("calling"),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,c()];case 2:return t.call=r.sent(),this.isInCall=!0,o("call conected"),this.call.on(window.VoxImplant.CallEvents.Disconnected,function(){return n.hangup()}),[3,4];case 3:return e=r.sent(),console.log(e),[3,4];case 4:return[2]}})})},t.prototype.hangup=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){try{this.call.hangup()}catch(t){console.warn(t)}return this.call=null,this.isInCall=!1,o("call ended"),[2]})})},t.prototype.componentDidLoad=function(){return ur(this,void 0,void 0,function(){var t;return cr(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),u.connected()?[3,2]:[4,ur(e,void 0,void 0,function(){var t;return cr(this,function(e){switch(e.label){case 0:if(!VoxImplant)return[3,12];e.label=1;case 1:return e.trys.push([1,11,,12]),[4,u.init({micRequired:!0,progressTone:!0,progressToneCountry:"US"})];case 2:e.sent(),u.addEventListener(VoxImplant.Events.ConnectionClosed,function(){console.log("closed")}),e.label=3;case 3:return e.trys.push([3,9,,10]),[4,u.connect()];case 4:e.sent(),t=window.fontumiConfig.call.vox,e.label=5;case 5:return e.trys.push([5,7,,8]),[4,u.login(atob(t.split("#")[0]),atob(t.split("#")[1]))];case 6:return e.sent(),[2,u];case 7:throw e.sent();case 8:return[3,10];case 9:throw e.sent();case 10:return[3,12];case 11:throw e.sent();case 12:return[2]}})})];case 1:n.sent(),n.label=2;case 2:return this.makeCall(),o("chat-card-call loaded"),[3,4];case 3:return t=n.sent(),console.log(t),[3,4];case 4:return[2]}})})},t.prototype.render=function(){var t=this;return n("div",{id:"chat-card-call",style:{background:"linear-gradient(-45deg, "+this.fontumiConfig.colors.a+", "+this.fontumiConfig.colors.b+", #5b036c) 0% 0% / 400% 400%"}},n("div",{style:{textAlign:"center"}},this.isInCall?n("div",{onClick:function(){return t.hangup()}},n("hangup-icon",{width:"30px"})):n("div",{onClick:function(){return t.makeCall()}},n("call-icon",{width:"30px"})),n("p",{class:"call-note"},"Si tu conexión a internet no es lo suficientemente buena la llamada puede fallar.")))},Object.defineProperty(t,"is",{get:function(){return"chat-card-call"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{call:{state:!0},hangup:{method:!0},isInCall:{state:!0}}},enumerable:!0,configurable:!0}),t}(),l=function(){function t(){this.fontumiConfig=window.fontumiConfig,this.inCall=!1}return t.prototype.render=function(){var t=this;return n("div",{id:"chat-card-header",style:{background:"linear-gradient(45deg, "+this.fontumiConfig.colors.a+", "+this.fontumiConfig.colors.b+")"}},n("img",{id:"logo",src:this.fontumiConfig.logo,alt:""}),n("div",{id:"logo-name"},n("h2",null,this.fontumiConfig.name)),n("div",{id:"icons-header"},this.fontumiConfig.call&&!this.fontumiConfig.call.only&&(this.inCall?n("div",{id:"messages-icon"},n("messages-icon",{width:"25px",onClick:function(){t.toggleCall.emit(),t.inCall=!t.inCall}}),n("br",null),n("span",null,this.fontumiConfig.ui&&this.fontumiConfig.ui.chat||"Chat")):n("div",{id:"call-icon"},n("call-icon",{width:"25px",onClick:function(){t.toggleCall.emit(),t.inCall=!t.inCall}}),n("br",null),n("span",null,this.fontumiConfig.ui&&this.fontumiConfig.ui.call||"Call"))),this.fontumiConfig.videoCallUrl&&n("div",{id:"video-call-icon"},n("video-call-icon",{width:"25px",onClick:function(){return window.open(t.fontumiConfig.videoCallUrl,"_blank")}}),n("br",null),n("span",null,this.fontumiConfig.ui&&this.fontumiConfig.ui.video||"Video")),this.fontumiConfig.callBackUrl&&n("div",{id:"call-back-icon"},n("callback-icon",{width:"25px",onClick:function(){return window.open(t.fontumiConfig.callBackUrl,"_black")}}),n("br",null),n("span",null,this.fontumiConfig.ui&&this.fontumiConfig.ui.callback||"Callback"))))},Object.defineProperty(t,"is",{get:function(){return"chat-card-header"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{inCall:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"events",{get:function(){return[{name:"toggleCall",method:"toggleCall",bubbles:!0,cancelable:!0,composed:!0}]},enumerable:!0,configurable:!0}),t}();!function(t){if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(t){return t&&DataView.prototype.isPrototypeOf(t)},i=ArrayBuffer.isView||function(t){return t&&n.indexOf(Object.prototype.toString.call(t))>-1};h.prototype.append=function(t,e){t=s(t),e=u(e);var n=this.map[t];this.map[t]=n?n+","+e:e},h.prototype.delete=function(t){delete this.map[s(t)]},h.prototype.get=function(t){return t=s(t),this.has(t)?this.map[t]:null},h.prototype.has=function(t){return this.map.hasOwnProperty(s(t))},h.prototype.set=function(t,e){this.map[s(t)]=u(e)},h.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},h.prototype.keys=function(){var t=[];return this.forEach(function(e,n){t.push(n)}),c(t)},h.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),c(t)},h.prototype.entries=function(){var t=[];return this.forEach(function(e,n){t.push([n,e])}),c(t)},e.iterable&&(h.prototype[Symbol.iterator]=h.prototype.entries);var o=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];y.prototype.clone=function(){return new y(this,{body:this._bodyInit})},m.call(y.prototype),m.call(v.prototype),v.prototype.clone=function(){return new v(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},v.error=function(){var t=new v(null,{status:0,statusText:""});return t.type="error",t};var a=[301,302,303,307,308];v.redirect=function(t,e){if(-1===a.indexOf(e))throw new RangeError("Invalid status code");return new v(null,{status:e,headers:{location:t}})},t.Headers=h,t.Request=y,t.Response=v,t.fetch=function(t,n){return new Promise(function(r,i){var o=new y(t,n),a=new XMLHttpRequest;a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new h,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var n=t.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();e.append(r,i)}}),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL"),r(new v("response"in a?a.response:a.responseText,n))},a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=function(){i(new TypeError("Network request failed"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&e.blob&&(a.responseType="blob"),o.headers.forEach(function(t,e){a.setRequestHeader(e,t)}),a.send(void 0===o._bodyInit?null:o._bodyInit)})},t.fetch.polyfill=!0}function s(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function u(t){return"string"!=typeof t&&(t=String(t)),t}function c(t){var n={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(n[Symbol.iterator]=function(){return n}),n}function h(t){this.map={},t instanceof h?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function l(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function f(t){return new Promise(function(e,n){t.onload=function(){e(t.result)},t.onerror=function(){n(t.error)}})}function p(t){var e=new FileReader,n=f(e);return e.readAsArrayBuffer(t),n}function d(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function m(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&r(t))this._bodyArrayBuffer=d(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!i(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=d(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=l(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?l(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}),this.text=function(){var t,e,n,r=l(this);if(r)return r;if(this._bodyBlob)return t=this._bodyBlob,n=f(e=new FileReader),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),r=0;r<e.length;r++)n[r]=String.fromCharCode(e[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(g)}),this.json=function(){return this.text().then(JSON.parse)},this}function y(t,e){var n,r,i=(e=e||{}).body;if(t instanceof y){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new h(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new h(e.headers)),this.method=(r=(n=e.method||this.method||"GET").toUpperCase(),o.indexOf(r)>-1?r:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function g(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var n=t.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(i))}}),e}function v(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new h(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:void 0);var f="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function p(t,e){return t(e={exports:{}},e.exports),e.exports}function d(t){var e=this.constructor;return this.then(function(n){return e.resolve(t()).then(function(){return n})},function(n){return e.resolve(t()).then(function(){return e.reject(n)})})}var m=setTimeout;function y(){}function g(t){if(!(this instanceof g))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],T(t,this)}function v(t,e){for(;3===t._state;)t=t._value;0!==t._state?(t._handled=!0,g._immediateFn(function(){var n=1===t._state?e.onFulfilled:e.onRejected;if(null!==n){var r;try{r=n(t._value)}catch(t){return void w(e.promise,t)}b(e.promise,r)}else(1===t._state?b:w)(e.promise,t._value)})):t._deferreds.push(e)}function b(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof g)return t._state=3,t._value=e,void S(t);if("function"==typeof n)return void T((r=n,i=e,function(){r.apply(i,arguments)}),t)}t._state=1,t._value=e,S(t)}catch(e){w(t,e)}var r,i}function w(t,e){t._state=2,t._value=e,S(t)}function S(t){2===t._state&&0===t._deferreds.length&&g._immediateFn(function(){t._handled||g._unhandledRejectionFn(t._value)});for(var e=0,n=t._deferreds.length;e<n;e++)v(t,t._deferreds[e]);t._deferreds=null}function E(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function T(t,e){var n=!1;try{t(function(t){n||(n=!0,b(e,t))},function(t){n||(n=!0,w(e,t))})}catch(t){if(n)return;n=!0,w(e,t)}}g.prototype.catch=function(t){return this.then(null,t)},g.prototype.then=function(t,e){var n=new this.constructor(y);return v(this,new E(t,e,n)),n},g.prototype.finally=d,g.all=function(t){return new g(function(e,n){if(!t||void 0===t.length)throw new TypeError("Promise.all accepts an array");var r=Array.prototype.slice.call(t);if(0===r.length)return e([]);var i=r.length;function o(t,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){o(t,e)},n)}r[t]=a,0==--i&&e(r)}catch(t){n(t)}}for(var a=0;a<r.length;a++)o(a,r[a])})},g.resolve=function(t){return t&&"object"==typeof t&&t.constructor===g?t:new g(function(e){e(t)})},g.reject=function(t){return new g(function(e,n){n(t)})},g.race=function(t){return new g(function(e,n){for(var r=0,i=t.length;r<i;r++)t[r].then(e,n)})},g._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){m(t,0)},g._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var I=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==f)return f;throw new Error("unable to locate global object")}();"Promise"in I?I.Promise.prototype.finally||(I.Promise.prototype.finally=d):I.Promise=g;var C,D,A,N=function(t,e,n){if(function(e){if("function"!=typeof t)throw TypeError(String(t)+" is not a function")}(),void 0===e)return t;switch(n){case 0:return function(){return t.call(e)};case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)}}return function(){return t.apply(e,arguments)}},k=function(t){try{return!!t()}catch(t){return!0}},O={}.toString,R=function(t){return O.call(t).slice(8,-1)},_="".split,M=k(function(){return!Object("z").propertyIsEnumerable(0)})?function(t){return"String"==R(t)?_.call(t,""):Object(t)}:Object,P=function(t){if(null==t)throw TypeError("Can't call method on "+t);return t},x=function(t){return Object(P(t))},L=Math.ceil,q=Math.floor,F=function(t){return isNaN(t=+t)?0:(t>0?q:L)(t)},B=Math.min,V=function(t){return t>0?B(F(t),9007199254740991):0},U=function(t){return"object"==typeof t?null!==t:"function"==typeof t},j=Array.isArray||function(t){return"Array"==R(t)},Q="object"==typeof window&&window&&window.Math==Math?window:"object"==typeof self&&self&&self.Math==Math?self:Function("return this")(),K=!k(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),G=Q.document,W=U(G)&&U(G.createElement),z=function(t){return W?G.createElement(t):{}},H=!K&&!k(function(){return 7!=Object.defineProperty(z("div"),"a",{get:function(){return 7}}).a}),Y=function(t){if(!U(t))throw TypeError(String(t)+" is not an object");return t},X=function(t,e){if(!U(t))return t;var n,r;if(e&&"function"==typeof(n=t.toString)&&!U(r=n.call(t)))return r;if("function"==typeof(n=t.valueOf)&&!U(r=n.call(t)))return r;if(!e&&"function"==typeof(n=t.toString)&&!U(r=n.call(t)))return r;throw TypeError("Can't convert object to primitive value")},J=Object.defineProperty,$={f:K?J:function(t,e,n){if(Y(t),e=X(e,!0),Y(n),H)try{return J(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(t[e]=n.value),t}},Z=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},tt=K?function(t,e,n){return $.f(t,e,Z(1,n))}:function(t,e,n){return t[e]=n,t},et=function(t,e){try{tt(Q,t,e)}catch(n){Q[t]=e}return e},nt=p(function(t){var e=Q["__core-js_shared__"]||et("__core-js_shared__",{});(t.exports=function(t,n){return e[t]||(e[t]=void 0!==n?n:{})})("versions",[]).push({version:"3.0.1",mode:"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})}),rt=0,it=Math.random(),ot=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++rt+it).toString(36))},at=!k(function(){return!String(Symbol())}),st=nt("wks"),ut=Q.Symbol,ct=function(t){return st[t]||(st[t]=at&&ut[t]||(at?ut:ot)("Symbol."+t))},ht=ct("species"),lt=function(t,e){var n;return j(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!j(n.prototype)?U(n)&&null===(n=n[ht])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===e?0:e)},ft=function(t,e){var n=1==t,r=2==t,i=3==t,o=4==t,a=6==t,s=5==t||a,u=e||lt;return function(e,c,h){for(var l,f,p=x(e),d=M(p),m=N(c,h,3),y=V(d.length),g=0,v=n?u(e,y):r?u(e,0):void 0;y>g;g++)if((s||g in d)&&(f=m(l=d[g],g,p),t))if(n)v[g]=f;else if(f)switch(t){case 3:return!0;case 5:return l;case 6:return g;case 2:v.push(l)}else if(o)return!1;return a?-1:i||o?o:v}},pt={}.propertyIsEnumerable,dt=Object.getOwnPropertyDescriptor,mt={f:dt&&!pt.call({1:2},1)?function(t){var e=dt(this,t);return!!e&&e.enumerable}:pt},yt=function(t){return M(P(t))},gt={}.hasOwnProperty,vt=function(t,e){return gt.call(t,e)},bt=Object.getOwnPropertyDescriptor,wt={f:K?bt:function(t,e){if(t=yt(t),e=X(e,!0),H)try{return bt(t,e)}catch(t){}if(vt(t,e))return Z(!mt.f.call(t,e),t[e])}},St=nt("native-function-to-string",Function.toString),Et=Q.WeakMap,Tt="function"==typeof Et&&/native code/.test(St.call(Et)),It=nt("keys"),Ct=function(t){return It[t]||(It[t]=ot(t))},Dt={};if(Tt){var At=new(0,Q.WeakMap),Nt=At.get,kt=At.has,Ot=At.set;C=function(t,e){return Ot.call(At,t,e),e},D=function(t){return Nt.call(At,t)||{}},A=function(t){return kt.call(At,t)}}else{var Rt=Ct("state");Dt[Rt]=!0,C=function(t,e){return tt(t,Rt,e),e},D=function(t){return vt(t,Rt)?t[Rt]:{}},A=function(t){return vt(t,Rt)}}var _t={set:C,get:D,has:A,enforce:function(t){return A(t)?D(t):C(t,{})},getterFor:function(t){return function(e){var n;if(!U(e)||(n=D(e)).type!==t)throw TypeError("Incompatible receiver, "+t+" required");return n}}},Mt=p(function(t){var e=_t.get,n=_t.enforce,r=String(St).split("toString");nt("inspectSource",function(t){return St.call(t)}),(t.exports=function(t,e,i,o){var a=!!o&&!!o.unsafe,s=!!o&&!!o.enumerable,u=!!o&&!!o.noTargetGet;"function"==typeof i&&("string"!=typeof e||vt(i,"name")||tt(i,"name",e),n(i).source=r.join("string"==typeof e?e:"")),t!==Q?(a?!u&&t[e]&&(s=!0):delete t[e],s?t[e]=i:tt(t,e,i)):s?t[e]=i:et(e,i)})(Function.prototype,"toString",function(){return"function"==typeof this&&e(this).source||St.call(this)})}),Pt=Math.max,xt=Math.min,Lt=(!1,function(t,e,n){var r=yt(t),i=V(r.length),o=function(t,e){var r=F(n);return r<0?Pt(r+e,0):xt(r,e)}(0,i);for(0;i>o;o++)if(o in r&&r[o]===e)return o||0;return-1}),qt=function(t,e){var n,r=yt(t),i=0,o=[];for(n in r)!vt(Dt,n)&&vt(r,n)&&o.push(n);for(;e.length>i;)vt(r,n=e[i++])&&(~Lt(o,n)||o.push(n));return o},Ft=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Bt=Ft.concat("length","prototype"),Vt={f:Object.getOwnPropertyNames||function(t){return qt(t,Bt)}},Ut={f:Object.getOwnPropertySymbols},jt=Q.Reflect,Qt=jt&&jt.ownKeys||function(t){var e=Vt.f(Y(t)),n=Ut.f;return n?e.concat(n(t)):e},Kt=function(t,e){for(var n=Qt(e),r=$.f,i=wt.f,o=0;o<n.length;o++){var a=n[o];vt(t,a)||r(t,a,i(e,a))}},Gt=/#|\.prototype\./,Wt=function(t,e){var n=Ht[zt(t)];return n==Xt||n!=Yt&&("function"==typeof e?k(e):!!e)},zt=Wt.normalize=function(t){return String(t).replace(Gt,".").toLowerCase()},Ht=Wt.data={},Yt=Wt.NATIVE="N",Xt=Wt.POLYFILL="P",Jt=Wt,$t=wt.f,Zt=function(t,e){var n,r,i,o,a,s=t.target,u=t.global,c=t.stat;if(n=u?Q:c?Q[s]||et(s,{}):(Q[s]||{}).prototype)for(r in e){if(o=e[r],i=t.noTargetGet?(a=$t(n,r))&&a.value:n[r],!Jt(u?r:s+(c?".":"#")+r,t.forced)&&void 0!==i){if(typeof o==typeof i)continue;Kt(o,i)}(t.sham||i&&i.sham)&&tt(o,"sham",!0),Mt(n,r,o,t)}},te=Object.keys||function(t){return qt(t,Ft)},ee=K?Object.defineProperties:function(t,e){Y(t);for(var n,r=te(e),i=r.length,o=0;i>o;)$.f(t,n=r[o++],e[n]);return t},ne=Q.document,re=ne&&ne.documentElement,ie=Ct("IE_PROTO"),oe=function(){},ae=function(){var t,e=z("iframe"),n=Ft.length;for(e.style.display="none",re.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),ae=t.F;n--;)delete ae.prototype[Ft[n]];return ae()},se=Object.create||function(t,e){var n;return null!==t?(oe.prototype=Y(t),n=new oe,oe.prototype=null,n[ie]=t):n=ae(),void 0===e?n:ee(n,e)};Dt[ie]=!0;var ue=ct("unscopables"),ce=Array.prototype;null==ce[ue]&&tt(ce,ue,se(null));var he=function(t){ce[ue][t]=!0},le=ft(5),fe=!0;"find"in[]&&Array(1).find(function(){fe=!1}),Zt({target:"Array",proto:!0,forced:fe},{find:function(t){return le(this,t,arguments.length>1?arguments[1]:void 0)}}),he("find");var pe=Function.call,de=function(t,e,n){return N(pe,Q[t].prototype[e],n)},me=(de("Array","find"),ft(6)),ye=!0;"findIndex"in[]&&Array(1).findIndex(function(){ye=!1}),Zt({target:"Array",proto:!0,forced:ye},{findIndex:function(t){return me(this,t,arguments.length>1?arguments[1]:void 0)}}),he("findIndex"),de("Array","findIndex");var ge=Object.assign,ve=!ge||k(function(){var t={},e={},n=Symbol();return t[n]=7,"abcdefghijklmnopqrst".split("").forEach(function(t){e[t]=t}),7!=ge({},t)[n]||"abcdefghijklmnopqrst"!=te(ge({},e)).join("")})?function(t,e){for(var n=x(t),r=arguments.length,i=1,o=Ut.f,a=mt.f;r>i;)for(var s,u=M(arguments[i++]),c=o?te(u).concat(o(u)):te(u),h=c.length,l=0;h>l;)a.call(u,s=c[l++])&&(n[s]=u[s]);return n}:ge;Zt({target:"Object",stat:!0,forced:Object.assign!==ve},{assign:ve});var be=Q,we=ct("match"),Se=ct("match"),Ee=function(t){var e=/./;try{"/./".startsWith(e)}catch(t){try{return e[Se]=!1,"/./".startsWith(e)}catch(t){}}return!1}(),Te="".startsWith;Zt({target:"String",proto:!0,forced:!Ee},{startsWith:function(t){var e=function(t,e,n){if(U(r=e)&&(void 0!==(i=r[we])?i:"RegExp"==R(r)))throw TypeError("String.prototype."+n+" doesn't accept regex");var r,i;return String(P(t))}(this,t,"startsWith"),n=V(Math.min(arguments.length>1?arguments[1]:void 0,e.length)),r=String(t);return Te?Te.call(e,r,n):e.slice(n,n+r.length)===r}}),de("String","startsWith"),Zt({target:"String",proto:!0},{repeat:"".repeat||function(t){var e=String(P(this)),n="",r=F(t);if(r<0||r==1/0)throw RangeError("Wrong number of repetitions");for(;r>0;(r>>>=1)&&(e+=e))1&r&&(n+=e);return n}}),de("String","repeat");var Ie=function(t,e,n){var r=X(e);r in t?$.f(t,r,Z(0,n)):t[r]=n},Ce=ct("species"),De=ct("isConcatSpreadable"),Ae=!k(function(){var t=[];return t[De]=!1,t.concat()[0]!==t}),Ne=!k(function(){var t=[];return(t.constructor={})[Ce]=function(){return{foo:1}},1!==t.concat(Boolean).foo}),ke=function(t){if(!U(t))return!1;var e=t[De];return void 0!==e?!!e:j(t)};Zt({target:"Array",proto:!0,forced:!Ae||!Ne},{concat:function(t){var e,n,r,i,o,a=x(this),s=lt(a,0),u=0;for(e=-1,r=arguments.length;e<r;e++)if(ke(o=-1===e?a:arguments[e])){if(u+(i=V(o.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(n=0;n<i;n++,u++)n in o&&Ie(s,u,o[n])}else{if(u>=9007199254740991)throw TypeError("Maximum allowed index exceeded");Ie(s,u++,o)}return s.length=u,s}});var Oe=ct("toStringTag"),Re="Arguments"==R(function(){return arguments}()),_e={};_e[ct("toStringTag")]="z";var Me="[object z]"!==String(_e)?function(){return"[object "+(void 0===this?"Undefined":null===this?"Null":"string"==typeof(e=function(t,e){try{return t[e]}catch(t){}}(t=Object(this),Oe))?e:Re?R(t):"Object"==(n=R(t))&&"function"==typeof t.callee?"Arguments":n)+"]";var t,e,n}:_e.toString,Pe=Object.prototype;Me!==Pe.toString&&Mt(Pe,"toString",Me,{unsafe:!0});var xe=$.f,Le=ct("toStringTag"),qe=function(t,e,n){t&&!vt(t=n?t:t.prototype,Le)&&xe(t,Le,{configurable:!0,value:e})},Fe={f:ct},Be=$.f,Ve=function(t){var e=be.Symbol||(be.Symbol={});vt(e,t)||Be(e,t,{value:Fe.f(t)})},Ue=Vt.f,je={}.toString,Qe="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],Ke={f:function(t){return Qe&&"[object Window]"==je.call(t)?function(t){try{return Ue(t)}catch(t){return Qe.slice()}}(t):Ue(yt(t))}},Ge=Ct("hidden"),We=_t.set,ze=_t.getterFor("Symbol"),He=wt.f,Ye=$.f,Xe=Ke.f,Je=Q.Symbol,$e=Q.JSON,Ze=$e&&$e.stringify,tn=ct("toPrimitive"),en=mt.f,nn=nt("symbol-registry"),rn=nt("symbols"),on=nt("op-symbols"),an=nt("wks"),sn=Object.prototype,un=Q.QObject,cn=!un||!un.prototype||!un.prototype.findChild,hn=K&&k(function(){return 7!=se(Ye({},"a",{get:function(){return Ye(this,"a",{value:7}).a}})).a})?function(t,e,n){var r=He(sn,e);r&&delete sn[e],Ye(t,e,n),r&&t!==sn&&Ye(sn,e,r)}:Ye,ln=function(t,e){var n=rn[t]=se(Je.prototype);return We(n,{type:"Symbol",tag:t,description:e}),K||(n.description=e),n},fn=at&&"symbol"==typeof Je.iterator?function(t){return"symbol"==typeof t}:function(t){return Object(t)instanceof Je},pn=function(t,e,n){return t===sn&&pn(on,e,n),Y(t),e=X(e,!0),Y(n),vt(rn,e)?(n.enumerable?(vt(t,Ge)&&t[Ge][e]&&(t[Ge][e]=!1),n=se(n,{enumerable:Z(0,!1)})):(vt(t,Ge)||Ye(t,Ge,Z(1,{})),t[Ge][e]=!0),hn(t,e,n)):Ye(t,e,n)},dn=function(t,e){Y(t);for(var n,r=function(t){var e=te(t),n=Ut.f;if(n)for(var r,i=n(t),o=mt.f,a=0;i.length>a;)o.call(t,r=i[a++])&&e.push(r);return e}(e=yt(e)),i=0,o=r.length;o>i;)pn(t,n=r[i++],e[n]);return t},mn=function(t){var e=en.call(this,t=X(t,!0));return!(this===sn&&vt(rn,t)&&!vt(on,t))&&(!(e||!vt(this,t)||!vt(rn,t)||vt(this,Ge)&&this[Ge][t])||e)},yn=function(t,e){if(t=yt(t),e=X(e,!0),t!==sn||!vt(rn,e)||vt(on,e)){var n=He(t,e);return!n||!vt(rn,e)||vt(t,Ge)&&t[Ge][e]||(n.enumerable=!0),n}},gn=function(t){for(var e,n=Xe(yt(t)),r=[],i=0;n.length>i;)vt(rn,e=n[i++])||vt(Dt,e)||r.push(e);return r},vn=function(t){for(var e,n=t===sn,r=Xe(n?on:yt(t)),i=[],o=0;r.length>o;)!vt(rn,e=r[o++])||n&&!vt(sn,e)||i.push(rn[e]);return i};at||(Mt((Je=function(){if(this instanceof Je)throw TypeError("Symbol is not a constructor");var t=void 0===arguments[0]?void 0:String(arguments[0]),e=ot(t),n=function(t){this===sn&&n.call(on,t),vt(this,Ge)&&vt(this[Ge],e)&&(this[Ge][e]=!1),hn(this,e,Z(1,t))};return K&&cn&&hn(sn,e,{configurable:!0,set:n}),ln(e,t)}).prototype,"toString",function(){return ze(this).tag}),mt.f=mn,$.f=pn,wt.f=yn,Vt.f=Ke.f=gn,Ut.f=vn,K&&(Ye(Je.prototype,"description",{configurable:!0,get:function(){return ze(this).description}}),Mt(sn,"propertyIsEnumerable",mn,{unsafe:!0})),Fe.f=function(t){return ln(ct(t),t)}),Zt({global:!0,wrap:!0,forced:!at,sham:!at},{Symbol:Je});for(var bn=te(an),wn=0;bn.length>wn;)Ve(bn[wn++]);Zt({target:"Symbol",stat:!0,forced:!at},{for:function(t){return vt(nn,t+="")?nn[t]:nn[t]=Je(t)},keyFor:function(t){if(!fn(t))throw TypeError(t+" is not a symbol");for(var e in nn)if(nn[e]===t)return e},useSetter:function(){cn=!0},useSimple:function(){cn=!1}}),Zt({target:"Object",stat:!0,forced:!at,sham:!K},{create:function(t,e){return void 0===e?se(t):dn(se(t),e)},defineProperty:pn,defineProperties:dn,getOwnPropertyDescriptor:yn}),Zt({target:"Object",stat:!0,forced:!at},{getOwnPropertyNames:gn,getOwnPropertySymbols:vn}),$e&&Zt({target:"JSON",stat:!0,forced:!at||k(function(){var t=Je();return"[null]"!=Ze([t])||"{}"!=Ze({a:t})||"{}"!=Ze(Object(t))})},{stringify:function(t){for(var e,n,r=[t],i=1;arguments.length>i;)r.push(arguments[i++]);if(n=e=r[1],(U(e)||void 0!==t)&&!fn(t))return j(e)||(e=function(t,e){if("function"==typeof n&&(e=n.call(this,t,e)),!fn(e))return e}),r[1]=e,Ze.apply($e,r)}}),Je.prototype[tn]||tt(Je.prototype,tn,Je.prototype.valueOf),qe(Je,"Symbol"),Dt[Ge]=!0,Ve("asyncIterator");var Sn=$.f,En=Q.Symbol;if(K&&"function"==typeof En&&(!("description"in En.prototype)||void 0!==En().description)){var Tn={},In=function(){var t=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),e=this instanceof In?new En(t):void 0===t?En():En(t);return""===t&&(Tn[e]=!0),e};Kt(In,En);var Cn=In.prototype=En.prototype;Cn.constructor=In;var Dn=Cn.toString,An="Symbol(test)"==String(En("test")),Nn=/^Symbol\((.*)\)[^)]+$/;Sn(Cn,"description",{configurable:!0,get:function(){var t=U(this)?this.valueOf():this,e=Dn.call(t);if(vt(Tn,t))return"";var n=An?e.slice(7,-1):e.replace(Nn,"$1");return""===n?void 0:n}}),Zt({global:!0,forced:!0},{Symbol:In})}Ve("hasInstance"),Ve("isConcatSpreadable"),Ve("iterator"),Ve("match"),Ve("replace"),Ve("search"),Ve("species"),Ve("split"),Ve("toPrimitive"),Ve("toStringTag"),Ve("unscopables"),qe(Math,"Math",!0),qe(Q.JSON,"JSON",!0),Ve("dispose"),Ve("observable"),Ve("patternMatch");var kn,On,Rn,_n=!k(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),Mn=Ct("IE_PROTO"),Pn=Object.prototype,xn=_n?Object.getPrototypeOf:function(t){return t=x(t),vt(t,Mn)?t[Mn]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?Pn:null},Ln=ct("iterator"),qn=!1;[].keys&&("next"in(Rn=[].keys())?(On=xn(xn(Rn)))!==Object.prototype&&(kn=On):qn=!0),null==kn&&(kn={}),vt(kn,Ln)||tt(kn,Ln,function(){return this});var Fn={IteratorPrototype:kn,BUGGY_SAFARI_ITERATORS:qn},Bn=Fn.IteratorPrototype,Vn=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),e=n instanceof Array}catch(t){}return function(n,r){return function(t,e){if(Y(t),!U(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n,r),e?t.call(n,r):n.__proto__=r,n}}():void 0),Un=ct("iterator"),jn=Fn.IteratorPrototype,Qn=Fn.BUGGY_SAFARI_ITERATORS,Kn=function(){return this},Gn=function(t,e,n,r,i,o,a){!function(t,e,n){var r=e+" Iterator";t.prototype=se(Bn,{next:Z(1,n)}),qe(t,r,!1)}(n,e,r);var s,u,c,h=function(t){if(t===i&&m)return m;if(!Qn&&t in p)return p[t];switch(t){case"keys":case"values":case"entries":return function(){return new n(this,t)}}return function(){return new n(this)}},l=e+" Iterator",f=!1,p=t.prototype,d=p[Un]||p["@@iterator"]||i&&p[i],m=!Qn&&d||h(i),y="Array"==e&&p.entries||d;if(y&&(s=xn(y.call(new t)),jn!==Object.prototype&&s.next&&(xn(s)!==jn&&(Vn?Vn(s,jn):"function"!=typeof s[Un]&&tt(s,Un,Kn)),qe(s,l,!0))),"values"==i&&d&&"values"!==d.name&&(f=!0,m=function(){return d.call(this)}),p[Un]!==m&&tt(p,Un,m),i)if(u={values:h("values"),keys:o?m:h("keys"),entries:h("entries")},a)for(c in u)!Qn&&!f&&c in p||Mt(p,c,u[c]);else Zt({target:e,proto:!0,forced:Qn||f},u);return u},Wn=_t.set,zn=_t.getterFor("String Iterator");Gn(String,"String",function(t){Wn(this,{type:"String Iterator",string:String(t),index:0})},function(){var t,e,n,r,i,o,a,s=zn(this),u=s.string,c=s.index;return c>=u.length?{value:void 0,done:!0}:(e=c,!0,i=String(P(u)),o=F(e),a=i.length,t=o<0||o>=a?"":(n=i.charCodeAt(o))<55296||n>56319||o+1===a||(r=i.charCodeAt(o+1))<56320||r>57343?i.charAt(o):i.slice(o,o+2),s.index+=t.length,{value:t,done:!1})});var Hn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Yn=_t.set,Xn=_t.getterFor("Array Iterator"),Jn=Gn(Array,"Array",function(t,e){Yn(this,{type:"Array Iterator",target:yt(t),index:0,kind:e})},function(){var t=Xn(this),e=t.target,n=t.kind,r=t.index++;return!e||r>=e.length?(t.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:e[r],done:!1}:{value:[r,e[r]],done:!1}},"values");he("keys"),he("values"),he("entries");var $n=ct("iterator"),Zn=ct("toStringTag"),tr=Jn.values;for(var er in Hn){var nr=Q[er],rr=nr&&nr.prototype;if(rr){if(rr[$n]!==tr)try{tt(rr,$n,tr)}catch(Er){rr[$n]=tr}if(rr[Zn]||tt(rr,Zn,er),Hn[er])for(var ir in Jn)if(rr[ir]!==Jn[ir])try{tt(rr,ir,Jn[ir])}catch(Er){rr[ir]=Jn[ir]}}}Fe.f("iterator");var or=function(t,e){return(or=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function ar(t,e){function n(){this.constructor=t}or(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var sr=function(){return(sr=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function ur(t,e,n,r){return new(n||(n=Promise))(function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(a,s)}u((r=r.apply(t,e||[])).next())})}function cr(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function hr(t,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:return new Date(e.getTime());case Object:void 0===t&&(t={});break;case Array:t=[];break;default:return e}for(var n in e)e.hasOwnProperty(n)&&(t[n]=hr(t[n],e[n]));return t}function lr(t,e,n){t[e]=n}var fr="FirebaseError",pr=function(t){function e(n,r){var i=t.call(this,r)||this;return i.code=n,i.name=fr,Object.setPrototypeOf(i,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(i,dr.prototype.create),i}return ar(e,t),e}(Error),dr=function(){function t(t,e,n){this.service=t,this.serviceName=e,this.errors=n}return t.prototype.create=function(t,e){void 0===e&&(e={});for(var n=this.service+"/"+t,r=this.errors[t],i=r?function(t,e){return t.replace(mr,function(t,n){var r=e[n];return null!=r?r.toString():"<"+n+"?>"})}(r,e):"Error",o=new pr(n,this.serviceName+": "+i+" ("+n+")."),a=0,s=Object.keys(e);a<s.length;a++){var u=s[a];"_"!==u.slice(-1)&&(u in o&&console.warn('Overwriting FirebaseError base field "'+u+'" can cause unexpected behavior.'),o[u]=e[u])}return o},t}(),mr=/\{\$([^}]+)}/g;function yr(t,e){var n=new vr(t,e);return n.subscribe.bind(n)}var gr,vr=function(){function t(t,e){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=e,this.task.then(function(){t(n)}).catch(function(t){n.error(t)})}return t.prototype.next=function(t){this.forEachObserver(function(e){e.next(t)})},t.prototype.error=function(t){this.forEachObserver(function(e){e.error(t)}),this.close(t)},t.prototype.complete=function(){this.forEachObserver(function(t){t.complete()}),this.close()},t.prototype.subscribe=function(t,e,n){var r,i=this;if(void 0===t&&void 0===e&&void 0===n)throw new Error("Missing Observer.");void 0===(r=function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=0,r=["next","error","complete"];n<r.length;n++){var i=r[n];if(i in t&&"function"==typeof t[i])return!0}return!1}(t)?t:{next:t,error:e,complete:n}).next&&(r.next=br),void 0===r.error&&(r.error=br),void 0===r.complete&&(r.complete=br);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{i.finalError?r.error(i.finalError):r.complete()}catch(t){}}),this.observers.push(r),o},t.prototype.unsubscribeOne=function(t){void 0!==this.observers&&void 0!==this.observers[t]&&(delete this.observers[t],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},t.prototype.forEachObserver=function(t){if(!this.finalized)for(var e=0;e<this.observers.length;e++)this.sendOne(e,t)},t.prototype.sendOne=function(t,e){var n=this;this.task.then(function(){if(void 0!==n.observers&&void 0!==n.observers[t])try{e(n.observers[t])}catch(t){"undefined"!=typeof console&&console.error&&console.error(t)}})},t.prototype.close=function(t){var e=this;this.finalized||(this.finalized=!0,void 0!==t&&(this.finalError=t),this.task.then(function(){e.observers=void 0,e.onNoObservers=void 0}))},t}();function br(){}var wr=((gr={})["no-app"]="No Firebase App '{$name}' has been created - call Firebase App.initializeApp()",gr["bad-app-name"]="Illegal App name: '{$name}",gr["duplicate-app"]="Firebase App named '{$name}' already exists",gr["app-deleted"]="Firebase App named '{$name}' already deleted",gr["duplicate-service"]="Firebase service named '{$name}' already registered",gr["invalid-app-argument"]="firebase.{$name}() takes either no argument or a Firebase App instance.",gr),Sr=new dr("app","Firebase",wr);function Er(t,e){throw Sr.create(t,e)}var Tr="[DEFAULT]",Ir=[],Cr=function(){function t(t,e,n){this.firebase_=n,this.isDeleted_=!1,this.services_={},this.name_=e.name,this.automaticDataCollectionEnabled_=e.automaticDataCollectionEnabled||!1,this.options_=hr(void 0,t),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(t){Ir.push(t),setTimeout(function(){return t(null)},0)},removeAuthTokenListener:function(t){Ir=Ir.filter(function(e){return e!==t})}}}return Object.defineProperty(t.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(t){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),t.prototype.delete=function(){var t=this;return new Promise(function(e){t.checkDestroyed_(),e()}).then(function(){t.firebase_.INTERNAL.removeApp(t.name_);for(var e=[],n=0,r=Object.keys(t.services_);n<r.length;n++)for(var i=r[n],o=0,a=Object.keys(t.services_[i]);o<a.length;o++)e.push(t.services_[i][a[o]]);return Promise.all(e.map(function(t){return t.INTERNAL.delete()}))}).then(function(){t.isDeleted_=!0,t.services_={}})},t.prototype._getService=function(t,e){if(void 0===e&&(e=Tr),this.checkDestroyed_(),this.services_[t]||(this.services_[t]={}),!this.services_[t][e]){var n=e!==Tr?e:void 0,r=this.firebase_.INTERNAL.factories[t](this,this.extendApp.bind(this),n);this.services_[t][e]=r}return this.services_[t][e]},t.prototype.extendApp=function(t){var e=this;hr(this,t),t.INTERNAL&&t.INTERNAL.addAuthTokenListener&&(Ir.forEach(function(t){e.INTERNAL.addAuthTokenListener(t)}),Ir=[])},t.prototype.checkDestroyed_=function(){this.isDeleted_&&Er("app-deleted",{name:this.name_})},t}();function Dr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}Cr.prototype.name&&Cr.prototype.options||Cr.prototype.delete||console.log("dc");var Ar=!1;try{Ar="[object process]"===Object.prototype.toString.call(global.process)}catch(t){}if(Ar&&console.warn('\nWarning: This is a browser-targeted Firebase bundle but it appears it is being\nrun in a Node environment.  If running in a Node environment, make sure you\nare using the bundle specified by the "main" field in package.json.\n\nIf you are using Webpack, you can specify "main" as the first item in\n"resolve.mainFields":\nhttps://webpack.js.org/configuration/resolve/#resolvemainfields\n\nIf using Rollup, use the rollup-plugin-node-resolve plugin and set "module"\nto false and "main" to true:\nhttps://github.com/rollup/rollup-plugin-node-resolve\n'),self&&"firebase"in self){console.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var Nr=self.firebase.SDK_VERSION;Nr&&Nr.indexOf("LITE")>=0&&console.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var kr,Or=function t(){var e=function(t){var e={},n={},r={},i={__esModule:!0,initializeApp:function(n,r){(void 0===r&&(r={}),"object"!=typeof r||null===r)&&(r={name:r});var o=r;void 0===o.name&&(o.name=Tr);var a=o.name;"string"==typeof a&&a||Er("bad-app-name",{name:String(a)}),Dr(e,a)&&Er("duplicate-app",{name:a});var u=new t(n,o,i);return e[a]=u,s(u,"create"),u},app:o,apps:null,Promise:Promise,SDK_VERSION:"5.11.0",INTERNAL:{registerService:function(e,s,u,c,h){function l(t){return void 0===t&&(t=o()),"function"!=typeof t[e]&&Er("invalid-app-argument",{name:e}),t[e]()}return void 0===h&&(h=!1),n[e]&&Er("duplicate-service",{name:e}),n[e]=s,c&&(r[e]=c,a().forEach(function(t){c("create",t)})),void 0!==u&&hr(l,u),i[e]=l,t.prototype[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._getService.bind(this,e).apply(this,h?t:[])},l},removeApp:function(t){s(e[t],"delete"),delete e[t]},factories:n,useAsService:u}};function o(t){return Dr(e,t=t||Tr)||Er("no-app",{name:t}),e[t]}function a(){return Object.keys(e).map(function(t){return e[t]})}function s(t,e){for(var i=0,o=Object.keys(n);i<o.length;i++){var a=u(0,o[i]);if(null===a)return;r[a]&&r[a](e,t)}}function u(t,e){return"serverAuth"===e?null:e}return lr(i,"default",i),Object.defineProperty(i,"apps",{get:a}),lr(o,"App",t),i}(Cr);return e.INTERNAL=sr({},e.INTERNAL,{createFirebaseNamespace:t,extendNamespace:function(t){hr(e,t)},createSubscribe:yr,ErrorFactory:dr,deepExtend:hr}),e}();!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(kr||(kr={}));var Rr,_r=kr.INFO,Mr=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case kr.DEBUG:case kr.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case kr.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case kr.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case kr.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}},Pr=function(){function t(t){this.name=t,this._logLevel=_r,this._logHandler=Mr}return Object.defineProperty(t.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in kr))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,kr.DEBUG].concat(t))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,kr.VERBOSE].concat(t))},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,kr.INFO].concat(t))},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,kr.WARN].concat(t))},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,kr.ERROR].concat(t))},t}(),xr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Lr=Lr||{},qr=xr;function Fr(t){return"string"==typeof t}function Br(t){return"number"==typeof t}function Vr(t,e){t=t.split("."),e=e||qr;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function Ur(){}function jr(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function Qr(t){return"array"==jr(t)}function Kr(t){var e=jr(t);return"array"==e||"object"==e&&"number"==typeof t.length}function Gr(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var Wr="closure_uid_"+(1e9*Math.random()>>>0),zr=0;function Hr(t,e,n){return t.call.apply(t.bind,arguments)}function Yr(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function Xr(t,e,n){return(Xr=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Hr:Yr).apply(null,arguments)}function Jr(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}var $r=Date.now||function(){return+new Date};function Zr(t,e){function n(){}n.prototype=e.prototype,t.N=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.yb=function(t,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return e.prototype[n].apply(t,i)}}function ti(){this.j=this.j,this.i=this.i}ti.prototype.j=!1,ti.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[Wr]||(this[Wr]=++zr))},ti.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var ei=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(Fr(t))return Fr(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},ni=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=Fr(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function ri(t){return Array.prototype.concat.apply([],arguments)}function ii(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function oi(t){return/^[\s\xa0]*$/.test(t)}var ai,si=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function ui(t,e){return-1!=t.indexOf(e)}function ci(t,e){return t<e?-1:t>e?1:0}t:{var hi=qr.navigator;if(hi){var li=hi.userAgent;if(li){ai=li;break t}}ai=""}function fi(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function pi(t){var e,n={};for(e in t)n[e]=t[e];return n}var di="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function mi(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<di.length;o++)n=di[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function yi(t){return yi[" "](t),t}yi[" "]=Ur;var gi,vi,bi=ui(ai,"Opera"),wi=ui(ai,"Trident")||ui(ai,"MSIE"),Si=ui(ai,"Edge"),Ei=Si||wi,Ti=ui(ai,"Gecko")&&!(ui(ai.toLowerCase(),"webkit")&&!ui(ai,"Edge"))&&!(ui(ai,"Trident")||ui(ai,"MSIE"))&&!ui(ai,"Edge"),Ii=ui(ai.toLowerCase(),"webkit")&&!ui(ai,"Edge");function Ci(){var t=qr.document;return t?t.documentMode:void 0}t:{var Di="",Ai=(vi=ai,Ti?/rv:([^\);]+)(\)|;)/.exec(vi):Si?/Edge\/([\d\.]+)/.exec(vi):wi?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(vi):Ii?/WebKit\/(\S+)/.exec(vi):bi?/(?:Version)[ \/]?(\S+)/.exec(vi):void 0);if(Ai&&(Di=Ai?Ai[1]:""),wi){var Ni=Ci();if(null!=Ni&&Ni>parseFloat(Di)){gi=String(Ni);break t}}gi=Di}var ki,Oi={};function Ri(t){return function(t,e){var n=Oi;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e()}(t,function(){for(var e=0,n=si(String(gi)).split("."),r=si(String(t)).split("."),i=Math.max(n.length,r.length),o=0;0==e&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;e=ci(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||ci(0==a[2].length,0==s[2].length)||ci(a[2],s[2]),a=a[3],s=s[3]}while(0==e)}return 0<=e})}var _i=qr.document;ki=_i&&wi?Ci()||("CSS1Compat"==_i.compatMode?parseInt(gi,10):5):void 0;var Mi=!wi||9<=Number(ki),Pi=wi&&!Ri("9"),xi=function(){if(!qr.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{qr.addEventListener("test",Ur,e),qr.removeEventListener("test",Ur,e)}catch(t){}return t}();function Li(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function qi(t,e){if(Li.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(Ti){t:{try{yi(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=Fr(t.pointerType)?t.pointerType:Fi[t.pointerType]||"",this.c=t,t.defaultPrevented&&this.b()}}Li.prototype.b=function(){this.Ja=!1},Zr(qi,Li);var Fi={2:"touch",3:"pen",4:"mouse"};qi.prototype.b=function(){qi.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,Pi)try{(t.ctrlKey||112<=t.keyCode&&123>=t.keyCode)&&(t.keyCode=-1)}catch(t){}};var Bi="closure_listenable_"+(1e6*Math.random()|0),Vi=0;function Ui(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++Vi,this.X=this.Z=!1}function ji(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Qi(t){this.src=t,this.a={},this.b=0}function Ki(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=ei(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(ji(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function Gi(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Qi.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=Gi(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new Ui(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var Wi="closure_lm_"+(1e6*Math.random()|0),zi={};function Hi(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(Qr(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}return r=no(r),e&&e[Bi]?e.Ba(n,r,Gr(i)?!!i.capture:!!i,o):Yi(e,n,r,!0,i,o)}(t,e,n,r,i);if(Qr(e)){for(var o=0;o<e.length;o++)Hi(t,e[o],n,r,i);return null}return n=no(n),t&&t[Bi]?t.Aa(e,n,Gr(r)?!!r.capture:!!r,i):Yi(t,e,n,!1,r,i)}function Yi(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=Gr(i)?!!i.capture:!!i;if(a&&!Mi)return null;var s=to(t);if(s||(t[Wi]=s=new Qi(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var t=Zi,e=Mi?function(n){return t.call(e.src,e.listener,n)}:function(n){if(!(n=t.call(e.src,e.listener,n)))return n};return e}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)xi||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Ji(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function Xi(t){if(!Br(t)&&t&&!t.X){var e=t.src;if(e&&e[Bi])Ki(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Ji(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=to(e))?(Ki(n,t),0==n.b&&(n.src=null,e[Wi]=null)):ji(t)}}}function Ji(t){return t in zi?zi[t]:zi[t]="on"+t}function $i(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&Xi(t),n.call(r,e)}function Zi(t,e){return!!t.X||$i(t,Mi?new qi(e,this):e=new qi(e||Vr("window.event"),this))}function to(t){return(t=t[Wi])instanceof Qi?t:null}var eo="__closure_events_fn_"+(1e9*Math.random()>>>0);function no(t){return"function"==jr(t)?t:(t[eo]||(t[eo]=function(e){return t.handleEvent(e)}),t[eo])}function ro(){ti.call(this),this.c=new Qi(this),this.J=this,this.B=null}function io(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&Ki(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}Zr(ro,ti),ro.prototype[Bi]=!0,(Rr=ro.prototype).addEventListener=function(t,e,n,r){Hi(this,t,e,n,r)},Rr.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(Qr(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=Gr(i)?!!i.capture:!!i,r=no(r),e&&e[Bi]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=Gi(a=e.a[n],r,i,o))&&(ji(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):e&&(e=to(e))&&(n=e.a[n.toString()],e=-1,n&&(e=Gi(n,r,i,o)),(r=-1<e?n[e]:null)&&Xi(r))}(this,t,e,n,r)},Rr.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(Fr(t))t=new Li(t,n);else if(t instanceof Li)t.target=t.target||n;else{var i=t;mi(t=new Li(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=io(a,r,!0,t)&&i}if(i=io(a=t.a=n,r,!0,t)&&i,i=io(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=io(a=t.a=e[o],r,!1,t)&&i;return i},Rr.G=function(){if(ro.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)ji(n[r]);delete e.a[t],e.b--}}this.B=null},Rr.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},Rr.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var oo=qr.JSON.stringify;function ao(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function so(){this.b=this.a=null}ao.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var uo,co=new ao(function(){return new lo},function(t){t.reset()});function ho(){var t=yo,e=null;return t.a&&(e=t.a,t.a=t.a.next,t.a||(t.b=null),e.next=null),e}function lo(){this.next=this.b=this.a=null}function fo(t){qr.setTimeout(function(){throw t},0)}function po(t,e){uo||function(){var t=qr.Promise.resolve(void 0);uo=function(){t.then(go)}}(),mo||(uo(),mo=!0),yo.add(t,e)}so.prototype.add=function(t,e){var n=co.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},lo.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null},lo.prototype.reset=function(){this.next=this.b=this.a=null};var mo=!1,yo=new so;function go(){for(var t;t=ho();){try{t.a.call(t.b)}catch(t){fo(t)}var e=co;e.f(t),100>e.b&&(e.b++,t.next=e.a,e.a=t)}mo=!1}function vo(t,e){ro.call(this),this.b=t||1,this.a=e||qr,this.f=Xr(this.gb,this),this.g=$r()}function bo(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function wo(t,e,n){if("function"==jr(t))n&&(t=Xr(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=Xr(t.handleEvent,t)}return 2147483647<Number(e)?-1:qr.setTimeout(t,e||0)}function So(t,e,n){ti.call(this),this.f=null!=n?Xr(t,n):t,this.c=e,this.b=Xr(this.ab,this),this.a=[]}function Eo(t){t.U=wo(t.b,t.c),t.f.apply(null,t.a)}function To(t){ti.call(this),this.b=t,this.a={}}Zr(vo,ro),(Rr=vo.prototype).ba=!1,Rr.L=null,Rr.gb=function(){if(this.ba){var t=$r()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(bo(this),this.start()))}},Rr.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=$r())},Rr.G=function(){vo.N.G.call(this),bo(this),delete this.a},Zr(So,ti),(Rr=So.prototype).ea=!1,Rr.U=null,Rr.Ua=function(t){this.a=arguments,this.U?this.ea=!0:Eo(this)},Rr.G=function(){So.N.G.call(this),this.U&&(qr.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},Rr.ab=function(){this.U=null,this.ea&&(this.ea=!1,Eo(this))},Zr(To,ti);var Io=[];function Co(t,e,n,r){Qr(n)||(n&&(Io[0]=n.toString()),n=Io);for(var i=0;i<n.length;i++){var o=Hi(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function Do(t){fi(t.a,function(t,e){this.a.hasOwnProperty(e)&&Xi(t)},t),t.a={}}function Ao(){}To.prototype.G=function(){To.N.G.call(this),Do(this)},To.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var No=new ro;function ko(t){Li.call(this,"serverreachability",t)}function Oo(t){No.dispatchEvent(new ko(No,t))}function Ro(t){Li.call(this,"statevent",t)}function _o(t){No.dispatchEvent(new Ro(No,t))}function Mo(t){Li.call(this,"timingevent",t)}function Po(t,e){if("function"!=jr(t))throw Error("Fn must not be null and must be a function");return qr.setTimeout(function(){t()},e)}Zr(ko,Li),Zr(Ro,Li),Zr(Mo,Li);var xo={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},Lo={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function qo(){}function Fo(){}qo.prototype.a=null;var Bo,Vo={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Uo(){Li.call(this,"d")}function jo(){Li.call(this,"c")}function Qo(){}function Ko(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new To(this),this.O=Go,this.P=new vo(t=Ei?125:void 0),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}Zr(Uo,Li),Zr(jo,Li),Zr(Qo,qo),Bo=new Qo;var Go=45e3,Wo={},zo={};function Ho(t,e,n){t.F=1,t.f=ba(fa(e)),t.l=n,t.H=!0,Xo(t,null)}function Yo(t,e,n,r){t.F=1,t.f=ba(fa(e)),t.l=null,t.H=n,Xo(t,r)}function Xo(t,e){t.v=$r(),Zo(t),t.D=fa(t.f),va(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new So(Xr(t.Ka,t,t.a),t.J)),Co(t.I,t.a,"readystatechange",t.eb),e=t.h?pi(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),Oo(1)}function Jo(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=$o(t,n);if(i==zo){4==e&&(t.c=4,_o(14),r=!1);break}if(i==Wo){t.c=4,_o(15),r=!1;break}ia(t,i)}4==e&&0==n.length&&(t.c=1,_o(16),r=!1),t.b=t.b&&r,r||(ra(t),na(t))}function $o(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?zo:(n=Number(e.substring(n,r)),isNaN(n)?Wo:(r+=1)+n>e.length?zo:(e=e.substr(r,n),t.A=r+n,e))}function Zo(t){t.R=$r()+t.O,ta(t,t.O)}function ta(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=Po(Xr(t.bb,t),e)}function ea(t){t.i&&(qr.clearTimeout(t.i),t.i=null)}function na(t){t.g.Da()||t.m||t.g.na(t)}function ra(t){ea(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,bo(t.P),Do(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function ia(t,e){try{t.g.Ga(t,e),Oo(4)}catch(t){}}function oa(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(Kr(t)||Fr(t))ni(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(Kr(t)||Fr(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(Fr(t))return t.split("");if(Kr(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function aa(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof aa)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function sa(t,e){ca(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&ua(t))}function ua(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];ca(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)ca(i,r=t.a[e])||(t.a[n++]=r,i[r]=1),e++;t.a.length=n}}function ca(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(Rr=Ko.prototype).setTimeout=function(t){this.O=t},Rr.eb=function(t){t=t.target;var e=this.B;e&&3==ls(t)?e.Ua():this.Ka(t)},Rr.Ka=function(t){try{if(t==this.a)t:{var e=ls(this.a),n=this.a.ya(),r=this.a.T();if(!(3>e||3==e&&!Ei&&!this.a.aa())){this.m||4!=e||7==n||Oo(8==n||0>=r?3:2),ea(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=fs(this.a,"X-HTTP-Initial-Response");if(a&&!oi(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,_o(12),ra(this),na(this);break t}this.s=!0,ia(this,s)}this.H?(Jo(this,e,o),Ei&&this.b&&3==e&&(Co(this.I,this.P,"tick",this.cb),this.P.start())):ia(this,o),4==e&&ra(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,Zo(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,_o(12)):(this.c=0,_o(13)),ra(this),na(this)}}}catch(t){}},Rr.cb=function(){if(this.a){var t=ls(this.a),e=this.a.aa();this.A<e.length&&(ea(this),Jo(this,t,e),this.b&&4!=t&&Zo(this))}},Rr.cancel=function(){this.m=!0,ra(this)},Rr.bb=function(){this.i=null;var t=$r();0<=t-this.R?(2!=this.F&&(Oo(3),_o(17)),ra(this),this.c=2,na(this)):ta(this,this.R-t)},(Rr=aa.prototype).C=function(){ua(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},Rr.K=function(){return ua(this),this.a.concat()},Rr.get=function(t,e){return ca(this.b,t)?this.b[t]:e},Rr.set=function(t,e){ca(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},Rr.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var ha=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\/?#]*)@)?([^\/#?]*?)(?::([0-9]+))?(?=[\/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function la(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof la?(this.h=void 0!==e?e:t.h,pa(this,t.f),this.j=t.j,da(this,t.b),ma(this,t.i),this.a=t.a,ya(this,Ma(t.c)),this.g=t.g):t&&(n=String(t).match(ha))?(this.h=!!e,pa(this,n[1]||"",!0),this.j=wa(n[2]||""),da(this,n[3]||"",!0),ma(this,n[4]),this.a=wa(n[5]||"",!0),ya(this,n[6]||"",!0),this.g=wa(n[7]||"")):(this.h=!!e,this.c=new Na(null,this.h))}function fa(t){return new la(t)}function pa(t,e,n){t.f=n?wa(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function da(t,e,n){t.b=n?wa(e,!0):e}function ma(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.i=e}else t.i=null}function ya(t,e,n){e instanceof Na?(t.c=e,function(t,e){e&&!t.f&&(ka(t),t.c=null,t.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(Oa(this,e),_a(this,n,t))},t)),t.f=e}(t.c,t.h)):(n||(e=Sa(e,Da)),t.c=new Na(e,t.h))}function ga(t,e,n){t.c.set(e,n)}function va(t,e,n){Qr(n)||(n=[String(n)]),_a(t.c,e,n)}function ba(t){return ga(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^$r()).toString(36)),t}function wa(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Sa(t,e,n){return Fr(t)?(t=encodeURI(t).replace(e,Ea),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Ea(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}la.prototype.toString=function(){var t=[],e=this.f;e&&t.push(Sa(e,Ta,!0),":");var n=this.b;return(n||"file"==e)&&(t.push("//"),(e=this.j)&&t.push(Sa(e,Ta,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(Sa(n,"/"==n.charAt(0)?Ca:Ia,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",Sa(n,Aa)),t.join("")},la.prototype.resolve=function(t){var e=fa(this),n=!!t.f;n?pa(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?da(e,t.b):n=null!=t.i;var r=t.a;if(n)ma(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(ui(i,"./")||ui(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?ya(e,Ma(t.c)):n=!!t.g,n&&(e.g=t.g),e};var Ta=/[#\/\?@]/g,Ia=/[#\?:]/g,Ca=/[#\?]/g,Da=/[#\?@]/g,Aa=/#/g;function Na(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function ka(t){t.a||(t.a=new aa,t.b=0,t.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(t.c,function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)}))}function Oa(t,e){ka(t),e=Pa(t,e),ca(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,sa(t.a,e))}function Ra(t,e){return ka(t),e=Pa(t,e),ca(t.a.b,e)}function _a(t,e,n){Oa(t,e),0<n.length&&(t.c=null,t.a.set(Pa(t,e),ii(n)),t.b+=n.length)}function Ma(t){var e=new Na;return e.c=t.c,t.a&&(e.a=new aa(t.a),e.b=t.b),e}function Pa(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function xa(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function La(t){var e=t.a.F.a;if(null!=e)_o(4),e?(_o(10),Is(t.a,t,!1)):(_o(11),Is(t.a,t,!0));else{t.b=new Ko(t,void 0,void 0),t.b.h=t.h,e=ks(e=t.a,e.Y()?t.f:null,t.i),_o(4),va(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&ga(e,n,r),Yo(t.b,e,!1,t.f)}}function qa(){this.a=this.b=null}function Fa(){this.a=new aa}function Ba(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[Wr]||(t[Wr]=++zr)):e.charAt(0)+t}function Va(t,e){this.b=t,this.a=e}function Ua(t){this.g=t||ja,t=qr.PerformanceNavigationTiming?0<(t=qr.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(qr.ka&&qr.ka.Ea&&qr.ka.Ea()&&qr.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Fa),this.b=null,this.c=[]}(Rr=Na.prototype).add=function(t,e){ka(this),this.c=null,t=Pa(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},Rr.forEach=function(t,e){ka(this),this.a.forEach(function(n,r){ni(n,function(n){t.call(e,n,r,this)},this)},this)},Rr.K=function(){ka(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},Rr.C=function(t){ka(this);var e=[];if(Fr(t))Ra(this,t)&&(e=ri(e,this.a.get(Pa(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=ri(e,t[n])}return e},Rr.set=function(t,e){return ka(this),this.c=null,Ra(this,t=Pa(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},Rr.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},Rr.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},Zr(function(){},function(){}),(Rr=xa.prototype).M=null,Rr.$=function(t){return this.a.$(t)},Rr.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},Rr.Da=function(){return!1},Rr.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=fs(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=fs(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void As(e,2)}this.f=r[0]}else(e=this.a).m=this.c,As(e,2)}else 1==this.M&&(this.g?_o(6):"11111"==e?(_o(5),this.g=!0,(!wi||10<=Number(ki))&&(this.c=200,this.b.cancel(),_o(11),Is(this.a,this,!0))):(_o(7),this.g=!1))},Rr.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,La(this)):1==this.M&&(this.g?(_o(11),Is(this.a,this,!0)):(_o(10),Is(this.a,this,!1)));else{0==this.M?_o(8):1==this.M&&_o(9);var t=this.a;t.m=this.c,As(t,2)}},Rr.Y=function(){return this.a.Y()},Rr.ma=function(){return this.a.ma()},Fa.prototype.add=function(t){this.a.set(Ba(t),t)},Fa.prototype.C=function(){return this.a.C()};var ja=10;function Qa(t,e){!t.a&&(ui(e,"spdy")||ui(e,"quic")||ui(e,"h2"))&&(t.f=t.g,t.a=new Fa,t.b&&(za(t,t.b),t.b=null))}function Ka(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function Ga(t){return t.b?1:t.a?t.a.a.c:0}function Wa(t,e){return t.b?t=t.b==e:t.a?(e=Ba(e),t=ca(t.a.a.b,e)):t=!1,t}function za(t,e){t.a?t.a.add(e):t.b=e}function Ha(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=Ba(e),n=ca(t.a.a.b,n)),n&&sa(t.a.a,Ba(e)))}function Ya(t){if(null!=t.b)return t.c.concat(t.b.j);if(null!=t.a&&0!=t.a.a.c){var e=t.c;return ni(t.a.C(),function(t){e=e.concat(t.j)}),e}return ii(t.c)}function Xa(){}function Ja(){this.a=new Xa}function $a(t,e,n){var r=n||"";try{oa(t,function(t,n){var i=t;Gr(t)&&(i=oo(t)),e.push(r+n+"="+encodeURIComponent(i))})}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function Za(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}Ua.prototype.cancel=function(){var t;this.c=Ya(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(ni(this.a.C(),function(t){t.cancel()}),(t=this.a.a).b={},t.a.length=0,t.c=0)},Xa.prototype.stringify=function(t){return qr.JSON.stringify(t,void 0)},Xa.prototype.parse=function(t){return qr.JSON.parse(t,void 0)};var ts=qr.JSON.parse;function es(t){ro.call(this),this.headers=new aa,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=ns,this.D=this.F=!1}Zr(es,ro);var ns="",rs=/^https?$/i,is=["POST","PUT"];function os(t){return"content-type"==t.toLowerCase()}function as(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,ss(t),cs(t)}function ss(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function us(t){if(t.b&&void 0!==Lr&&(!t.s[1]||4!=ls(t)||2!=t.T()))if(t.l&&4==ls(t))wo(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==ls(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(ha)[1]||null;if(!o&&qr.self&&qr.self.location){var a=qr.self.location.protocol;o=a.substr(0,a.length-1)}i=!rs.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",ss(t))}finally{cs(t)}}}function cs(t,e){if(t.a){hs(t);var n=t.a,r=t.s[0]?Ur:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function hs(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(qr.clearTimeout(t.m),t.m=null)}function ls(t){return t.a?t.a.readyState:0}function fs(t,e){return t.a?t.a.getResponseHeader(e):null}function ps(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var e="";return fi(n,function(t,n){e+=n,e+=":",e+=t,e+="\r\n"}),e}(),Fr(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if(0>(n=t.indexOf("#"))&&(n=t.length),0>(r=t.indexOf("?"))||r>n){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return ga(t,e,n),t}function ds(t){this.f=[],this.F=new qa,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!Vr("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=Vr("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=Vr("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=Vr("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=Vr("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Ua(t&&t.concurrentRequestLimit),this.ja=new Ja,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function ms(t){if(ys(t),3==t.u){var e=t.P++,n=fa(t.B);ga(n,"SID",t.H),ga(n,"RID",e),ga(n,"TYPE","terminate"),ws(t,n),(e=new Ko(t,e,void 0)).F=2,e.f=ba(fa(n)),n=!1,qr.navigator&&qr.navigator.sendBeacon&&(n=qr.navigator.sendBeacon(e.f.toString(),"")),!n&&qr.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=$r(),Zo(e)}Ns(t)}function ys(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(qr.clearTimeout(t.l),t.l=null),Cs(t),t.b.cancel(),t.h&&(Br(t.h)&&qr.clearTimeout(t.h),t.h=null)}function gs(t,e){t.f.push(new Va(t.Ra++,e)),3==t.u&&vs(t)}function vs(t){Ka(t.b)||t.h||(t.h=!0,po(t.Ia,t),t.A=0)}function bs(t,e){var n;n=e?e.W:t.P++;var r=fa(t.B);ga(r,"SID",t.H),ga(r,"RID",n),ga(r,"AID",t.O),ws(t,r),t.g&&t.i&&ps(r,t.g,t.i),n=new Ko(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=Ss(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),za(t.b,n),Ho(n,r,e)}function ws(t,e){t.c&&oa({},function(t,n){ga(e,n,t)})}function Ss(t,e,n){n=Math.min(t.f.length,n);var r=t.c?Xr(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?a.push("ofs="+(o=i[0].b)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if(0>(c-=o))o=Math.max(0,i[u].b-100),s=!1;else try{$a(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function Es(t){t.a||t.l||(t.S=1,po(t.Ha,t),t.v=0)}function Ts(t){return!(t.a||t.l||3<=t.v||(t.S++,t.l=Po(Xr(t.Ha,t),Ds(t,t.v)),t.v++,0))}function Is(t,e,n){var r=e.l;r&&Qa(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=ks(t,null,t.ha),vs(t)}function Cs(t){null!=t.s&&(qr.clearTimeout(t.s),t.s=null)}function Ds(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function As(t,e){if(2==e){var n=null;t.c&&(n=null);var r=Xr(t.fb,t);n||(n=new la("//www.google.com/images/cleardot.gif"),qr.location&&"http"==qr.location.protocol||pa(n,"https"),ba(n)),function(t,e){var n=new Ao;if(qr.Image){var r=new Image;r.onload=Jr(Za,n,r,"TestLoadImage: loaded",!0,e),r.onerror=Jr(Za,n,r,"TestLoadImage: error",!1,e),r.onabort=Jr(Za,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=Jr(Za,n,r,"TestLoadImage: timeout",!1,e),qr.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)}else _o(2);t.u=0,t.c&&t.c.ta(e),Ns(t),ys(t)}function Ns(t){t.u=0,t.m=-1,t.c&&(0==Ya(t.b).length&&0==t.f.length||(t.b.c.length=0,ii(t.f),t.f.length=0),t.c.sa())}function ks(t,e,n){var r=function(t){return t instanceof la?fa(t):new la(t,void 0)}(n);if(""!=r.b)e&&da(r,e+"."+r.b),ma(r,r.i);else{var i=qr.location;r=function(t,e,n,r){var i=new la(null,void 0);return t&&pa(i,t),e&&da(i,e),n&&ma(i,n),r&&(i.a=r),i}(i.protocol,e?e+"."+i.hostname:i.hostname,+i.port,n)}return t.V&&fi(t.V,function(t,e){ga(r,e,t)}),n=t.I,(e=t.j)&&n&&ga(r,e,n),ga(r,"VER",t.wa),ws(t,r),r}function Os(){}function Rs(){if(wi&&!(10<=Number(ki)))throw Error("Environmental error: no available transport.")}function _s(t,e){ro.call(this),this.a=new ds(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=arguments[0],n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!oi(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!oi(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&e in(t=this.b)&&delete t[e]),this.f=new xs(this)}function Ms(t){Uo.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function Ps(){jo.call(this),this.status=1}function xs(t){this.a=t}(Rr=es.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=function(t){var e;return(e=t.a)||(e=t.a={}),e}(this.H?this.H:Bo),this.a.onreadystatechange=Xr(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void as(this,t)}t=n||"";var i=new aa(this.headers);r&&oa(r,function(t,e){i.set(e,t)}),r=function(t){t:{for(var e=os,n=t.length,r=Fr(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return 0>e?null:Fr(t)?t.charAt(e):t[e]}(i.K()),n=qr.FormData&&t instanceof qr.FormData,!(0<=ei(is,e))||r||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{hs(this),0<this.o&&((this.D=function(t){return wi&&Ri(9)&&Br(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=Xr(this.Ca,this)):this.m=wo(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){as(this,t)}},Rr.Ca=function(){void 0!==Lr&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},Rr.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),cs(this))},Rr.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),cs(this,!0)),es.N.G.call(this)},Rr.Fa=function(){this.j||(this.w||this.l||this.g?us(this):this.$a())},Rr.$a=function(){us(this)},Rr.T=function(){try{return 2<ls(this)?this.a.status:-1}catch(t){return-1}},Rr.za=function(){try{return 2<ls(this)?this.a.statusText:""}catch(t){return""}},Rr.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},Rr.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),ts(e)}},Rr.ya=function(){return this.h},Rr.Ya=function(){return Fr(this.f)?this.f:String(this.f)},(Rr=ds.prototype).wa=8,Rr.u=1,Rr.Da=function(){return 0==this.u},Rr.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var e,n=new Ko(this,t=this.P++,void 0),r=this.i;if(this.J&&(r?mi(r=pi(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&Fr(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=Ss(this,n,e),ga(i=fa(this.B),"RID",t),ga(i,"CVER",22),this.o&&this.j&&ga(i,"X-HTTP-Session-Id",this.j),ws(this,i),this.g&&r&&ps(i,this.g,r),za(this.b,n),this.W?(ga(i,"$req",e),ga(i,"SID","null"),n.S=!0,Ho(n,i,null)):Ho(n,i,e),this.u=2}}else 3==this.u&&(t?bs(this,t):0==this.f.length||Ka(this.b)||bs(this))},Rr.Ha=function(){this.l=null,this.a=new Ko(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=fa(this.pa);ga(t,"RID","rpc"),ga(t,"SID",this.H),ga(t,"CI",this.ia?"0":"1"),ga(t,"AID",this.O),ws(this,t),ga(t,"TYPE","xmlhttp"),this.g&&this.i&&ps(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),Yo(this.a,t,!0,this.ga)},Rr.Ga=function(t,e){if(0!=this.u&&(this.a==t||Wa(this.b,t)))if(this.m=t.o,!t.s&&Wa(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(Qr(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;Cs(this),this.a.cancel(),this.a=null}Ts(this),_o(18)}}else this.ra=e[1],0<this.ra-this.O&&37500>e[2]&&this.ia&&0==this.v&&!this.s&&(this.s=Po(Xr(this.Za,this),6e3));if(1>=Ga(this.b)&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else As(this,11)}else if((t.s||this.a==t)&&Cs(this),!oi(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&Br(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=fs(r,"X-Client-Wire-Protocol"))&&Qa(this.b,i),this.j&&(r=fs(r,"X-HTTP-Session-Id")))&&(this.I=r,ga(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=ks(this,this.Y()?this.ga:null,this.ha),r.s?(Ha(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(ea(r),Zo(r)),this.a=r):Es(this),0<this.f.length&&vs(this)}else"stop"!=r[0]&&"close"!=r[0]||As(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?As(this,7):ms(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},Rr.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,Ts(this),_o(19))},Rr.na=function(t){var e=null;if(this.a==t){Cs(this),this.a=null;var n=2}else{if(!Wa(this.b,t))return;e=t.j,Ha(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=$r()-t.v,No.dispatchEvent(new Mo(No,t.l?t.l.length:0,e,this.A)),vs(this)):Es(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(Ga(t.b)>=t.b.f-(t.h?1:0)||(t.h?(t.f=e.j.concat(t.f),0):1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa)||(t.h=Po(Xr(t.Ia,t,e),Ds(t,t.A)),t.A++,0)))}(this,t)||2==n&&Ts(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:As(this,5);break;case 4:As(this,10);break;case 3:As(this,6);break;default:As(this,2)}}},Rr.fb=function(t){_o(t?2:1)},Rr.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new es(this.La)).F=this.R,t},Rr.ma=function(){return!!this.c&&!0},Rr.Y=function(){return this.R},(Rr=Os.prototype).va=function(){},Rr.ua=function(){},Rr.ta=function(){},Rr.sa=function(){},Rr.Ta=function(){},Rs.prototype.a=function(t,e){return new _s(t,e)},Zr(_s,ro),(Rr=_s.prototype).addEventListener=function(t,e,n,r){_s.N.addEventListener.call(this,t,e,n,r)},Rr.removeEventListener=function(t,e,n,r){_s.N.removeEventListener.call(this,t,e,n,r)},Rr.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;_o(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new xa(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=ps(e,t.g,t.i)),(t=t.w).i=n,e=ks(t.a,null,t.i),_o(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,La(t)):(va(e,"MODE","init"),!t.a.o&&t.a.j&&va(e,"X-HTTP-Session-Id",t.a.j),t.b=new Ko(t,void 0,void 0),t.b.h=t.h,Yo(t.b,e,!1,null),t.M=0)},Rr.close=function(){ms(this.a)},Rr.Xa=function(t){if(Fr(t)){var e={};e.__data__=t,gs(this.a,e)}else this.h?((e={}).__data__=oo(t),gs(this.a,e)):gs(this.a,t)},Rr.G=function(){this.a.c=null,delete this.f,ms(this.a),delete this.a,_s.N.G.call(this)},Zr(Ms,Uo),Zr(Ps,jo),Zr(xs,Os),xs.prototype.va=function(){this.a.dispatchEvent("a")},xs.prototype.ua=function(t){this.a.dispatchEvent(new Ms(t))},xs.prototype.ta=function(t){this.a.dispatchEvent(new Ps(t))},xs.prototype.sa=function(){this.a.dispatchEvent("b")};var Ls=Jr(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},Rs);Rs.prototype.createWebChannel=Rs.prototype.a,_s.prototype.send=_s.prototype.Xa,_s.prototype.open=_s.prototype.Wa,_s.prototype.close=_s.prototype.close,xo.NO_ERROR=0,xo.TIMEOUT=8,xo.HTTP_ERROR=6,Lo.COMPLETE="complete",Fo.EventType=Vo,Vo.OPEN="a",Vo.CLOSE="b",Vo.ERROR="c",Vo.MESSAGE="d",ro.prototype.listen=ro.prototype.Aa,es.prototype.listenOnce=es.prototype.Ba,es.prototype.getLastError=es.prototype.Ya,es.prototype.getLastErrorCode=es.prototype.ya,es.prototype.getStatus=es.prototype.T,es.prototype.getStatusText=es.prototype.za,es.prototype.getResponseJson=es.prototype.Va,es.prototype.getResponseText=es.prototype.aa,es.prototype.send=es.prototype.ca;var qs,Fs,Bs={createWebChannelTransport:Ls,ErrorCode:xo,EventType:Lo,WebChannel:Fo,XhrIo:es},Vs=Bs.createWebChannelTransport,Us=Bs.ErrorCode,js=Bs.EventType,Qs=Bs.WebChannel,Ks=Bs.XhrIo,Gs=Or.SDK_VERSION,Ws=new Pr("@firebase/firestore");function zs(){return Ws.logLevel===kr.DEBUG?qs.DEBUG:Ws.logLevel===kr.SILENT?qs.SILENT:qs.ERROR}function Hs(t){switch(t){case qs.DEBUG:Ws.logLevel=kr.DEBUG;break;case qs.ERROR:Ws.logLevel=kr.ERROR;break;case qs.SILENT:Ws.logLevel=kr.SILENT;break;default:Ws.error("Firestore ("+Gs+"): Invalid value passed to `setLogLevel`")}}function Ys(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(Ws.logLevel<=kr.DEBUG){var i=n.map(Js);Ws.debug.apply(Ws,["Firestore ("+Gs+") ["+t+"]: "+e].concat(i))}}function Xs(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(Ws.logLevel<=kr.ERROR){var r=e.map(Js);Ws.error.apply(Ws,["Firestore ("+Gs+"): "+t].concat(r))}}function Js(t){if("string"==typeof t)return t;var e=tu.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function $s(t){var e="FIRESTORE ("+Gs+") INTERNAL ASSERTION FAILED: "+t;throw Xs(e),new Error(e)}function Zs(t,e){t||$s(e)}(Fs=qs||(qs={}))[Fs.DEBUG=0]="DEBUG",Fs[Fs.ERROR=1]="ERROR",Fs[Fs.SILENT=2]="SILENT";var tu=function(){function t(){}return t.setPlatform=function(e){t.platform&&$s("Platform already defined"),t.platform=e},t.getPlatform=function(){return t.platform||$s("Platform not set"),t.platform},t}();function eu(){return tu.getPlatform().emptyByteString}var nu={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},ru=function(t){function e(e,n){var r=t.call(this,n)||this;return r.code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return ar(e,t),e}(Error);function iu(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new ru(nu.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function ou(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function au(t,e){return void 0!==t?t:e}function su(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function uu(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function cu(t){for(var e in Zs(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function hu(t,e){if(0!==e.length)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+Du(e.length,"argument")+".")}function lu(t,e,n){if(e.length!==n)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires "+Du(n,"argument")+", but was called with "+Du(e.length,"argument")+".")}function fu(t,e,n){if(e.length<n)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires at least "+Du(n,"argument")+", but was called with "+Du(e.length,"argument")+".")}function pu(t,e,n,r){if(e.length<n||e.length>r)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+Du(e.length,"argument")+".")}function du(t,e,n,r){bu(t,e,Cu(n)+" argument",r)}function mu(t,e,n,r){void 0!==r&&du(t,e,n,r)}function yu(t,e,n,r){bu(t,e,n+" option",r)}function gu(t,e,n,r){void 0!==r&&yu(t,e,n,r)}function vu(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(Su(u))}var c=Su(r);throw new ru(nu.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function bu(t,e,n,r){if(!("object"===e?wu(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=Su(r);throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function wu(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function Su(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":$s("Unknown wrong type: "+typeof t)}function Eu(t,e,n){if(void 0===n)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+Cu(e)+" argument, but it was undefined.")}function Tu(t,e,n){uu(e,function(e,r){if(n.indexOf(e)<0)throw new ru(nu.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))})}function Iu(t,e,n,r){var i=Su(r);return new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires its "+Cu(n)+" argument to be a "+e+", but it was: "+i)}function Cu(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function Du(t,e){return t+" "+e+(1===t?"":"s")}var Au=function(){function t(){}return t.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Zs(20===e.length,"Invalid auto ID: "+e),e},t}();function Nu(t,e){return t<e?-1:t>e?1:0}function ku(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function Ou(t){return t+"\0"}function Ru(){if("undefined"==typeof Uint8Array)throw new ru(nu.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function _u(){if(!tu.getPlatform().base64Available)throw new ru(nu.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Mu,Pu,xu=function(){function t(t){_u(),this._binaryString=t}return t.fromBase64String=function(e){lu("Blob.fromBase64String",arguments,1),du("Blob.fromBase64String","string",1,e),_u();try{return new t(tu.getPlatform().atob(e))}catch(t){throw new ru(nu.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(e){if(lu("Blob.fromUint8Array",arguments,1),Ru(),!(e instanceof Uint8Array))throw Iu("Blob.fromUint8Array","Uint8Array",1,e);return new t(Array.prototype.map.call(e,function(t){return String.fromCharCode(t)}).join(""))},t.prototype.toBase64=function(){return lu("Blob.toBase64",arguments,0),_u(),tu.getPlatform().btoa(this._binaryString)},t.prototype.toUint8Array=function(){lu("Blob.toUint8Array",arguments,0),Ru();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._binaryString===t._binaryString},t.prototype._compareTo=function(t){return Nu(this._binaryString,t._binaryString)},t}(),Lu=iu(xu,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),qu=function(){function t(t,e){if(lu("GeoPoint",arguments,2),du("GeoPoint","number",1,t),du("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new ru(nu.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new ru(nu.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype._compareTo=function(t){return Nu(this._lat,t._lat)||Nu(this._long,t._long)},t}(),Fu=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new ru(nu.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new ru(nu.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new ru(nu.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new ru(nu.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,1e6*(e-1e3*n))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?Nu(this.nanoseconds,t.nanoseconds):Nu(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),Bu=function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i},Vu="(default)",Uu=function(){function t(t,e){this.projectId=t,this.database=e||Vu}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return this.database===Vu},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t.prototype.compareTo=function(t){return Nu(this.projectId,t.projectId)||Nu(this.database,t.database)},t}(),ju=function(){function t(t,e,n){this.init(t,e,n)}return t.prototype.init=function(t,e,n){void 0===e?e=0:e>t.length&&$s("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&$s("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n},t.prototype.construct=function(t,e,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(t,e,n),r},Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.comparator(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach(function(t){n.push(t)}):"string"==typeof e?n.push(e):$s("Unknown parameter type for Path.child(): "+e),this.construct(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return Zs(this.length>=(t=void 0===t?1:t),"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return Zs(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return Zs(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.lastSegment=function(){return this.get(this.length-1)},t.prototype.get=function(t){return Zs(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),Qu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ar(e,t),e.prototype.canonicalString=function(){return this.toArray().join("/")},e.prototype.toString=function(){return this.canonicalString()},e.fromString=function(t){if(t.indexOf("//")>=0)throw new ru(nu.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new e(t.split("/").filter(function(t){return t.length>0}))},e.EMPTY_PATH=new e([]),e}(ju),Ku=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Gu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ar(e,t),e.isValidIdentifier=function(t){return Ku.test(t)},e.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),e.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},e.prototype.toString=function(){return this.canonicalString()},e.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},e.keyField=function(){return new e(["__name__"])},e.fromServerFormat=function(t){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new ru(nu.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},a=!1;i<t.length;){var s=t[i];if("\\"===s){if(i+1===t.length)throw new ru(nu.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var u=t[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new ru(nu.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else"`"===s?(a=!a,i++):"."!==s||a?(r+=s,i++):(o(),i++)}if(o(),a)throw new ru(nu.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.EMPTY_PATH=new e([]),e}(ju),Wu=function(){function t(e){this.path=e,Zs(t.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return t.prototype.hasCollectionId=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===Qu.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,e){return Qu.comparator(t.path,e.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(e){return new t(new Qu(e.slice()))},t.fromPathString=function(e){return new t(Qu.fromString(e))},t.EMPTY=new t(new Qu([])),t}(),zu=function(){function t(t,e){this.key=t,this.version=e}return t.compareByKey=function(t,e){return Wu.comparator(t.key,e.key)},t}(),Hu=function(t){function e(e,n,r,i,o){var a=t.call(this,e,n)||this;return a.data=r,a.proto=o,a.hasLocalMutations=!!i.hasLocalMutations,a.hasCommittedMutations=!!i.hasCommittedMutations,a}return ar(e,t),e.prototype.field=function(t){return this.data.field(t)},e.prototype.fieldValue=function(t){var e=this.field(t);return e?e.value():void 0},e.prototype.value=function(){return this.data.value()},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.data.isEqual(t.data)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return void 0!==r&&void 0!==i?r.compareTo(i):$s("Trying to compare documents on fields that don't exist")},e}(zu),Yu=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return ar(e,t),e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(zu),Xu=function(t){function e(e,n){return t.call(this,e,n)||this}return ar(e,t),e.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(zu),Ju=function(){function t(t,e){this.comparator=t,this.root=e||Zu.EMPTY}return t.prototype.insert=function(e,n){return new t(this.comparator,this.root.insert(e,n,this.comparator).copy(null,null,Zu.BLACK,null,null))},t.prototype.remove=function(e){return new t(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Zu.BLACK,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal(function(e,n){return t(e,n),!1})},t.prototype.toString=function(){var t=[];return this.inorderTraversal(function(e,n){return t.push(e+":"+n),!1}),"{"+t.join(", ")+"}"},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new $u(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new $u(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new $u(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new $u(this.root,t,this.comparator,!0)},t}(),$u=function(){function t(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){Zs(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),Zu=function(){function t(e,n,r,i,o){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=o?o:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,o){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(e,i.key)){if(i.right.isEmpty())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.rotateRight=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw $s("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw $s("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw $s("Black depths differ");return t+(this.isRed()?0:1)},t.EMPTY=null,t.RED=!0,t.BLACK=!1,t}(),tc=function(){function t(){this.size=0}return t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.insert=function(t,e,n){return new Zu(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(t){return!1},t.prototype.reverseTraversal=function(t){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}();Zu.EMPTY=new tc,function(t){t[t.NullValue=0]="NullValue",t[t.BooleanValue=1]="BooleanValue",t[t.NumberValue=2]="NumberValue",t[t.TimestampValue=3]="TimestampValue",t[t.StringValue=4]="StringValue",t[t.BlobValue=5]="BlobValue",t[t.RefValue=6]="RefValue",t[t.GeoPointValue=7]="GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.ObjectValue=9]="ObjectValue"}(Mu||(Mu={})),function(t){t[t.Default=0]="Default",t[t.Estimate=1]="Estimate",t[t.Previous=2]="Previous"}(Pu||(Pu={}));var ec=function(){function t(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}return t.fromSnapshotOptions=function(e,n){switch(e.serverTimestamps){case"estimate":return new t(Pu.Estimate,n);case"previous":return new t(Pu.Previous,n);case"none":case void 0:return new t(Pu.Default,n);default:return $s("fromSnapshotOptions() called with invalid options.")}},t}(),nc=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.defaultCompareTo=function(t){return Zs(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),Nu(this.typeOrder,t.typeOrder)},t}(),rc=function(t){function e(){var e=t.call(this)||this;return e.typeOrder=Mu.NullValue,e.internalValue=null,e}return ar(e,t),e.prototype.value=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e},e.prototype.compareTo=function(t){return t instanceof e?0:this.defaultCompareTo(t)},e.INSTANCE=new e,e}(nc),ic=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.BooleanValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?Nu(this,t):this.defaultCompareTo(t)},e.of=function(t){return t?e.TRUE:e.FALSE},e.TRUE=new e(!0),e.FALSE=new e(!1),e}(nc),oc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.NumberValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.compareTo=function(t){return t instanceof e?(n=this.internalValue)<(r=t.internalValue)?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1:this.defaultCompareTo(t);var n,r},e}(nc);function ac(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var sc=function(t){function e(e){return t.call(this,e)||this}return ar(e,t),e.prototype.isEqual=function(t){return t instanceof e&&ac(this.internalValue,t.internalValue)},e}(oc),uc=function(t){function e(e){var n=t.call(this,e)||this;return n.internalValue=e,n}return ar(e,t),e.prototype.isEqual=function(t){return t instanceof e&&ac(this.internalValue,t.internalValue)},e.NAN=new e(NaN),e.POSITIVE_INFINITY=new e(1/0),e.NEGATIVE_INFINITY=new e(-1/0),e}(oc),cc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.StringValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?Nu(this.internalValue,t.internalValue):this.defaultCompareTo(t)},e}(nc),hc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.TimestampValue,n}return ar(e,t),e.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):t instanceof lc?-1:this.defaultCompareTo(t)},e}(nc),lc=function(t){function e(e,n){var r=t.call(this)||this;return r.localWriteTime=e,r.previousValue=n,r.typeOrder=Mu.TimestampValue,r}return ar(e,t),e.prototype.value=function(t){return t&&t.serverTimestampBehavior===Pu.Estimate?new hc(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===Pu.Previous&&this.previousValue?this.previousValue.value(t):null},e.prototype.isEqual=function(t){return t instanceof e&&this.localWriteTime.isEqual(t.localWriteTime)},e.prototype.compareTo=function(t){return t instanceof e?this.localWriteTime._compareTo(t.localWriteTime):t instanceof hc?1:this.defaultCompareTo(t)},e.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},e}(nc),fc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.BlobValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(nc),pc=function(t){function e(e,n){var r=t.call(this)||this;return r.databaseId=e,r.key=n,r.typeOrder=Mu.RefValue,r}return ar(e,t),e.prototype.value=function(t){return this.key},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},e.prototype.compareTo=function(t){if(t instanceof e){var n=this.databaseId.compareTo(t.databaseId);return 0!==n?n:Wu.comparator(this.key,t.key)}return this.defaultCompareTo(t)},e}(nc),dc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.GeoPointValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(nc),mc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.ObjectValue,n}return ar(e,t),e.prototype.value=function(t){var e={};return this.internalValue.inorderTraversal(function(n,r){e[n]=r.value(t)}),e},e.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},e.prototype.isEqual=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext();if(i.key!==o.key||!i.value.isEqual(o.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext(),a=Nu(i.key,o.key)||i.value.compareTo(o.value);if(a)return a}return Nu(n.hasNext(),r.hasNext())}return this.defaultCompareTo(t)},e.prototype.set=function(t,n){if(Zs(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),n);var r=this.child(t.firstSegment());r instanceof e||(r=e.EMPTY);var i=r.set(t.popFirst(),n);return this.setChild(t.firstSegment(),i)},e.prototype.delete=function(t){if(Zs(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new e(this.internalValue.remove(t.firstSegment()));var n=this.child(t.firstSegment());if(n instanceof e){var r=n.delete(t.popFirst());return new e(this.internalValue.insert(t.firstSegment(),r))}return this},e.prototype.contains=function(t){return void 0!==this.field(t)},e.prototype.field=function(t){Zs(!t.isEmpty(),"Can't get field of empty path");var n=this;return t.forEach(function(t){n=n instanceof e&&n.internalValue.get(t)||void 0}),n},e.prototype.toString=function(){return this.internalValue.toString()},e.prototype.child=function(t){return this.internalValue.get(t)||void 0},e.prototype.setChild=function(t,n){return new e(this.internalValue.insert(t,n))},e.EMPTY=new e(new Ju(Nu)),e}(nc),yc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Mu.ArrayValue,n}return ar(e,t),e.prototype.value=function(t){return this.internalValue.map(function(e){return e.value(t)})},e.prototype.forEach=function(t){this.internalValue.forEach(t)},e.prototype.isEqual=function(t){if(t instanceof e){if(this.internalValue.length!==t.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].isEqual(t.internalValue[n]))return!1;return!0}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=Math.min(this.internalValue.length,t.internalValue.length),r=0;r<n;r++){var i=this.internalValue[r].compareTo(t.internalValue[r]);if(i)return i}return Nu(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},e.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},e}(nc),gc=Number,vc=gc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),bc=gc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,wc=gc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function Sc(t){return null==t}function Ec(t){return wc(t)&&t<=bc&&t>=vc}var Tc,Ic=function(){function t(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return t.atPath=function(e){return new t(e)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)this.memoizedOrderBy=t.isKeyField()?[Mc]:[new _c(t),Mc];else{Zs(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}n||this.memoizedOrderBy.push((this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Oc.ASCENDING)===Oc.ASCENDING?Mc:Pc)}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(e){Zs(null==this.getInequalityFilterField()||!(e instanceof Ac)||!e.isInequality()||e.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Zs(!this.isDocumentQuery(),"No filtering allowed for document query");var n=this.filters.concat([e]);return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),n,this.limit,this.startAt,this.endAt)},t.prototype.addOrderBy=function(e){Zs(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([e]);return new t(this.path,this.collectionGroup,n,this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.withLimit=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},t.prototype.withStartAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},t.prototype.withEndAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},t.prototype.asCollectionQueryAtPath=function(e){return new t(e,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";Sc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},t.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),Sc(this.limit)||(t+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},t.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Zs(n,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},t.prototype.hasLimit=function(){return!Sc(this.limit)},t.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},t.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof Ac&&n.isInequality())return n.field}return null},t.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(t){return t instanceof Ac&&t.op===Dc.ARRAY_CONTAINS})},t.prototype.isDocumentQuery=function(){return Wu.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},t.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},t.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Wu.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},t.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&void 0===t.field(r.field))return!1}return!0},t.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},t.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},t.prototype.assertValidBound=function(t){Zs(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),Cc=function(){function t(){}return t.create=function(t,e,n){if(n.isEqual(rc.INSTANCE)){if(e!==Dc.EQUAL)throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new Nc(t)}if(n.isEqual(uc.NAN)){if(e!==Dc.EQUAL)throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new kc(t)}return new Ac(t,e,n)},t}(),Dc=function(){function t(t){this.name=t}return t.fromString=function(e){switch(e){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;default:return $s("Unknown relation: "+e)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t}(),Ac=function(t){function e(e,n,r){var i=t.call(this)||this;return i.field=e,i.op=n,i.value=r,i}return ar(e,t),e.prototype.matches=function(t){if(this.field.isKeyField()){Zs(this.value instanceof pc,"Comparing on key, but filter value not a RefValue"),Zs(this.op!==Dc.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var e=Wu.comparator(t.key,this.value.key);return this.matchesComparison(e)}var n=t.field(this.field);return void 0!==n&&this.matchesValue(n)},e.prototype.matchesValue=function(t){var e=this;return this.op===Dc.ARRAY_CONTAINS?t instanceof yc&&void 0!==t.internalValue.find(function(t){return t.isEqual(e.value)}):this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},e.prototype.matchesComparison=function(t){switch(this.op){case Dc.LESS_THAN:return t<0;case Dc.LESS_THAN_OR_EQUAL:return t<=0;case Dc.EQUAL:return 0===t;case Dc.GREATER_THAN:return t>0;case Dc.GREATER_THAN_OR_EQUAL:return t>=0;default:return $s("Unknown relation op"+this.op)}},e.prototype.isInequality=function(){return this.op!==Dc.EQUAL&&this.op!==Dc.ARRAY_CONTAINS},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},e.prototype.isEqual=function(t){return t instanceof e&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},e.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},e}(Cc),Nc=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return ar(e,t),e.prototype.matches=function(t){var e=t.field(this.field);return void 0!==e&&null===e.value()},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},e.prototype.toString=function(){return this.field.canonicalString()+" IS null"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(Cc),kc=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return ar(e,t),e.prototype.matches=function(t){var e=t.field(this.field),n=e&&e.value();return"number"==typeof n&&isNaN(n)},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(Cc),Oc=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),Rc=function(){function t(t,e){this.position=t,this.before=e}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},t.prototype.sortsBeforeDocument=function(t,e){Zs(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())Zs(o instanceof pc,"Bound has a non-key value where the key path is being used."),n=Wu.comparator(o.key,e.key);else{var a=e.field(i.field);Zs(void 0!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===Oc.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++)return this.position[e].isEqual(t.position[e]);return!0},t}(),_c=function(){function t(t,e){this.field=t,void 0===e&&(e=Oc.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}return t.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Hu.compareByKey(t,e):Hu.compareByField(this.field,t,e);switch(this.dir){case Oc.ASCENDING:return n;case Oc.DESCENDING:return-1*n;default:return $s("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},t.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),Mc=new _c(Gu.keyField(),Oc.ASCENDING),Pc=new _c(Gu.keyField(),Oc.DESCENDING),xc=function(){function t(t){this.timestamp=t}return t.fromMicroseconds=function(e){var n=Math.floor(e/1e6);return new t(new Fu(n,e%1e6*1e3))},t.fromTimestamp=function(e){return new t(e)},t.forDeletedDoc=function(){return t.MIN},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t.MIN=new t(new Fu(0,0)),t}();!function(t){t[t.Listen=0]="Listen",t[t.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",t[t.LimboResolution=2]="LimboResolution"}(Tc||(Tc={}));var Lc,qc=function(){function t(t,e,n,r,i,o){void 0===i&&(i=xc.MIN),void 0===o&&(o=eu()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}return t.prototype.copy=function(e){return new t(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},t}(),Fc=function(){function t(t){this.comparator=t,this.data=new Ju(this.comparator)}return t.fromMapKeys=function(e){var n=new t(e.comparator);return e.forEach(function(t){n=n.add(t)}),n},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}},t.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},t.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},t.prototype.getIterator=function(){return new Bc(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new Bc(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.getIterator(),r=e.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},t.prototype.toString=function(){var t=[];return this.forEach(function(e){return t.push(e)}),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.comparator);return n.data=e,n},t}(),Bc=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),Vc=function(){function t(t){this.fields=t}return t.fromSet=function(e){return new t(e)},t.fromArray=function(e){var n=new Fc(Gu.comparator);return e.forEach(function(t){return n=n.add(t)}),new t(n)},t.prototype.covers=function(t){var e=!1;return this.fields.forEach(function(n){n.isPrefixOf(t)&&(e=!0)}),e},t.prototype.applyTo=function(t){var e=mc.EMPTY;return this.fields.forEach(function(n){if(n.isEmpty())return t;var r=t.field(n);void 0!==r&&(e=e.set(n,r))}),e},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),Uc=function(){function t(t,e){this.field=t,this.transform=e}return Object.defineProperty(t.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),jc=function(t,e){this.version=t,this.transformResults=e};!function(t){t[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete"}(Lc||(Lc={}));var Qc=function(){function t(t,e){this.updateTime=t,this.exists=e,Zs(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Hu&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Hu:(Zs(this.isNone,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return n=t.updateTime,(null!=(e=this.updateTime)?!(!n||!e.isEqual(n)):e===n)&&this.exists===t.exists;var e,n},t.NONE=new t,t}(),Kc=function(){function t(){}return t.prototype.verifyKeyMatches=function(t){null!=t&&Zs(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.getPostMutationVersion=function(t){return t instanceof Hu?t.version:xc.MIN},t}(),Gc=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.value=n,i.precondition=r,i.type=Lc.Set,i}return ar(e,t),e.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Zs(null==e.transformResults,"Transform results received by SetMutation."),new Hu(this.key,e.version,this.value,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Kc.getPostMutationVersion(t);return new Hu(this.key,r,this.value,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},e}(Kc),Wc=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.key=e,o.data=n,o.fieldMask=r,o.precondition=i,o.type=Lc.Patch,o}return ar(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Zs(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new Xu(this.key,e.version);var n=this.patchDocument(t);return new Hu(this.key,e.version,n,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Kc.getPostMutationVersion(t),i=this.patchDocument(t);return new Hu(this.key,r,i,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},e.prototype.patchDocument=function(t){return this.patchObject(t instanceof Hu?t.data:mc.EMPTY)},e.prototype.patchObject=function(t){var e=this;return this.fieldMask.fields.forEach(function(n){if(!n.isEmpty()){var r=e.data.field(n);t=void 0!==r?t.set(n,r):t.delete(n)}}),t},e}(Kc),zc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.fieldTransforms=n,r.type=Lc.Transform,r.precondition=Qc.exists(!0),r}return ar(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Zs(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new Xu(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data,r);return new Hu(this.key,i,o,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,e),o=this.transformObject(r.data,i);return new Hu(this.key,r.version,o,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){for(var t=0,e=this.fieldTransforms;t<e.length;t++)if(!e[t].isIdempotent)return!1;return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){var t=new Fc(Gu.comparator);return this.fieldTransforms.forEach(function(e){return t=t.add(e.field)}),new Vc(t)},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&ku(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},e.prototype.requireDocument=function(t){Zs(t instanceof Hu,"Unknown MaybeDocument type "+t);var e=t;return Zs(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},e.prototype.serverTransformResults=function(t,e){var n=[];Zs(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Hu&&(a=t.field(i.field)||null),n.push(o.applyToRemoteDocument(a,e[r]))}return n},e.prototype.localTransformResults=function(t,e){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],a=o.transform,s=null;e instanceof Hu&&(s=e.field(o.field)||null),n.push(a.applyToLocalView(s,t))}return n},e.prototype.transformObject=function(t,e){Zs(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++)t=t.set(this.fieldTransforms[n].field,e[n]);return t},e}(Kc),Hc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.precondition=n,r.type=Lc.Delete,r}return ar(e,t),e.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Zs(null==e.transformResults,"Transform results received by DeleteMutation."),new Yu(this.key,e.version,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Zs(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Yu(this.key,xc.forDeletedDoc())):t},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e}(Kc),Yc=function(){function t(){this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return new lc(e,t)},t.prototype.applyToRemoteDocument=function(t,e){return e},t.prototype.isEqual=function(e){return e instanceof t},t.instance=new t,t}(),Xc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Zc(t),n=function(t){e.find(function(e){return e.isEqual(t)})||e.push(t)},r=0,i=this.elements;r<i.length;r++)n(i[r]);return new yc(e)},t.prototype.isEqual=function(e){return e instanceof t&&ku(e.elements,this.elements)},t}(),Jc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Zc(t),n=function(t){e=e.filter(function(e){return!e.isEqual(t)})},r=0,i=this.elements;r<i.length;r++)n(i[r]);return new yc(e)},t.prototype.isEqual=function(e){return e instanceof t&&ku(e.elements,this.elements)},t}(),$c=function(){function t(t){this.operand=t,this.isIdempotent=!1}return t.prototype.applyToLocalView=function(t,e){return t instanceof sc&&this.operand instanceof sc?new sc(t.internalValue+this.operand.internalValue):t instanceof oc?new uc(t.internalValue+this.operand.internalValue):this.operand},t.prototype.applyToRemoteDocument=function(t,e){return Zs(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},t.prototype.isEqual=function(e){return e instanceof t&&this.operand.isEqual(e.operand)},t}();function Zc(t){return t instanceof yc?t.internalValue.slice():[]}var th,eh=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}();function nh(t){switch(t){case nu.OK:return $s("Treated status OK as error");case nu.CANCELLED:case nu.UNKNOWN:case nu.DEADLINE_EXCEEDED:case nu.RESOURCE_EXHAUSTED:case nu.INTERNAL:case nu.UNAVAILABLE:case nu.UNAUTHENTICATED:return!1;case nu.INVALID_ARGUMENT:case nu.NOT_FOUND:case nu.ALREADY_EXISTS:case nu.PERMISSION_DENIED:case nu.FAILED_PRECONDITION:case nu.ABORTED:case nu.OUT_OF_RANGE:case nu.UNIMPLEMENTED:case nu.DATA_LOSS:return!0;default:return $s("Unknown status code: "+t)}}function rh(t){if(void 0===t)return Xs("GRPC error has no .code"),nu.UNKNOWN;switch(t){case th.OK:return nu.OK;case th.CANCELLED:return nu.CANCELLED;case th.UNKNOWN:return nu.UNKNOWN;case th.DEADLINE_EXCEEDED:return nu.DEADLINE_EXCEEDED;case th.RESOURCE_EXHAUSTED:return nu.RESOURCE_EXHAUSTED;case th.INTERNAL:return nu.INTERNAL;case th.UNAVAILABLE:return nu.UNAVAILABLE;case th.UNAUTHENTICATED:return nu.UNAUTHENTICATED;case th.INVALID_ARGUMENT:return nu.INVALID_ARGUMENT;case th.NOT_FOUND:return nu.NOT_FOUND;case th.ALREADY_EXISTS:return nu.ALREADY_EXISTS;case th.PERMISSION_DENIED:return nu.PERMISSION_DENIED;case th.FAILED_PRECONDITION:return nu.FAILED_PRECONDITION;case th.ABORTED:return nu.ABORTED;case th.OUT_OF_RANGE:return nu.OUT_OF_RANGE;case th.UNIMPLEMENTED:return nu.UNIMPLEMENTED;case th.DATA_LOSS:return nu.DATA_LOSS;default:return $s("Unknown status code: "+t)}}function ih(t){if(void 0===t)return th.OK;switch(t){case nu.OK:return th.OK;case nu.CANCELLED:return th.CANCELLED;case nu.UNKNOWN:return th.UNKNOWN;case nu.DEADLINE_EXCEEDED:return th.DEADLINE_EXCEEDED;case nu.RESOURCE_EXHAUSTED:return th.RESOURCE_EXHAUSTED;case nu.INTERNAL:return th.INTERNAL;case nu.UNAVAILABLE:return th.UNAVAILABLE;case nu.UNAUTHENTICATED:return th.UNAUTHENTICATED;case nu.INVALID_ARGUMENT:return th.INVALID_ARGUMENT;case nu.NOT_FOUND:return th.NOT_FOUND;case nu.ALREADY_EXISTS:return th.ALREADY_EXISTS;case nu.PERMISSION_DENIED:return th.PERMISSION_DENIED;case nu.FAILED_PRECONDITION:return th.FAILED_PRECONDITION;case nu.ABORTED:return th.ABORTED;case nu.OUT_OF_RANGE:return th.OUT_OF_RANGE;case nu.UNIMPLEMENTED:return th.UNIMPLEMENTED;case nu.DATA_LOSS:return th.DATA_LOSS;default:return $s("Unknown status code: "+t)}}!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(th||(th={}));var oh=new Ju(Wu.comparator);function ah(){return oh}function sh(){return ah()}var uh=new Ju(Wu.comparator);function ch(){return uh}var hh=new Ju(Wu.comparator);function lh(){return hh}var fh=new Fc(Wu.comparator);function ph(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=fh,r=0,i=t;r<i.length;r++)n=n.add(i[r]);return n}var dh=new Fc(Nu);function mh(){return dh}var yh,gh,vh=function(){function t(t){this.comparator=t?function(e,n){return t(e,n)||Wu.comparator(e.key,n.key)}:function(t,e){return Wu.comparator(t.key,e.key)},this.keyedMap=ch(),this.sortedSet=new Ju(this.comparator)}return t.emptySet=function(e){return new t(e.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach(function(e){t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=n,r},t}();!function(t){t[t.Added=0]="Added",t[t.Removed=1]="Removed",t[t.Modified=2]="Modified",t[t.Metadata=3]="Metadata"}(yh||(yh={})),function(t){t[t.Local=0]="Local",t[t.Synced=1]="Synced"}(gh||(gh={}));var bh,wh=function(){function t(){this.changeMap=new Ju(Wu.comparator)}return t.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==yh.Added&&n.type===yh.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===yh.Metadata&&n.type!==yh.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===yh.Modified&&n.type===yh.Modified?this.changeMap=this.changeMap.insert(e,{type:yh.Modified,doc:t.doc}):t.type===yh.Modified&&n.type===yh.Added?this.changeMap=this.changeMap.insert(e,{type:yh.Added,doc:t.doc}):t.type===yh.Removed&&n.type===yh.Added?this.changeMap=this.changeMap.remove(e):t.type===yh.Removed&&n.type===yh.Modified?this.changeMap=this.changeMap.insert(e,{type:yh.Removed,doc:n.doc}):t.type===yh.Added&&n.type===yh.Removed?this.changeMap=this.changeMap.insert(e,{type:yh.Modified,doc:t.doc}):$s("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},t.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal(function(e,n){t.push(n)}),t},t}(),Sh=function(){function t(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}return t.fromInitialDocuments=function(e,n,r,i){var o=[];return n.forEach(function(t){o.push({type:yh.Added,doc:t})}),new t(e,n,vh.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),Eh=function(){function t(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return t.createSynthesizedRemoteEventForCurrentChange=function(e,n){var r,i=((r={})[e]=Th.createSynthesizedTargetChangeForCurrentChange(e,n),r);return new t(xc.MIN,i,mh(),ah(),ph())},t}(),Th=function(){function t(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return t.createSynthesizedTargetChangeForCurrentChange=function(e,n){return new t(eu(),n,ph(),ph(),ph())},t}(),Ih=function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r},Ch=function(t,e){this.targetId=t,this.existenceFilter=e};!function(t){t[t.NoChange=0]="NoChange",t[t.Added=1]="Added",t[t.Removed=2]="Removed",t[t.Current=3]="Current",t[t.Reset=4]="Reset"}(bh||(bh={}));var Dh=function(t,e,n,r){void 0===n&&(n=eu()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},Ah=function(){function t(){this.pendingResponses=0,this.documentChanges=Oh(),this._resumeToken=eu(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),t.prototype.updateResumeToken=function(t){t.length>0&&(this._hasPendingChanges=!0,this._resumeToken=t)},t.prototype.toTargetChange=function(){var t=ph(),e=ph(),n=ph();return this.documentChanges.forEach(function(r,i){switch(i){case yh.Added:t=t.add(r);break;case yh.Modified:e=e.add(r);break;case yh.Removed:n=n.add(r);break;default:$s("Encountered invalid change type: "+i)}}),new Th(this._resumeToken,this._current,t,e,n)},t.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Oh()},t.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},t.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},t.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},t.prototype.recordTargetResponse=function(){this.pendingResponses-=1},t.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},t}(),Nh=function(){function t(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=ah(),this.pendingDocumentTargetMapping=kh(),this.pendingTargetResets=new Fc(Nu)}return t.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Hu?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof Yu&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)this.removeDocumentFromTarget(r=o[i],t.key,t.newDoc)},t.prototype.handleTargetChange=function(t){var e=this;this.forEachTarget(t,function(n){var r=e.ensureTargetState(n);switch(t.state){case bh.NoChange:e.isActiveTarget(n)&&r.updateResumeToken(t.resumeToken);break;case bh.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(t.resumeToken);break;case bh.Removed:r.recordTargetResponse(),r.isPending||e.removeTarget(n),Zs(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case bh.Current:e.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(t.resumeToken));break;case bh.Reset:e.isActiveTarget(n)&&(e.resetTarget(n),r.updateResumeToken(t.resumeToken));break;default:$s("Unknown target watch change state: "+t.state)}})},t.prototype.forEachTarget=function(t,e){t.targetIds.length>0?t.targetIds.forEach(e):su(this.targetStates,e)},t.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new Wu(i.path);this.removeDocumentFromTarget(e,o,new Yu(o,xc.forDeletedDoc()))}else Zs(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},t.prototype.createRemoteEvent=function(t){var e=this,n={};su(this.targetStates,function(r,i){var o=e.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var a=new Wu(o.query.path);null!==e.pendingDocumentUpdates.get(a)||e.targetContainsDocument(r,a)||e.removeDocumentFromTarget(r,a,new Yu(a,t))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}});var r=ph();this.pendingDocumentTargetMapping.forEach(function(t,n){var i=!0;n.forEachWhile(function(t){var n=e.queryDataForActiveTarget(t);return!n||n.purpose===Tc.LimboResolution||(i=!1,!1)}),i&&(r=r.add(t))});var i=new Eh(t,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=ah(),this.pendingDocumentTargetMapping=kh(),this.pendingTargetResets=new Fc(Nu),i},t.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?yh.Modified:yh.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},t.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,yh.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},t.prototype.removeTarget=function(t){delete this.targetStates[t]},t.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},t.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},t.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Ah),this.targetStates[t]},t.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new Fc(Nu),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},t.prototype.isActiveTarget=function(t){return null!==this.queryDataForActiveTarget(t)},t.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},t.prototype.resetTarget=function(t){var e=this;Zs(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new Ah,this.metadataProvider.getRemoteKeysForTarget(t).forEach(function(n){e.removeDocumentFromTarget(t,n,null)})},t.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},t}();function kh(){return new Ju(Wu.comparator)}function Oh(){return new Ju(Wu.comparator)}var Rh,_h,Mh=((Rh={})[Oc.ASCENDING.name]="ASCENDING",Rh[Oc.DESCENDING.name]="DESCENDING",Rh),Ph=((_h={})[Dc.LESS_THAN.name]="LESS_THAN",_h[Dc.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",_h[Dc.GREATER_THAN.name]="GREATER_THAN",_h[Dc.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",_h[Dc.EQUAL.name]="EQUAL",_h[Dc.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",_h),xh=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Lh(t,e){Zs(!Sc(t),e+" is missing")}function qh(t){return"number"==typeof t?t:"string"==typeof t?Number(t):$s("can't parse "+t)}var Fh=function(){function t(t,e){this.databaseId=t,this.options=e}return t.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},t.prototype.unsafeCastProtoByteString=function(t){return t},t.prototype.fromRpcStatus=function(t){var e=void 0===t.code?nu.UNKNOWN:rh(t.code);return new ru(e,t.message||"")},t.prototype.toInt32Value=function(t){return Sc(t)?void 0:{value:t}},t.prototype.fromInt32Value=function(t){var e;return Sc(e="object"==typeof t?t.value:t)?null:e},t.prototype.toTimestamp=function(t){return{seconds:t.seconds,nanos:t.nanoseconds}},t.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Zs(!!t,"Cannot deserialize null or undefined timestamp.");var e=qh(t.seconds||"0");return new Fu(e,t.nanos||0)},t.prototype.fromIso8601String=function(t){var e=0,n=xh.exec(t);if(Zs(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new Fu(o,e)},t.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},t.prototype.fromBlob=function(t){return"string"==typeof t?(Zs(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),xu.fromBase64String(t)):(Zs(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),xu.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},t.prototype.fromVersion=function(t){return Zs(!!t,"Trying to deserialize version that isn't set"),xc.fromTimestamp(this.fromTimestamp(t))},t.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},t.prototype.fromResourceName=function(t){var e=Qu.fromString(t);return Zs(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},t.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},t.prototype.fromName=function(t){var e=this.fromResourceName(t);return Zs(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),Zs(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Wu(this.extractLocalPathFromResourceName(e))},t.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},t.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?Qu.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(t.prototype,"encodedDatabaseId",{get:function(){return new Qu(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),t.prototype.fullyQualifiedPrefixPath=function(t){return new Qu(["projects",t.projectId,"databases",t.database])},t.prototype.extractLocalPathFromResourceName=function(t){return Zs(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},t.prototype.isValidResourceName=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.toValue=function(t){if(t instanceof rc)return{nullValue:"NULL_VALUE"};if(t instanceof ic)return{booleanValue:t.value()};if(t instanceof sc)return{integerValue:""+t.value()};if(t instanceof uc){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof cc?{stringValue:t.value()}:t instanceof mc?{mapValue:this.toMapValue(t)}:t instanceof yc?{arrayValue:this.toArrayValue(t)}:t instanceof hc?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof dc?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof fc?{bytesValue:this.toBytes(t.value())}:t instanceof pc?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:$s("Unknown FieldValue "+JSON.stringify(t))},t.prototype.fromValue=function(t){var e=this,n=t.value_type;if(Bh(t,n,"nullValue"))return rc.INSTANCE;if(Bh(t,n,"booleanValue"))return ic.of(t.booleanValue);if(Bh(t,n,"integerValue"))return new sc(qh(t.integerValue));if(Bh(t,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return uc.NAN;if("Infinity"===t.doubleValue)return uc.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return uc.NEGATIVE_INFINITY}return new uc(t.doubleValue)}if(Bh(t,n,"stringValue"))return new cc(t.stringValue);if(Bh(t,n,"mapValue"))return this.fromFields(t.mapValue.fields||{});if(Bh(t,n,"arrayValue"))return Lh(t.arrayValue,"arrayValue"),new yc((t.arrayValue.values||[]).map(function(t){return e.fromValue(t)}));if(Bh(t,n,"timestampValue"))return Lh(t.timestampValue,"timestampValue"),new hc(this.fromTimestamp(t.timestampValue));if(Bh(t,n,"geoPointValue"))return Lh(t.geoPointValue,"geoPointValue"),new dc(new qu(t.geoPointValue.latitude||0,t.geoPointValue.longitude||0));if(Bh(t,n,"bytesValue")){Lh(t.bytesValue,"bytesValue");var r=this.fromBlob(t.bytesValue);return new fc(r)}if(Bh(t,n,"referenceValue")){Lh(t.referenceValue,"referenceValue");var i=this.fromResourceName(t.referenceValue),o=new Uu(i.get(1),i.get(3)),a=new Wu(this.extractLocalPathFromResourceName(i));return new pc(o,a)}return $s("Unknown Value proto "+JSON.stringify(t))},t.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},t.prototype.toDocument=function(t){return Zs(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toTimestamp(t.version.toTimestamp())}},t.prototype.fromDocument=function(t,e){return new Hu(this.fromName(t.name),this.fromVersion(t.updateTime),this.fromFields(t.fields||{}),{hasCommittedMutations:!!e})},t.prototype.toFields=function(t){var e=this,n={};return t.forEach(function(t,r){n[t]=e.toValue(r)}),n},t.prototype.fromFields=function(t){var e=this,n=mc.EMPTY;return uu(t,function(t,r){n=n.set(new Gu([t]),e.fromValue(r))}),n},t.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},t.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},t.prototype.fromFound=function(t){Zs(!!t.found,"Tried to deserialize a found document from a missing document."),Lh(t.found.name,"doc.found.name"),Lh(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),n=this.fromVersion(t.found.updateTime),r=this.fromFields(t.found.fields||{});return new Hu(e,n,r,{},t.found)},t.prototype.fromMissing=function(t){Zs(!!t.missing,"Tried to deserialize a missing document from a found document."),Zs(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new Yu(e,n)},t.prototype.fromMaybeDocument=function(t){var e=t.result;return Bh(t,e,"found")?this.fromFound(t):Bh(t,e,"missing")?this.fromMissing(t):$s("invalid batch get response: "+JSON.stringify(t))},t.prototype.toWatchTargetChangeState=function(t){switch(t){case bh.Added:return"ADD";case bh.Current:return"CURRENT";case bh.NoChange:return"NO_CHANGE";case bh.Removed:return"REMOVE";case bh.Reset:return"RESET";default:return $s("Unknown WatchTargetChangeState: "+t)}},t.prototype.toTestWatchChange=function(t){if(t instanceof Ch)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof Ih){var e;if(t.newDoc instanceof Hu)return{documentChange:{document:{name:this.toName((e=t.newDoc).key),fields:this.toFields(e.data),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}};if(t.newDoc instanceof Yu)return{documentDelete:{document:this.toName((e=t.newDoc).key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Dh){var n=void 0;return t.cause&&(n={code:ih(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return $s("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.fromWatchChange=function(t){var e,n=t.response_type;if(Bh(t,n,"targetChange")){Lh(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new Dh(r,i,o,s||null)}else if(Bh(t,n,"documentChange")){Lh(t.documentChange,"documentChange"),Lh(t.documentChange.document,"documentChange.name"),Lh(t.documentChange.document.name,"documentChange.document.name"),Lh(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=this.fromFields(u.document.fields||{}),f=new Hu(c,h,l,{},u.document);e=new Ih(u.targetIds||[],u.removedTargetIds||[],f.key,f)}else if(Bh(t,n,"documentDelete")){Lh(t.documentDelete,"documentDelete"),Lh(t.documentDelete.document,"documentDelete.document");var p=t.documentDelete;c=this.fromName(p.document),h=p.readTime?this.fromVersion(p.readTime):xc.forDeletedDoc(),f=new Yu(c,h),e=new Ih([],p.removedTargetIds||[],f.key,f)}else if(Bh(t,n,"documentRemove")){Lh(t.documentRemove,"documentRemove"),Lh(t.documentRemove.document,"documentRemove");var d=t.documentRemove;c=this.fromName(d.document),e=new Ih([],d.removedTargetIds||[],c,null)}else{if(!Bh(t,n,"filter"))return $s("Unknown change type "+JSON.stringify(t));Lh(t.filter,"filter"),Lh(t.filter.targetId,"filter.targetId");var m=t.filter,y=new eh(m.count||0);e=new Ch(m.targetId,y)}return e},t.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?bh.NoChange:"ADD"===t?bh.Added:"REMOVE"===t?bh.Removed:"CURRENT"===t?bh.Current:"RESET"===t?bh.Reset:$s("Got unexpected TargetChange.state: "+t)},t.prototype.versionFromListenResponse=function(t){if(!Bh(t,t.response_type,"targetChange"))return xc.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?xc.MIN:e.readTime?this.fromVersion(e.readTime):xc.MIN},t.prototype.toMutation=function(t){var e,n=this;if(t instanceof Gc)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Hc)e={delete:this.toName(t.key)};else if(t instanceof Wc)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof zc))return $s("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},t.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):Qc.NONE;if(t.update){Lh(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new Wc(r,i,o,n)}return new Gc(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new Hc(r,n);if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return Zs(!0===n.exists,'Transforms only support precondition "exists == true"'),new zc(r,a)}return $s("unknown mutation proto: "+JSON.stringify(t))},t.prototype.toPrecondition=function(t){return Zs(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:$s("Unknown precondition")},t.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?Qc.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Qc.exists(t.exists):Qc.NONE},t.prototype.fromWriteResult=function(t,e){var n=this,r=this.fromVersion(t.updateTime?t.updateTime:e),i=null;return t.transformResults&&t.transformResults.length>0&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new jc(r,i)},t.prototype.fromWriteResults=function(t,e){var n=this;return t&&t.length>0?(Zs(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},t.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Yc)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Xc)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Jc)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof $c)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw $s("Unknown transform: "+t.transform)},t.prototype.fromFieldTransform=function(t){var e=this,n=t.transform_type,r=null;if(Bh(t,n,"setToServerValue"))Zs("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=Yc.instance;else if(Bh(t,n,"appendMissingElements"))r=new Xc((t.appendMissingElements.values||[]).map(function(t){return e.fromValue(t)}));else if(Bh(t,n,"removeAllFromArray"))r=new Jc((t.removeAllFromArray.values||[]).map(function(t){return e.fromValue(t)}));else if(Bh(t,n,"increment")){var i=this.fromValue(t.increment);Zs(i instanceof oc,"NUMERIC_ADD transform requires a NumberValue"),r=new $c(i)}else $s("Unknown transform proto: "+JSON.stringify(t));var o=Gu.fromServerFormat(t.fieldPath);return new Uc(o,r)},t.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},t.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;return Zs(1===e,"DocumentsTarget contained other than 1 document: "+e),Ic.atPath(this.fromQueryPath(t.documents[0]))},t.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Zs(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Zs(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return void 0!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},t.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){Zs(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new Ic(e,i,s,a,u,c,h)},t.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},t.prototype.toLabel=function(t){switch(t){case Tc.Listen:return null;case Tc.ExistenceFilterMismatch:return"existence-filter-mismatch";case Tc.LimboResolution:return"limbo-document";default:return $s("Unrecognized query purpose: "+t)}},t.prototype.toTarget=function(t){var e,n=t.query;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},t.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof Ac?e.toRelationFilter(t):e.toUnaryFilter(t)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},t.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromRelationFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):$s("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},t.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},t.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},t.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new Rc(r,n)},t.prototype.toDirection=function(t){return Mh[t.name]},t.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Oc.ASCENDING;case"DESCENDING":return Oc.DESCENDING;default:return}},t.prototype.toOperatorName=function(t){return Ph[t.name]},t.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return Dc.EQUAL;case"GREATER_THAN":return Dc.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return Dc.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return Dc.LESS_THAN;case"LESS_THAN_OR_EQUAL":return Dc.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return Dc.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return $s("Unspecified relation");default:return $s("Unknown relation")}},t.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},t.prototype.fromFieldPathReference=function(t){return Gu.fromServerFormat(t.fieldPath)},t.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},t.prototype.fromPropertyOrder=function(t){return new _c(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},t.prototype.toRelationFilter=function(t){return t instanceof Ac?{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}:$s("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromRelationFilter=function(t){return new Ac(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},t.prototype.toUnaryFilter=function(t){return t instanceof kc?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}}:t instanceof Nc?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}:$s("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return new kc(e);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return new Nc(n);case"OPERATOR_UNSPECIFIED":return $s("Unspecified filter");default:return $s("Unknown filter")}},t.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},t.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return Gu.fromServerFormat(t)});return Vc.fromArray(e)},t}();function Bh(t,e,n){return e===n||!e&&n in t}var Vh=function(){function t(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}return t.prototype.onOpen=function(t){Zs(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},t.prototype.onClose=function(t){Zs(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},t.prototype.onMessage=function(t){Zs(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},t.prototype.close=function(){this.closeFn()},t.prototype.send=function(t){this.sendFn(t)},t.prototype.callOnOpen=function(){Zs(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},t.prototype.callOnClose=function(t){Zs(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},t.prototype.callOnMessage=function(t){Zs(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},t}(),Uh="Connection",jh={BatchGetDocuments:"batchGet",Commit:"commit"},Qh="gl-js/ fire/"+Gs,Kh=function(){function t(t){this.databaseId=t.databaseId,this.baseUrl=(t.ssl?"https":"http")+"://"+t.host,this.forceLongPolling=t.forceLongPolling}return t.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Qh},t.prototype.invokeRPC=function(t,e,n){var r=this,i=this.makeUrl(t);return new Promise(function(o,a){var s=new Ks;s.listenOnce(js.COMPLETE,function(){try{switch(s.getLastErrorCode()){case Us.NO_ERROR:var e=s.getResponseJson();Ys(Uh,"XHR received:",JSON.stringify(e)),o(e);break;case Us.TIMEOUT:Ys(Uh,'RPC "'+t+'" timed out'),a(new ru(nu.DEADLINE_EXCEEDED,"Request time out"));break;case Us.HTTP_ERROR:var n=s.getStatus();Ys(Uh,'RPC "'+t+'" failed with status:',n,"response text:",s.getResponseText()),n>0?a(new ru(function(t){switch(t){case 200:return nu.OK;case 400:return nu.INVALID_ARGUMENT;case 401:return nu.UNAUTHENTICATED;case 403:return nu.PERMISSION_DENIED;case 404:return nu.NOT_FOUND;case 409:return nu.ABORTED;case 416:return nu.OUT_OF_RANGE;case 429:return nu.RESOURCE_EXHAUSTED;case 499:return nu.CANCELLED;case 500:return nu.UNKNOWN;case 501:return nu.UNIMPLEMENTED;case 503:return nu.UNAVAILABLE;case 504:return nu.DEADLINE_EXCEEDED;default:return t>=200&&t<300?nu.OK:t>=400&&t<500?nu.FAILED_PRECONDITION:t>=500&&t<600?nu.INTERNAL:nu.UNKNOWN}}(n),"Server responded with status "+s.getStatusText())):(Ys(Uh,'RPC "'+t+'" failed'),a(new ru(nu.UNAVAILABLE,"Connection failed.")));break;default:$s('RPC "'+t+'" failed with unanticipated webchannel error '+s.getLastErrorCode()+": "+s.getLastError()+", giving up.")}}finally{Ys(Uh,'RPC "'+t+'" completed.')}});var u=JSON.stringify(e);Ys(Uh,"XHR sending: ",i+" "+u);var c={"Content-Type":"text/plain"};r.modifyHeadersForRequest(c,n),s.send(i,"POST",u,c,15)})},t.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},t.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Vs(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");Ys(Uh,"Creating WebChannel: "+o+" "+i);var a=r.createWebChannel(o,i),s=!1,u=!1,c=new Vh({sendFn:function(t){u?Ys(Uh,"Not sending because WebChannel is closed:",t):(s||(Ys(Uh,"Opening WebChannel transport."),a.open(),s=!0),Ys(Uh,"WebChannel sending:",t),a.send(t))},closeFn:function(){return a.close()}}),h=function(t,e){a.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})};return h(Qs.EventType.OPEN,function(){u||Ys(Uh,"WebChannel transport opened.")}),h(Qs.EventType.CLOSE,function(){u||(u=!0,Ys(Uh,"WebChannel transport closed"),c.callOnClose())}),h(Qs.EventType.ERROR,function(t){u||(u=!0,Ys(Uh,"WebChannel transport errored:",t),c.callOnClose(new ru(nu.UNAVAILABLE,"The operation could not be completed")))}),h(Qs.EventType.MESSAGE,function(t){if(!u){var e=t.data[0];Zs(!!e,"Got a webchannel message without data.");var n=e.error||e[0]&&e[0].error;if(n){Ys(Uh,"WebChannel received error:",n);var r=n.status,i=function(t){var e=th[r];if(void 0!==e)return rh(e)}(),o=n.message;void 0===i&&(i=nu.INTERNAL,o="Unknown error status: "+r+" with message "+n.message),u=!0,c.callOnClose(new ru(i,o)),a.close()}else Ys(Uh,"WebChannel received:",e),c.callOnMessage(e)}}),setTimeout(function(){c.callOnOpen()},0),c},t.prototype.makeUrl=function(t){var e=jh[t];Zs(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},t}(),Gh=function(){function t(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(t.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),t.prototype.loadConnection=function(t){return Promise.resolve(new Kh(t))},t.prototype.newSerializer=function(t){return new Fh(t,{useProto3Json:!0})},t.prototype.formatJSON=function(t){return JSON.stringify(t)},t.prototype.atob=function(t){return atob(t)},t.prototype.btoa=function(t){return btoa(t)},t}();tu.setPlatform(new Gh);var Wh,zh=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}return t.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},t.INVALID=-1,t}(),Hh=function(){var t=this;this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n})};!function(t){t.All="all",t.ListenStreamIdle="listen_stream_idle",t.ListenStreamConnectionBackoff="listen_stream_connection_backoff",t.WriteStreamIdle="write_stream_idle",t.WriteStreamConnectionBackoff="write_stream_connection_backoff",t.OnlineStateTimeout="online_state_timeout",t.ClientMetadataRefresh="client_metadata_refresh",t.LruGarbageCollection="lru_garbage_collection"}(Wh||(Wh={}));var Yh=function(){function t(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Hh,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}return t.createAndSchedule=function(e,n,r,i,o){var a=new t(e,n,Date.now()+r,i,o);return a.start(r),a},t.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new ru(nu.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget(function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then(function(e){return t.deferred.resolve(e)})):Promise.resolve()})},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}(),Xh=function(){function t(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueue=function(t){var e=this;this.verifyNotFailed();var n=this.tail.then(function(){return e.operationInProgress=!0,t().catch(function(t){e.failure=t,e.operationInProgress=!1;var n=t.stack||t.message||"";throw t("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return e.operationInProgress=!1,t})});return this.tail=n,n},t.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Zs(e>=0,"Attempted to schedule an operation with a negative delay of "+e),Zs(!this.containsDelayedOperation(t),"Attempted to schedule multiple operations with timer id "+t+".");var i=Yh.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},t.prototype.verifyNotFailed=function(){this.failure&&$s("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},t.prototype.verifyOperationInProgress=function(){Zs(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},t.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},t.prototype.runDelayedOperationsEarly=function(t){var e=this;return this.drain().then(function(){Zs(t===Wh.All||e.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),e.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var n=0,r=e.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),t!==Wh.All&&i.timerId===t)break}return e.drain()})},t.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);Zs(e>=0,"Delayed operation not found."),this.delayedOperations.splice(e,1)},t}(),Jh="",$h="",Zh="",tl="";function el(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=rl(e)),e=nl(t.get(n),e);return rl(e)}function nl(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Jh+Zh;break;case Jh:n+=Jh+tl;break;default:n+=o}}return n}function rl(t){return t+Jh+$h}function il(t){var e=t.length;if(Zs(e>=2,"Invalid path "+t),2===e)return Zs(t.charAt(0)===Jh&&t.charAt(1)===$h,"Non-empty path "+t+" had length 2"),Qu.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Jh,o);switch((a<0||a>n)&&$s('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case $h:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case Zh:i+=t.substring(o,a),i+="\0";break;case tl:i+=t.substring(o,a+1);break;default:$s('Invalid encoded resource path: "'+t+'"')}o=a+2}return new Qu(r)}var ol=function(){function t(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r,Zs(r.length>0,"Cannot create an empty mutation batch")}return t.prototype.applyToRemoteDocument=function(t,e,n){e&&Zs(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Zs(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];o.key.isEqual(t)&&(e=o.applyToRemoteDocument(e,r[i]))}return e},t.prototype.applyToLocalView=function(t,e){e&&Zs(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime));for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},t.prototype.applyToLocalDocumentSet=function(t){var e=this,n=t;return this.mutations.forEach(function(r){var i=e.applyToLocalView(r.key,t.get(r.key));i&&(n=n.insert(r.key,i))}),n},t.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},ph())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&ku(this.mutations,t.mutations)&&ku(this.baseMutations,t.baseMutations)},t}(),al=function(){function t(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return t.from=function(e,n,r,i){Zs(e.mutations.length===r.length,"Mutations sent "+e.mutations.length+" must equal results received "+r.length);for(var o=lh(),a=e.mutations,s=0;s<a.length;s++)o=o.insert(a[s].key,r[s].version);return new t(e,n,r,i,o)},t}(),sl=function(){function t(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.callbackAttached&&$s("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(e,this.result):new t(function(t,i){r.nextCallback=function(n){r.wrapSuccess(e,n).next(t,i)},r.catchCallback=function(e){r.wrapFailure(n,e).next(t,i)}})},t.prototype.toPromise=function(){var t=this;return new Promise(function(e,n){t.next(e,n)})},t.prototype.wrapUserFunction=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.wrapSuccess=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.resolve(n)},t.prototype.wrapFailure=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.reject(n)},t.resolve=function(e){return new t(function(t,n){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.waitFor=function(e){return new t(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(t){return n(t)})}),o=!0,i===r&&t()})},t.or=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next(function(n){return n?t.resolve(n):e()})},i=0,o=e;i<o.length;i++)r(o[i]);return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach(function(t,i){r.push(e.call(n,t,i))}),this.waitFor(r)},t}(),ul=function(){function t(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}return t.forUser=function(e,n,r,i){return Zs(""!==e.uid,"UserID must not be an empty string."),new t(e.isAuthenticated()?e.uid:"",n,r,i)},t.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return fl(t).iterate({index:Gl.userMutationsIndex,range:n},function(t,n,r){e=!1,r.done()}).next(function(){return e})},t.prototype.acknowledgeBatch=function(t,e,n){return this.getMutationQueueMetadata(t).next(function(e){return e.lastStreamToken=ll(n),dl(t).put(e)})},t.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},t.prototype.setLastStreamToken=function(t,e){return this.getMutationQueueMetadata(t).next(function(n){return n.lastStreamToken=ll(e),dl(t).put(n)})},t.prototype.addMutationBatch=function(t,e,n,r){var i=this,o=pl(t),a=fl(t);return a.add({}).next(function(s){Zs("number"==typeof s,"Auto-generated key is not a number");var u=new ol(s,e,n,r),c=i.serializer.toDbMutationBatch(i.userId,u);i.documentKeysByBatchId[s]=u.keys();for(var h=[],l=0,f=r;l<f.length;l++){var p=f[l],d=Wl.key(i.userId,p.key.path,s);h.push(a.put(c)),h.push(o.put(d,Wl.PLACEHOLDER)),h.push(i.indexManager.addToCollectionParentIndex(t,p.key.path.popLast()))}return sl.waitFor(h).next(function(){return u})})},t.prototype.lookupMutationBatch=function(t,e){var n=this;return fl(t).get(e).next(function(t){return t?(Zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},t.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?sl.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){var r=t.keys();return n.documentKeysByBatchId[e]=r,r}return null})},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this;return this.getMutationQueueMetadata(t).next(function(r){var i=e+1,o=IDBKeyRange.lowerBound([n.userId,i]),a=null;return fl(t).iterate({index:Gl.userMutationsIndex,range:o},function(t,e,r){e.userId===n.userId&&(Zs(e.batchId>=i,"Should have found mutation after "+i),a=n.serializer.fromDbMutationBatch(e)),r.done()}).next(function(){return a})})},t.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return fl(t).loadAll(Gl.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=Wl.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return pl(t).iterate({range:i},function(r,i,a){var s=r[0],u=r[2],c=il(r[1]);if(s===n.userId&&e.path.isEqual(c))return fl(t).get(u).next(function(t){if(!t)throw $s("Dangling document-mutation reference found: "+r+" which points to "+u);Zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+u),o.push(n.serializer.fromDbMutationBatch(t))});a.done()}).next(function(){return o})},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Fc(Nu),i=[];return e.forEach(function(e){var o=Wl.prefixForPath(n.userId,e.path),a=IDBKeyRange.lowerBound(o),s=pl(t).iterate({range:a},function(t,i,o){var a=t[0],s=t[2],u=il(t[1]);a===n.userId&&e.path.isEqual(u)?r=r.add(s):o.done()});i.push(s)}),sl.waitFor(i).next(function(){return n.lookupMutationBatches(t,r)})},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this;Zs(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=e.path,i=r.length+1,o=Wl.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new Fc(Nu);return pl(t).iterate({range:a},function(t,e,o){var a=t[0],u=t[2],c=il(t[1]);a===n.userId&&r.isPrefixOf(c)?c.length===i&&(s=s.add(u)):o.done()}).next(function(){return n.lookupMutationBatches(t,s)})},t.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(fl(t).get(e).next(function(t){if(null===t)throw $s("Dangling document-mutation reference found, which points to "+e);Zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),sl.waitFor(i).next(function(){return r})},t.prototype.removeMutationBatch=function(t,e){var n=this;return hl(t.simpleDbTransaction,this.userId,e).next(function(r){return n.removeCachedMutationKeys(e.batchId),sl.forEach(r,function(e){return n.referenceDelegate.removeMutationReference(t,e)})})},t.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},t.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next(function(n){if(!n)return sl.resolve();var r=IDBKeyRange.lowerBound(Wl.prefixForUser(e.userId)),i=[];return pl(t).iterate({range:r},function(t,n,r){if(t[0]===e.userId){var o=il(t[1]);i.push(o)}else r.done()}).next(function(){Zs(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},t.prototype.containsKey=function(t,e){return cl(t,this.userId,e)},t.prototype.getMutationQueueMetadata=function(t){var e=this;return dl(t).get(this.userId).next(function(t){return t||new Kl(e.userId,-1,"")})},t}();function cl(t,e,n){var r=Wl.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return pl(t).iterate({range:o,keysOnly:!0},function(t,n,r){t[0]===e&&t[1]===i&&(a=!0),r.done()}).next(function(){return a})}function hl(t,e,n){var r=t.store(Gl.store),i=t.store(Wl.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(t,e,n){return s++,n.delete()});o.push(u.next(function(){Zs(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],p=Wl.key(e,f.key.path,n.batchId);o.push(i.delete(p)),c.push(f.key)}return sl.waitFor(o).next(function(){return c})}function ll(t){return t instanceof Uint8Array?(Zs("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function fl(t){return wf.getStore(t,Gl.store)}function pl(t){return wf.getStore(t,Wl.store)}function dl(t){return wf.getStore(t,Kl.store)}var ml,yl=1;!function(t){t[t.QueryCache=0]="QueryCache",t[t.SyncEngine=1]="SyncEngine"}(ml||(ml={}));var gl=function(){function t(t,e){this.generatorId=t,Zs((t&yl)===t,"Generator ID "+t+" contains more than "+yl+" reserved bits"),this.seek(void 0!==e?e:this.generatorId)}return t.prototype.next=function(){var t=this.nextId;return this.nextId+=1<<yl,t},t.prototype.after=function(t){return this.seek(t+(1<<yl)),this.next()},t.prototype.seek=function(t){Zs((t&yl)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},t.forQueryCache=function(){return new t(ml.QueryCache,2)},t.forSyncEngine=function(){return new t(ml.SyncEngine)},t}(),vl=function(){function t(t){this.db=t}return t.openOrCreate=function(e,n,r){return Zs(t.isAvailable(),"IndexedDB not supported in current environment."),Ys("SimpleDb","Opening database:",e),new sl(function(i,o){var a=window.indexedDB.open(e,n);a.onsuccess=function(e){i(new t(e.target.result))},a.onblocked=function(){o(new ru(nu.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},a.onerror=function(t){var e=t.target.error;o("VersionError"===e.name?new ru(nu.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):e)},a.onupgradeneeded=function(t){Ys("SimpleDb",'Database "'+e+'" requires upgrade from version:',t.oldVersion);var n=t.target.result,i=new wl(a.transaction);r.createOrUpgrade(n,i,t.oldVersion,Vl).next(function(){Ys("SimpleDb","Database upgrade to version "+Vl+" complete")})}}).toPromise()},t.delete=function(t){return Ys("SimpleDb","Removing database:",t),El(window.indexedDB.deleteDatabase(t)).toPromise()},t.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent,n=t.getIOSVersion(e),r=0<n&&n<10,i=t.getAndroidVersion(e),o=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||o)},t.getStore=function(t,e){return t.store(e)},t.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_")[0]:"-1";return Number(n)},t.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.runTransaction=function(t,e,n){var r=wl.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),sl.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},t.prototype.close=function(){this.db.close()},t}(),bl=function(){function t(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.shouldStop=!0},t.prototype.skip=function(t){this.nextKey=t},t.prototype.delete=function(){return El(this.dbCursor.delete())},t}(),wl=function(){function t(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Hh,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){e.completionDeferred.reject(t.target.error)}}return t.open=function(e,n,r){return new t(e.transaction(r,n))},Object.defineProperty(t.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(Ys("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return Zs(!!e,"Object store not part of transaction: "+t),new Sl(e)},t}(),Sl=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(Ys("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Ys("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),El(n)},t.prototype.add=function(t){return Ys("SimpleDb","ADD",this.store.name,t,t),El(this.store.add(t))},t.prototype.get=function(t){var e=this;return El(this.store.get(t)).next(function(n){return void 0===n&&(n=null),Ys("SimpleDb","GET",e.store.name,t,n),n})},t.prototype.delete=function(t){return Ys("SimpleDb","DELETE",this.store.name,t),El(this.store.delete(t))},t.prototype.count=function(){return Ys("SimpleDb","COUNT",this.store.name),El(this.store.count())},t.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},t.prototype.deleteAll=function(t,e){Ys("SimpleDb","DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},t.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},t.prototype.iterateSerial=function(t){var e=this.cursor({});return new sl(function(n,r){e.onerror=function(t){r(t.target.error)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next(function(t){t?r.continue():n()}):n()}})},t.prototype.iterateCursor=function(t,e){var n=[];return new sl(function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new bl(i),a=e(i.primaryKey,i.value,o);if(a instanceof sl){var s=a.catch(function(t){return o.done(),sl.reject(t)});n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}}).next(function(){return sl.waitFor(n)})},t.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Zs(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}();function El(t){return new sl(function(e,n){t.onsuccess=function(t){e(t.target.result)},t.onerror=function(t){n(t.target.error)}})}var Tl=function(){function t(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=gl.forQueryCache()}return t.prototype.allocateTargetId=function(t){var e=this;return this.retrieveMetadata(t).next(function(n){return n.highestTargetId=e.targetIdGenerator.after(n.highestTargetId),e.saveMetadata(t,n).next(function(){return n.highestTargetId})})},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return xc.fromTimestamp(new Fu(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},t.prototype.getHighestSequenceNumber=function(t){return Dl(t.simpleDbTransaction)},t.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.retrieveMetadata(t).next(function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.saveMetadata(t,i)})},t.prototype.addQueryData=function(t,e){var n=this;return this.saveQueryData(t,e).next(function(){return n.retrieveMetadata(t).next(function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(e,r),n.saveMetadata(t,r)})})},t.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},t.prototype.removeQueryData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next(function(){return Il(t).delete(e.targetId)}).next(function(){return n.retrieveMetadata(t)}).next(function(e){return Zs(e.targetCount>0,"Removing from an empty query cache"),e.targetCount-=1,n.saveMetadata(t,e)})},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return Il(t).iterate(function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=e&&void 0===n[u.targetId]&&(i++,o.push(r.removeQueryData(t,u)))}).next(function(){return sl.waitFor(o)}).next(function(){return i})},t.prototype.forEachTarget=function(t,e){var n=this;return Il(t).iterate(function(t,r){var i=n.serializer.fromDbTarget(r);e(i)})},t.prototype.retrieveMetadata=function(t){return Cl(t.simpleDbTransaction)},t.prototype.saveMetadata=function(t,e){return(n=t,wf.getStore(n,Zl.store)).put(Zl.key,e);var n},t.prototype.saveQueryData=function(t,e){return Il(t).put(this.serializer.toDbTarget(e))},t.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},t.prototype.getQueryData=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return Il(t).iterate({range:i,index:Jl.queryTargetsIndexName},function(t,r,i){var a=n.serializer.fromDbTarget(r);e.isEqual(a.query)&&(o=a,i.done())}).next(function(){return o})},t.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=Al(t);return e.forEach(function(e){var a=el(e.path);i.push(o.put(new $l(n,a))),i.push(r.referenceDelegate.addReference(t,e))}),sl.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=Al(t);return sl.forEach(e,function(e){var o=el(e.path);return sl.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,e)])})},t.prototype.removeMatchingKeysForTargetId=function(t,e){var n=Al(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=Al(t),i=ph();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=il(t[1]),o=new Wu(r);i=i.add(o)}).next(function(){return i})},t.prototype.containsKey=function(t,e){var n=el(e.path),r=IDBKeyRange.bound([n],[Ou(n)],!1,!0),i=0;return Al(t).iterate({index:$l.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){0!==t[0]&&(i++,n.done())}).next(function(){return i>0})},t.prototype.getQueryDataForTarget=function(t,e){var n=this;return Il(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},t}();function Il(t){return wf.getStore(t,Jl.store)}function Cl(t){return vl.getStore(t,Zl.store).get(Zl.key).next(function(t){return Zs(null!==t,"Missing metadata row."),t})}function Dl(t){return Cl(t).next(function(t){return t.highestListenSequenceNumber})}function Al(t){return wf.getStore(t,$l.store)}var Nl=function(){function t(t){this.mapKeyFn=t,this.inner={}}return t.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[1];if(o[0].isEqual(t))return a}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){uu(this.inner,function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r];t(o[0],o[1])}})},t.prototype.isEmpty=function(){return cu(this.inner)},t}(),kl=function(){function t(){this.changes=ah(),this.documentSizes=new Nl(function(t){return t.toString()})}return t.prototype.addEntry=function(t){var e=this.assertChanges();this.changes=e.insert(t.key,t)},t.prototype.getEntry=function(t,e){var n=this,r=this.assertChanges().get(e);return r?sl.resolve(r):this.getFromCache(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},t.prototype.getEntries=function(t,e){var n=this;return this.getAllFromCache(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},t.prototype.apply=function(t){var e=this.applyChanges(t);return this.changes=null,e},t.prototype.assertChanges=function(){return Zs(null!==this.changes,"Changes have already been applied."),this.changes},t}(),Ol="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Rl=function(){function t(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(t.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var e=vl.getStore(t,nf.store);return this.synchronizeLastDocumentChangeId(e)},t.prototype.addEntries=function(t,e,n){var r=[];if(e.length>0){for(var i=Pl(t),o=ph(),a=0,s=e;a<s.length;a++){var u=s[a],c=u.key,h=u.doc;r.push(i.put(Ll(c),h)),o=o.add(c),r.push(this.indexManager.addToCollectionParentIndex(t,c.path.popLast()))}this.keepDocumentChangeLog&&r.push(xl(t).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(t,n))}return sl.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=Pl(t),r=Ll(e);return n.get(r).next(function(t){return t?n.delete(r).next(function(){return ql(t)}):sl.resolve(0)})},t.prototype.getEntry=function(t,e){var n=this;return Pl(t).get(Ll(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},t.prototype.getSizedEntry=function(t,e){var n=this;return Pl(t).get(Ll(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:ql(t)}:null})},t.prototype.getEntries=function(t,e){var n=this,r=sh();return this.forEachDbEntry(t,e,function(t,e){r=r.insert(t,e?n.serializer.fromDbRemoteDocument(e):null)}).next(function(){return r})},t.prototype.getSizedEntries=function(t,e){var n=this,r=sh(),i=new Ju(Wu.comparator);return this.forEachDbEntry(t,e,function(t,e){e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i=i.insert(t,ql(e))):(r=r.insert(t,null),i=i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},t.prototype.forEachDbEntry=function(t,e,n){if(e.isEmpty())return sl.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return Pl(t).iterate({range:r},function(t,e,r){for(var a=Wu.fromSegments(t);o&&Wu.comparator(o,a)<0;)n(o,null),o=i.getNext();o&&o.isEqual(a)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()}).next(function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})},t.prototype.getDocumentsMatchingQuery=function(t,e){var n=this;Zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=ch(),i=e.path.length+1,o=e.path.toArray(),a=IDBKeyRange.lowerBound(o);return Pl(t).iterate({range:a},function(t,o,a){if(t.length===i){var s=n.serializer.fromDbRemoteDocument(o);e.path.isPrefixOf(s.key.path)?s instanceof Hu&&e.matches(s)&&(r=r.insert(s.key,s)):a.done()}}).next(function(){return r})},t.prototype.getNewDocumentChanges=function(t){var e=this;Zs(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=ph(),r=ah(),i=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,a=xl(t);return a.iterate({range:i},function(t,r){if(o&&(o=!1,e._lastProcessedDocumentChangeId+1!==r.id))return e.synchronizeLastDocumentChangeId(a).next(function(){return sl.reject(new ru(nu.DATA_LOSS,Ol))});n=n.unionWith(e.serializer.fromDbResourcePaths(r.changes)),e._lastProcessedDocumentChangeId=r.id}).next(function(){var i=[];return n.forEach(function(n){i.push(e.getEntry(t,n).next(function(t){var e=t||new Yu(n,xc.forDeletedDoc());r=r.insert(n,e)}))}),sl.waitFor(i)}).next(function(){return r})},t.prototype.removeDocumentChangesThroughChangeId=function(t,e){var n=IDBKeyRange.upperBound(e);return xl(t).delete(n)},t.prototype.synchronizeLastDocumentChangeId=function(t){var e=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,n,r){e._lastProcessedDocumentChangeId=t,r.done()})},t.prototype.newChangeBuffer=function(){return new Ml(this)},t.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},t.prototype.getMetadata=function(t){return _l(t).get(Xl.key).next(function(t){return Zs(!!t,"Missing document cache metadata"),t})},t.prototype.setMetadata=function(t,e){return _l(t).put(Xl.key,e)},t.prototype.updateSize=function(t,e){var n=this;return this.getMetadata(t).next(function(r){return r.byteSize+=e,n.setMetadata(t,r)})},t}();function _l(t){return wf.getStore(t,Xl.store)}var Ml=function(t){function e(e){var n=t.call(this)||this;return n.documentCache=e,n}return ar(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentCache.serializer.toDbRemoteDocument(n),a=e.documentSizes.get(t);Zs(void 0!==a,"Attempting to change document "+t.toString()+" without having read it first");var s=ql(o);r+=s-a,i.push({key:t,doc:o})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(kl);function Pl(t){return wf.getStore(t,Yl.store)}function xl(t){return wf.getStore(t,nf.store)}function Ll(t){return t.path.toArray()}function ql(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw $s("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var Fl=function(){function t(){this.collectionParentIndex=new Bl}return t.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),sl.resolve()},t.prototype.getCollectionParents=function(t,e){return sl.resolve(this.collectionParentIndex.getEntries(e))},t}(),Bl=function(){function t(){this.index={}}return t.prototype.add=function(t){Zs(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Fc(Qu.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},t.prototype.getEntries=function(t){return(this.index[t]||new Fc(Qu.comparator)).toArray()},t}(),Vl=8,Ul=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,e,n,r){var i=this;Zs(n<r&&n>=0&&r<=Vl,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&r>=1&&(function(t){t.createObjectStore(Ql.store)}(t),function(t){t.createObjectStore(Kl.store,{keyPath:Kl.keyPath}),t.createObjectStore(Gl.store,{keyPath:Gl.keyPath,autoIncrement:!0}).createIndex(Gl.userMutationsIndex,Gl.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Wl.store)}(t),ef(t),function(t){t.createObjectStore(Yl.store)}(t));var o=sl.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore($l.store),t.deleteObjectStore(Jl.store),t.deleteObjectStore(Zl.store)}(t),ef(t)),o=o.next(function(){return function(t){var e=t.store(Zl.store),n=new Zl(0,0,xc.MIN.toTimestamp(),0);return e.put(Zl.key,n)}(e)})),n<4&&r>=4&&(0!==n&&(o=o.next(function(){return function(t,e){return e.store(Gl.store).loadAll().next(function(n){t.deleteObjectStore(Gl.store),t.createObjectStore(Gl.store,{keyPath:Gl.keyPath,autoIncrement:!0}).createIndex(Gl.userMutationsIndex,Gl.userMutationsKeyPath,{unique:!0});var r=e.store(Gl.store),i=n.map(function(t){return r.put(t)});return sl.waitFor(i)})}(t,e)})),o=o.next(function(){!function(t){t.createObjectStore(rf.store,{keyPath:rf.keyPath})}(t),function(t){t.createObjectStore(nf.store,{keyPath:"id",autoIncrement:!0})}(t)})),n<5&&r>=5&&(o=o.next(function(){return i.removeAcknowledgedMutations(e)})),n<6&&r>=6&&(o=o.next(function(){return function(t){t.createObjectStore(Xl.store)}(t),i.addDocumentGlobal(e)})),n<7&&r>=7&&(o=o.next(function(){return i.ensureSequenceNumbers(e)})),n<8&&r>=8&&(o=o.next(function(){return i.createCollectionParentIndex(t,e)})),o},t.prototype.addDocumentGlobal=function(t){var e=0;return t.store(Yl.store).iterate(function(t,n){e+=ql(n)}).next(function(){var n=new Xl(e);return t.store(Xl.store).put(Xl.key,n)})},t.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(Kl.store),r=t.store(Gl.store);return n.loadAll().next(function(n){return sl.forEach(n,function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(Gl.userMutationsIndex,i).next(function(r){return sl.forEach(r,function(r){Zs(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.fromDbMutationBatch(r);return hl(t,n.userId,i).next(function(){})})})})})},t.prototype.ensureSequenceNumbers=function(t){var e=t.store($l.store),n=t.store(Yl.store);return Dl(t).next(function(t){var r=[];return n.iterate(function(n,i){var o=new Qu(n),a=function(t){return[0,el(t)]}(o);r.push(e.get(a).next(function(n){return n?sl.resolve():function(n){return e.put(new $l(0,el(n),t))}(o)}))}).next(function(){return sl.waitFor(r)})})},t.prototype.createCollectionParentIndex=function(t,e){t.createObjectStore(tf.store,{keyPath:tf.keyPath});var n=e.store(tf.store),r=new Bl,i=function(t){if(r.add(t)){var e=t.lastSegment(),i=t.popLast();return n.put({collectionId:e,parent:el(i)})}};return e.store(Yl.store).iterate({keysOnly:!0},function(t,e){var n=new Qu(t);return i(n.popLast())}).next(function(){return e.store(Wl.store).iterate({keysOnly:!0},function(t,e){var n=il(t[1]);return i(n.popLast())})})},t}(),jl=function(t,e){this.seconds=t,this.nanoseconds=e},Ql=function(){function t(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}return t.store="owner",t.key="owner",t}(),Kl=function(){function t(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}return t.store="mutationQueues",t.keyPath="userId",t}(),Gl=function(){function t(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}(),Wl=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,el(e)]},t.key=function(t,e,n){return[t,el(e),n]},t.store="documentMutations",t.PLACEHOLDER=new t,t}(),zl=function(t,e){this.path=t,this.readTime=e},Hl=function(t,e){this.path=t,this.version=e},Yl=function(){function t(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}return t.store="remoteDocuments",t}(),Xl=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}(),Jl=function(){function t(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),$l=function(){function t(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n,Zs(0===t==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),Zl=function(){function t(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),tf=function(){function t(t,e){this.collectionId=t,this.parent=e}return t.store="collectionParents",t.keyPath=["collectionId","parent"],t}();function ef(t){t.createObjectStore($l.store,{keyPath:$l.keyPath}).createIndex($l.documentTargetsIndex,$l.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Jl.store,{keyPath:Jl.keyPath}).createIndex(Jl.queryTargetsIndexName,Jl.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Zl.store)}var nf=function(){function t(t){this.changes=t}return t.store="remoteDocumentChanges",t.keyPath="id",t}(),rf=function(){function t(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}return t.store="clientMetadata",t.keyPath="clientId",t}(),of=[Kl.store,Gl.store,Wl.store,Yl.store,Jl.store,Ql.store,Zl.store,$l.store].concat([rf.store,nf.store]).concat([Xl.store]).concat([tf.store]),af=function(){function t(){this.collectionParentsCache=new Bl}return t.prototype.addToCollectionParentIndex=function(t,e){if(Zs(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){Zs(e.length>=1,"Invalid collection path.");var n=e.lastSegment(),r=e.popLast();return sf(t).put({collectionId:n,parent:el(r)})}return sl.resolve()},t.prototype.getCollectionParents=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[Ou(e),""],!1,!0);return sf(t).loadAll(r).next(function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r];if(o.collectionId!==e)break;n.push(il(o.parent))}return n})},t}();function sf(t){return wf.getStore(t,tf.store)}var uf=function(){function t(t){this.remoteSerializer=t}return t.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Wu.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new Yu(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Wu.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new Xu(e,n)):$s("Unexpected DbRemoteDocument")},t.prototype.toDbRemoteDocument=function(t){if(t instanceof Hu){var e=t.proto?t.proto:this.remoteSerializer.toDocument(t);return new Yl(null,null,e,i=t.hasCommittedMutations)}if(t instanceof Yu){var n=t.key.path.toArray(),r=this.toDbTimestamp(t.version),i=t.hasCommittedMutations;return new Yl(null,new zl(n,r),null,i)}return t instanceof Xu?(n=t.key.path.toArray(),r=this.toDbTimestamp(t.version),new Yl(new Hl(n,r),null,null,!0)):$s("Unexpected MaybeDocumment")},t.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new jl(e.seconds,e.nanoseconds)},t.prototype.fromDbTimestamp=function(t){var e=new Fu(t.seconds,t.nanoseconds);return xc.fromTimestamp(e)},t.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new Gl(t,e.batchId,e.localWriteTime.toMillis(),r,i)},t.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=Fu.fromMillis(t.localWriteTimeMs);return new ol(t.batchId,i,n,r)},t.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(el(t.path))}),e},t.prototype.fromDbResourcePaths=function(t){for(var e=ph(),n=0,r=t;n<r.length;n++)e=e.add(new Wu(il(r[n])));return e},t.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime);return e=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new qc(e,t.targetId,Tc.Listen,t.lastListenSequenceNumber,n,t.resumeToken)},t.prototype.toDbTarget=function(t){Zs(Tc.Listen===t.purpose,"Only queries with purpose "+Tc.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion);return e=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),t.resumeToken instanceof Uint8Array?(Zs("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),n=t.resumeToken.toString()):n=t.resumeToken,new Jl(t.targetId,t.query.canonicalId(),r,n,t.sequenceNumber,e)},t}();function cf(t,e){var n=t[1],r=e[1],i=Nu(t[0],e[0]);return 0===i?Nu(n,r):i}var hf=function(){function t(t){this.maxElements=t,this.buffer=new Fc(cf),this.previousIndex=0}return t.prototype.nextIndex=function(){return++this.previousIndex},t.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();cf(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),lf={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},ff=function(){function t(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}return t.withCacheSize=function(e){return new t(e,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t.COLLECTION_DISABLED=-1,t.MINIMUM_CACHE_SIZE_BYTES=1048576,t.DEFAULT=new t(t.DEFAULT_CACHE_SIZE_BYTES=41943040,t.DEFAULT_COLLECTION_PERCENTILE=10,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),t.DISABLED=new t(t.COLLECTION_DISABLED,0,0),t}(),pf=function(){function t(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.gcTask=null}return t.prototype.start=function(){Zs(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==ff.COLLECTION_DISABLED&&this.scheduleGC()},t.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),t.prototype.scheduleGC=function(){var t=this;Zs(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;Ys("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Wh.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(Sf)})},t}(),df=function(){function t(t,e){this.delegate=t,this.params=e}return t.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},t.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return sl.resolve(zh.INVALID);var r=new hf(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},t.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},t.prototype.collect=function(t,e){var n=this;return this.params.cacheSizeCollectionThreshold===ff.COLLECTION_DISABLED?(Ys("LruGarbageCollector","Garbage collection skipped; disabled"),sl.resolve(lf)):this.getCacheSize(t).next(function(r){return r<n.params.cacheSizeCollectionThreshold?(Ys("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),lf):n.runGarbageCollection(t,e)})},t.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},t.prototype.runGarbageCollection=function(t,e){var n,r,i,o,a,s,u,c,h=this;return o=Date.now(),this.calculateTargetCount(t,this.params.percentileToCollect).next(function(e){return e>h.params.maximumSequenceNumbersToCollect?(Ys("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+e),r=h.params.maximumSequenceNumbersToCollect):r=e,a=Date.now(),h.nthSequenceNumber(t,r)}).next(function(r){return n=r,s=Date.now(),h.removeTargets(t,n,e)}).next(function(e){return i=e,u=Date.now(),h.removeOrphanedDocuments(t,n)}).next(function(t){return c=Date.now(),zs()<=qs.DEBUG&&Ys("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-o)+"ms\n\tDetermined least recently used "+r+" in "+(s-a)+"ms\n\tRemoved "+i+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-o)+"ms"),sl.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:t})})},t}(),mf="IndexedDbPersistence",yf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",gf="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",vf="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",bf=function(t){function e(e,n){var r=t.call(this)||this;return r.simpleDbTransaction=e,r.currentSequenceNumber=n,r}return ar(e,t),e}(function(){}),wf=function(){function t(e,n,r,i,o,a,s){if(this.persistenceKey=e,this.clientId=n,this.queue=i,this.multiClientParams=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},!t.isAvailable())throw new ru(nu.UNIMPLEMENTED,vf);if(this.referenceDelegate=new If(this,a),this.dbName=e+t.MAIN_DATABASE,this.serializer=new uf(o),this.document=r.document,this.allowTabSynchronization=void 0!==s,this.queryCache=new Tl(this.referenceDelegate,this.serializer),this.indexManager=new af,this.remoteDocumentCache=new Rl(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new ru(nu.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}return t.getStore=function(t,e){if(t instanceof bf)return vl.getStore(t.simpleDbTransaction,e);throw $s("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.createIndexedDbPersistence=function(e,n,r,i,o,a){return ur(this,void 0,void 0,function(){var s;return cr(this,function(u){switch(u.label){case 0:return[4,(s=new t(e,n,r,i,o,a)).start()];case 1:return u.sent(),[2,s]}})})},t.createMultiClientIndexedDbPersistence=function(e,n,r,i,o,a,s){return ur(this,void 0,void 0,function(){var u;return cr(this,function(c){switch(c.label){case 0:return[4,(u=new t(e,n,r,i,o,a,s)).start()];case 1:return c.sent(),[2,u]}})})},t.prototype.start=function(){var t=this;return Zs(!this.started,"IndexedDbPersistence double-started!"),Zs(null!==this.window,"Expected 'window' to be defined"),vl.openOrCreate(this.dbName,Vl,new Ul(this.serializer)).then(function(e){return t.simpleDb=e,t.updateClientMetadataAndTryBecomePrimary()}).then(function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.startRemoteDocumentCache()}).then(function(){return t.simpleDb.runTransaction("readonly",[Zl.store],function(e){return Dl(e).next(function(e){t.listenSequence=new zh(e,t.multiClientParams?t.multiClientParams.sequenceNumberSyncer:void 0)})})}).then(function(){t._started=!0}).catch(function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)})},t.prototype.startRemoteDocumentCache=function(){var t=this;return this.simpleDb.runTransaction("readonly",of,function(e){return t.remoteDocumentCache.start(e)})},t.prototype.setPrimaryStateListener=function(t){var e=this;return this.primaryStateListener=function(n){return ur(e,void 0,void 0,function(){return cr(this,function(e){return this.started?[2,t(n)]:[2]})})},t(this.isPrimary)},t.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return ur(e,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},t.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",of,function(e){return Tf(e).put(new rf(t.clientId,Date.now(),t.networkEnabled,t.inForeground,t.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(t.isPrimary)return t.verifyPrimaryLease(e).next(function(e){e||(t.isPrimary=!1,t.queue.enqueueAndForget(function(){return t.primaryStateListener(!1)}))})}).next(function(){return t.canActAsPrimary(e)}).next(function(n){var r=t.isPrimary;return t.isPrimary=n,r!==t.isPrimary&&t.queue.enqueueAndForget(function(){return t.primaryStateListener(t.isPrimary)}),r&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(e):t.isPrimary?t.acquireOrExtendPrimaryLease(e):void 0})})},t.prototype.verifyPrimaryLease=function(t){var e=this;return Ef(t).get(Ql.key).next(function(t){return sl.resolve(e.isLocalClient(t))})},t.prototype.removeClientMetadata=function(t){return Tf(t).delete(this.clientId)},t.prototype.maybeGarbageCollectMultiClientState=function(){return ur(this,void 0,void 0,function(){var e,n,r=this;return cr(this,function(i){switch(i.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),n=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(i){var o=t.getStore(i,rf.store);return o.loadAll().next(function(t){e=r.filterActiveClients(t,18e5),n=t.filter(function(t){return-1===e.indexOf(t)})}).next(function(){return sl.forEach(n,function(t){return o.delete(t.clientId)})}).next(function(){if((e=e.filter(function(t){return t.clientId!==r.clientId})).length>0){var t=e.map(function(t){return t.lastProcessedDocumentChangeId||0}),n=Math.min.apply(Math,t);return r.remoteDocumentCache.removeDocumentChangesThroughChangeId(i,n)}})})]);case 1:i.sent(),n.forEach(function(t){r.window.localStorage.removeItem(r.zombiedClientLocalStorageKey(t.clientId))}),i.label=2;case 2:return[2]}})})},t.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Wh.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},t.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.canActAsPrimary=function(t){var e=this;return Ef(t).get(Ql.key).next(function(n){if(null!==n&&e.isWithinAge(n.leaseTimestampMs,5e3)&&!e.isClientZombied(n.ownerId)){if(e.isLocalClient(n)&&e.networkEnabled)return!0;if(!e.isLocalClient(n)){if(!n.allowTabSynchronization)throw new ru(nu.FAILED_PRECONDITION,gf);return!1}}return!(!e.networkEnabled||!e.inForeground)||Tf(t).loadAll().next(function(t){return void 0===e.filterActiveClients(t,5e3).find(function(t){return!(e.clientId===t.clientId||!(!e.networkEnabled&&t.networkEnabled||!e.inForeground&&t.inForeground&&e.networkEnabled===t.networkEnabled))})})}).next(function(t){return e.isPrimary!==t&&Ys(mf,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},t.prototype.shutdown=function(){return ur(this,void 0,void 0,function(){var t=this;return cr(this,function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[Ql.store,rf.store],function(e){return t.releasePrimaryLeaseIfHeld(e).next(function(){return t.removeClientMetadata(e)})})];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},t.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},t.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly",[rf.store],function(e){return Tf(e).loadAll().next(function(e){return t.filterActiveClients(e,18e5).map(function(t){return t.clientId})})})},t.clearPersistence=function(e){return ur(this,void 0,void 0,function(){return cr(this,function(n){switch(n.label){case 0:return t.isAvailable()?[4,vl.delete(e+t.MAIN_DATABASE)]:[2,Promise.resolve()];case 1:return n.sent(),[2]}})})},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getMutationQueue=function(t){return Zs(this.started,"Cannot initialize MutationQueue before persistence is started."),ul.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},t.prototype.getQueryCache=function(){return Zs(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},t.prototype.getRemoteDocumentCache=function(){return Zs(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},t.prototype.getIndexManager=function(){return Zs(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},t.prototype.runTransaction=function(t,e,n){var r=this;return Ys(mf,"Starting transaction:",t),this.simpleDb.runTransaction("readonly"===e?"readonly":"readwrite",of,function(i){return"readwrite-primary"===e?r.verifyPrimaryLease(i).next(function(e){if(!e)throw Xs("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new ru(nu.FAILED_PRECONDITION,yf);return n(new bf(i,r.listenSequence.next()))}).next(function(t){return r.acquireOrExtendPrimaryLease(i).next(function(){return t})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new bf(i,r.listenSequence.next()))})})},t.prototype.verifyAllowTabSynchronization=function(t){var e=this;return Ef(t).get(Ql.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new ru(nu.FAILED_PRECONDITION,gf)})},t.prototype.acquireOrExtendPrimaryLease=function(t){var e=new Ql(this.clientId,this.allowTabSynchronization,Date.now());return Ef(t).put(Ql.key,e)},t.isAvailable=function(){return vl.isAvailable()},t.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},t.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=Ef(t);return n.get(Ql.key).next(function(t){return e.isLocalClient(t)?(Ys(mf,"Releasing primary lease."),n.delete(Ql.key)):sl.resolve()})},t.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||t>n&&(Xs("Detected an update time that is in the future: "+t+" > "+n),1))},t.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},t.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Zs(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},t.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},t.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Zs("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},t.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return Ys(mf,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return Xs(mf,"Failed to get zombied client id.",t),!1}},t.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){Xs("Failed to set zombie client id.",t)}},t.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},t.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t.MAIN_DATABASE="main",t}();function Sf(t){return ur(this,void 0,void 0,function(){return cr(this,function(e){if(!function(t){return t.code===nu.FAILED_PRECONDITION&&t.message===yf}(t))throw t;return Ys(mf,"Unexpectedly lost primary lease"),[2]})})}function Ef(t){return t.store(Ql.store)}function Tf(t){return t.store(rf.store)}var If=function(){function t(t,e){this.db=t,this.garbageCollector=new df(this,e)}return t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){return this.forEachOrphanedDocument(t,function(t,n){return e(n)})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return Cf(t,e)},t.prototype.removeReference=function(t,e){return Cf(t,e)},t.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},t.prototype.removeMutationReference=function(t,e){return Cf(t,e)},t.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?sl.resolve(!0):function(t,e){var n=!1;return dl(t).iterateSerial(function(r){return cl(t,r,e).next(function(t){return t&&(n=!0),sl.resolve(!t)})}).next(function(){return n})}(t,e)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=0,o=[];return this.forEachOrphanedDocument(t,function(a,s){if(s<=e){var u=n.isPinned(t,a).next(function(e){if(!e)return r++,n.removeOrphanedDocument(t,a).next(function(t){i+=t})});o.push(u)}}).next(function(){return sl.waitFor(o)}).next(function(){return n.db.getRemoteDocumentCache().updateSize(t,-i)}).next(function(){return r})},t.prototype.removeOrphanedDocument=function(t,e){var n,r=0,i=this.db.getRemoteDocumentCache();return sl.waitFor([Al(t).delete((n=e,[0,el(n.path)])),i.removeEntry(t,e).next(function(t){r+=t})]).next(function(){return r})},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(t,n)},t.prototype.updateLimboDocument=function(t,e){return Cf(t,e)},t.prototype.forEachOrphanedDocument=function(t,e){var n,r=Al(t),i=zh.INVALID;return r.iterate({index:$l.documentTargetsIndex},function(t,r){var o=r.path,a=r.sequenceNumber;0===t[0]?(i!==zh.INVALID&&e(new Wu(il(n)),i),i=a,n=o):i=zh.INVALID}).next(function(){i!==zh.INVALID&&e(new Wu(il(n)),i)})},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}();function Cf(t,e){return Al(t).put(function(t,e){return new $l(0,el(t.path),e)}(e,t.currentSequenceNumber))}var Df,Af=function(){function t(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}return t.prototype.getDocument=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,e).next(function(r){return n.getDocumentInternal(t,e,r)})},t.prototype.getDocumentInternal=function(t,e,n){return this.remoteDocumentCache.getEntry(t,e).next(function(t){for(var r=0,i=n;r<i.length;r++)t=i[r].applyToLocalView(e,t);return t})},t.prototype.applyLocalMutationsToDocuments=function(t,e,n){var r=sh();return e.forEach(function(t,e){for(var i=0,o=n;i<o.length;i++)e=o[i].applyToLocalView(t,e);r=r.insert(t,e)}),r},t.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next(function(e){return n.getLocalViewOfDocuments(t,e)})},t.prototype.getLocalViewOfDocuments=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(function(r){var i=n.applyLocalMutationsToDocuments(t,e,r),o=ah();return i.forEach(function(t,e){e||(e=new Yu(t,xc.forDeletedDoc())),o=o.insert(t,e)}),o})},t.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},t.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Wu(e)).next(function(t){var e=ch();return t instanceof Hu&&(e=e.insert(t.key,t)),e})},t.prototype.getDocumentsMatchingCollectionGroupQuery=function(t,e){var n=this;Zs(e.path.isEmpty(),"Currently we only support collection group queries at the root.");var r=e.collectionGroup,i=ch();return this.indexManager.getCollectionParents(t,r).next(function(o){return sl.forEach(o,function(o){var a=e.asCollectionQueryAtPath(o.child(r));return n.getDocumentsMatchingCollectionQuery(t,a).next(function(t){t.forEach(function(t,e){i=i.insert(t,e)})})}).next(function(){return i})})},t.prototype.getDocumentsMatchingCollectionQuery=function(t,e){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,e).next(function(i){return n=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,e)}).next(function(t){for(var r=0,i=t;r<i.length;r++)for(var o=i[r],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key;if(e.path.isImmediateParentOf(c.path)){var h=n.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);n=l instanceof Hu?n.insert(c,l):n.remove(c)}}}).next(function(){return n.forEach(function(t,r){e.matches(r)||(n=n.remove(t))}),n})},t}(),Nf=function(){function t(){this.refsByKey=new Fc(kf.compareByKey),this.refsByTarget=new Fc(kf.compareByTargetId)}return t.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},t.prototype.addReference=function(t,e){var n=new kf(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},t.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},t.prototype.removeReference=function(t,e){this.removeRef(new kf(t,e))},t.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},t.prototype.removeReferencesForId=function(t){var e=this,n=Wu.EMPTY,r=new kf(n,t),i=new kf(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},t.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach(function(e){return t.removeRef(e)})},t.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},t.prototype.referencesForId=function(t){var e=Wu.EMPTY,n=new kf(e,t),r=new kf(e,t+1),i=ph();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},t.prototype.containsKey=function(t){var e=new kf(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},t}(),kf=function(){function t(t,e){this.key=t,this.targetOrBatchId=e}return t.compareByKey=function(t,e){return Wu.comparator(t.key,e.key)||Nu(t.targetOrBatchId,e.targetOrBatchId)},t.compareByTargetId=function(t,e){return Nu(t.targetOrBatchId,e.targetOrBatchId)||Wu.comparator(t.key,e.key)},t}(),Of=function(){function t(t,e){this.persistence=t,this.localViewReferences=new Nf,this.queryDataByTarget={},Zs(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new Af(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return t.prototype.handleUserChange=function(t){var e=this;return this.persistence.runTransaction("Handle user change","readonly",function(n){var r;return e.mutationQueue.getAllMutationBatches(n).next(function(i){return r=i,e.mutationQueue=e.persistence.getMutationQueue(t),e.localDocuments=new Af(e.remoteDocuments,e.mutationQueue,e.persistence.getIndexManager()),e.mutationQueue.getAllMutationBatches(n)}).next(function(t){for(var i=[],o=[],a=ph(),s=0,u=r;s<u.length;s++){i.push((p=u[s]).batchId);for(var c=0,h=p.mutations;c<h.length;c++)a=a.add(h[c].key)}for(var l=0,f=t;l<f.length;l++){var p;o.push((p=f[l]).batchId);for(var d=0,m=p.mutations;d<m.length;d++)a=a.add(m[d].key)}return e.localDocuments.getDocuments(n,a).next(function(t){return{affectedDocuments:t,removedBatchIds:i,addedBatchIds:o}})})})},t.prototype.localWrite=function(t){var e=this,n=Fu.now(),r=t.reduce(function(t,e){return t.add(e.key)},ph());return this.persistence.runTransaction("Locally write mutations","readwrite",function(i){return e.localDocuments.getDocuments(i,r).next(function(r){for(var o=[],a=0,s=t;a<s.length;a++){var u=s[a],c=r.get(u.key);if(!u.isIdempotent){var h=u.fieldMask;if(h){var l=c instanceof Hu?h.applyTo(c.data):mc.EMPTY;o.push(new Wc(u.key,l,h,Qc.exists(!0)))}}}return e.mutationQueue.addMutationBatch(i,n,o,t).next(function(t){var e=t.applyToLocalDocumentSet(r);return{batchId:t.batchId,changes:e}})})})},t.prototype.lookupMutationDocuments=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(n){return e.mutationQueue.lookupMutationKeys(n,t).next(function(t){return t?e.localDocuments.getDocuments(n,t):sl.resolve(null)})})},t.prototype.acknowledgeBatch=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(n){var r=t.batch.keys(),i=e.remoteDocuments.newChangeBuffer();return e.mutationQueue.acknowledgeBatch(n,t.batch,t.streamToken).next(function(){return e.applyWriteToRemoteDocuments(n,t,i)}).next(function(){return i.apply(n)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.rejectBatch=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(n){var r;return e.mutationQueue.lookupMutationBatch(n,t).next(function(t){return Zs(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.mutationQueue.removeMutationBatch(n,t)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly",function(e){return t.mutationQueue.getLastStreamToken(e)})},t.prototype.setLastStreamToken=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(n){return e.mutationQueue.setLastStreamToken(n,t)})},t.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return t.queryCache.getLastRemoteSnapshotVersion(e)})},t.prototype.applyRemoteEvent=function(e){var n=this,r=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var o=[],a=ph();su(e.targetChanges,function(r,s){var u=n.queryDataByTarget[r];if(u){s.addedDocuments.forEach(function(t){a=a.add(t)}),s.modifiedDocuments.forEach(function(t){a=a.add(t)}),o.push(n.queryCache.removeMatchingKeys(i,s.removedDocuments,r).next(function(){return n.queryCache.addMatchingKeys(i,s.addedDocuments,r)}));var c=s.resumeToken;if(c.length>0){var h=u;u=u.copy({resumeToken:c,snapshotVersion:e.snapshotVersion}),n.queryDataByTarget[r]=u,t.shouldPersistQueryData(h,u,s)&&o.push(n.queryCache.updateQueryData(i,u))}}});var s=ah(),u=ph();e.documentUpdates.forEach(function(t,e){u=u.add(t)}),o.push(r.getEntries(i,u).next(function(t){e.documentUpdates.forEach(function(u,c){var h=t.get(u);null==h||c.version.isEqual(xc.MIN)||a.has(c.key)&&!h.hasPendingWrites||c.version.compareTo(h.version)>=0?(r.addEntry(c),s=s.insert(u,c)):Ys("LocalStore","Ignoring outdated watch update for ",u,". Current version:",h.version," Watch version:",c.version),e.resolvedLimboDocuments.has(u)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(i,u))})}));var c=e.snapshotVersion;if(!c.isEqual(xc.MIN)){var h=n.queryCache.getLastRemoteSnapshotVersion(i).next(function(t){return Zs(c.compareTo(t)>=0,"Watch stream reverted to previous snapshot?? "+c+" < "+t),n.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,c)});o.push(h)}return sl.waitFor(o).next(function(){return r.apply(i)}).next(function(){return n.localDocuments.getLocalViewOfDocuments(i,s)})})},t.shouldPersistQueryData=function(t,e,n){return 0!==e.resumeToken.length&&(0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)},t.prototype.notifyLocalViewChanges=function(t){var e=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return sl.forEach(t,function(t){return e.localViewReferences.addReferences(t.addedKeys,t.targetId),e.localViewReferences.removeReferences(t.removedKeys,t.targetId),sl.forEach(t.removedKeys,function(t){return e.persistence.referenceDelegate.removeReference(n,t)})})})},t.prototype.nextMutationBatch=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(n){return void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)})},t.prototype.readDocument=function(t){var e=this;return this.persistence.runTransaction("read document","readonly",function(n){return e.localDocuments.getDocument(n,t)})},t.prototype.allocateQuery=function(t){var e=this;return this.persistence.runTransaction("Allocate query","readwrite",function(n){var r;return e.queryCache.getQueryData(n,t).next(function(i){return i?(r=i,sl.resolve()):e.queryCache.allocateTargetId(n).next(function(i){return r=new qc(t,i,Tc.Listen,n.currentSequenceNumber),e.queryCache.addQueryData(n,r)})}).next(function(){return Zs(!e.queryDataByTarget[r.targetId],"Tried to allocate an already allocated query: "+t),e.queryDataByTarget[r.targetId]=r,r})})},t.prototype.releaseQuery=function(t,e){var n=this;return this.persistence.runTransaction("Release query",e?"readwrite":"readwrite-primary",function(r){return n.queryCache.getQueryData(r,t).next(function(i){Zs(null!=i,"Tried to release nonexistent query: "+t);var o=i.targetId,a=n.queryDataByTarget[o],s=n.localViewReferences.removeReferencesForId(o);return delete n.queryDataByTarget[o],e?sl.resolve():sl.forEach(s,function(t){return n.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return n.persistence.referenceDelegate.removeTarget(r,a)})})})},t.prototype.executeQuery=function(t){var e=this;return this.persistence.runTransaction("Execute query","readonly",function(n){return e.localDocuments.getDocumentsMatchingQuery(n,t)})},t.prototype.remoteDocumentKeys=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly",function(n){return e.queryCache.getMatchingKeysForTargetId(n,t)})},t.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},t.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},t.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},t.prototype.applyWriteToRemoteDocuments=function(t,e,n){var r=this,i=e.batch,o=i.keys(),a=sl.resolve();return o.forEach(function(r){a=a.next(function(){return n.getEntry(t,r)}).next(function(t){var o=t,a=e.docVersions.get(r);Zs(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&((o=i.applyToRemoteDocument(r,o,e))?n.addEntry(o):Zs(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))})}),a.next(function(){return r.mutationQueue.removeMutationBatch(t,i)})},t.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(n){return t.collect(n,e.queryDataByTarget)})},t.prototype.getQueryForTarget=function(t){var e=this;return this.queryDataByTarget[t]?Promise.resolve(this.queryDataByTarget[t].query):this.persistence.runTransaction("Get query data","readonly",function(n){return e.queryCache.getQueryDataForTarget(n,t).next(function(t){return t?t.query:null})})},t.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly",function(e){return t.remoteDocuments.getNewDocumentChanges(e)})},t.RESUME_TOKEN_MAX_AGE_MICROS=3e8,t}(),Rf=function(){function t(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=eu(),this.batchesByDocumentKey=new Fc(kf.compareByKey)}return t.prototype.checkEmpty=function(t){return sl.resolve(0===this.mutationQueue.length)},t.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");Zs(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return Zs(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,sl.resolve()},t.prototype.getLastStreamToken=function(t){return sl.resolve(this.lastStreamToken)},t.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,sl.resolve()},t.prototype.addMutationBatch=function(t,e,n,r){Zs(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,this.mutationQueue.length>0&&Zs(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new ol(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new kf(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return sl.resolve(o)},t.prototype.lookupMutationBatch=function(t,e){return sl.resolve(this.findMutationBatch(e))},t.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return Zs(null!=n,"Failed to find local mutation batch."),sl.resolve(n.keys())},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this.indexOfBatchId(e+1),r=n<0?0:n;return sl.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)},t.prototype.getAllMutationBatches=function(t){return sl.resolve(this.mutationQueue.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new kf(e,0),i=new kf(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){Zs(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(t.targetOrBatchId);Zs(null!==r,"Batches in the index must exist in the main table"),o.push(r)}),sl.resolve(o)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Fc(Nu);return e.forEach(function(t){var e=new kf(t,0),i=new kf(t,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([e,i],function(e){Zs(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)})}),sl.resolve(this.findMutationBatches(r))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Wu.isDocumentKey(i)||(i=i.child(""));var o=new kf(new Wu(i),0),a=new Fc(Nu);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)},o),sl.resolve(this.findMutationBatches(a))},t.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){var r=e.findMutationBatch(t);null!==r&&n.push(r)}),n},t.prototype.removeMutationBatch=function(t,e){var n=this;Zs(0===this.indexOfExistingBatchId(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return sl.forEach(e.mutations,function(i){var o=new kf(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(t,i.key)}).next(function(){n.batchesByDocumentKey=r})},t.prototype.removeCachedMutationKeys=function(t){},t.prototype.containsKey=function(t,e){var n=new kf(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return sl.resolve(e.isEqual(r&&r.key))},t.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Zs(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),sl.resolve()},t.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return Zs(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},t.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},t.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return Zs(n.batchId===t,"If found batch must match"),n},t}(),_f=function(){function t(t){this.persistence=t,this.queries=new Nl(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=xc.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new Nf,this.targetCount=0,this.targetIdGenerator=gl.forQueryCache()}return t.prototype.getTargetCount=function(t){return sl.resolve(this.targetCount)},t.prototype.forEachTarget=function(t,e){return this.queries.forEach(function(t,n){return e(n)}),sl.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(t){return sl.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(t){return sl.resolve(this.highestSequenceNumber)},t.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,sl.resolve(e)},t.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),sl.resolve()},t.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},t.prototype.addQueryData=function(t,e){return Zs(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,sl.resolve()},t.prototype.updateQueryData=function(t,e){return Zs(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),sl.resolve()},t.prototype.removeQueryData=function(t,e){return Zs(this.targetCount>0,"Removing a target from an empty cache"),Zs(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,sl.resolve()},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.queries.forEach(function(a,s){s.sequenceNumber<=e&&!n[s.targetId]&&(r.queries.delete(a),o.push(r.removeMatchingKeysForTargetId(t,s.targetId)),i++)}),sl.waitFor(o).next(function(){return i})},t.prototype.getQueryCount=function(t){return sl.resolve(this.targetCount)},t.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return sl.resolve(n)},t.prototype.getQueryDataForTarget=function(t,e){return $s("Not yet implemented.")},t.prototype.addMatchingKeys=function(t,e,n){this.references.addReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.addReference(t,e))}),sl.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.removeReference(t,e))}),sl.waitFor(i)},t.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),sl.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return sl.resolve(n)},t.prototype.containsKey=function(t,e){return sl.resolve(this.references.containsKey(e))},t}(),Mf=function(){function t(t,e){this.indexManager=t,this.sizer=e,this.docs=new Ju(Wu.comparator),this.newDocumentChanges=ph(),this.size=0}return t.prototype.addEntries=function(t,e,n){for(var r=[],i=0,o=e;i<o.length;i++){var a=o[i],s=a.maybeDocument.key;this.docs=this.docs.insert(s,a),this.newDocumentChanges=this.newDocumentChanges.add(s),r.push(this.indexManager.addToCollectionParentIndex(t,s.path.popLast()))}return this.size+=n,sl.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=this.docs.get(e);return n?(this.docs=this.docs.remove(e),this.size-=n.size,sl.resolve(n.size)):sl.resolve(0)},t.prototype.getEntry=function(t,e){var n=this.docs.get(e);return sl.resolve(n?n.maybeDocument:null)},t.prototype.getSizedEntry=function(t,e){return sl.resolve(this.docs.get(e))},t.prototype.getEntries=function(t,e){var n=this,r=sh();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),sl.resolve(r)},t.prototype.getSizedEntries=function(t,e){var n=this,r=sh(),i=new Ju(Wu.comparator);return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null),i=i.insert(t,e?e.size:0)}),sl.resolve({maybeDocuments:r,sizeMap:i})},t.prototype.getDocumentsMatchingQuery=function(t,e){Zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=ch(),r=new Wu(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.value.maybeDocument;if(!e.path.isPrefixOf(o.key.path))break;a instanceof Hu&&e.matches(a)&&(n=n.insert(a.key,a))}return sl.resolve(n)},t.prototype.forEachDocumentKey=function(t,e){return sl.forEach(this.docs,function(t){return e(t)})},t.prototype.getNewDocumentChanges=function(t){var e=this,n=ah();return this.newDocumentChanges.forEach(function(t){var r=e.docs.get(t),i=r?r.maybeDocument:new Yu(t,xc.forDeletedDoc());n=n.insert(t,i)}),this.newDocumentChanges=ph(),sl.resolve(n)},t.prototype.newChangeBuffer=function(){return new Pf(this.sizer,this)},t.prototype.getSize=function(t){return sl.resolve(this.size)},t}(),Pf=function(t){function e(e,n){var r=t.call(this)||this;return r.sizer=e,r.documentCache=n,r}return ar(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentSizes.get(t);Zs(void 0!==o,"Attempting to change document "+t.toString()+" without having read it first");var a=e.sizer(n);r+=a-o,i.push({maybeDocument:n,size:a})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(kl),xf=function(){function t(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new zh(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new _f(this),this.indexManager=new Fl,this.remoteDocumentCache=new Mf(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}return t.createLruPersistence=function(e,n,r){return new t(e,function(t){return new Ff(t,new uf(n),r)})},t.createEagerPersistence=function(e){return new t(e,function(t){return new qf(t)})},t.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getActiveClients=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){return[2,[this.clientId]]})})},t.prototype.setPrimaryStateListener=function(t){return t(!0)},t.prototype.setNetworkEnabled=function(t){},t.prototype.getIndexManager=function(){return this.indexManager},t.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Rf(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},t.prototype.getQueryCache=function(){return this.queryCache},t.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},t.prototype.runTransaction=function(t,e,n){var r=this;Ys("MemoryPersistence","Starting transaction:",t);var i=new Lf(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},t.prototype.mutationQueuesContainKey=function(t,e){return sl.or((n=this.mutationQueues,r=[],uu(n,function(t,e){return r.push(e)}),r).map(function(n){return function(){return n.containsKey(t,e)}}));var n,r},t}(),Lf=function(t){this.currentSequenceNumber=t},qf=function(){function t(t){this.persistence=t}return t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),sl.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),sl.resolve()},t.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),sl.resolve()},t.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},t.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},t.prototype.onTransactionCommitted=function(t){var e=this,n=this.persistence.getRemoteDocumentCache();return sl.forEach(this.orphanedDocuments,function(r){return e.isReferenced(t,r).next(function(e){return e?sl.resolve():n.removeEntry(t,r).next(function(){})})})},t.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},t.prototype.documentSize=function(t){return 0},t.prototype.isReferenced=function(t,e){var n=this;return sl.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return sl.resolve(n.inMemoryPins.containsKey(e))}])},t}(),Ff=function(){function t(t,e,n){this.persistence=t,this.serializer=e,this.orphanedSequenceNumbers=new Nl(function(t){return el(t.path)}),this.garbageCollector=new df(this,n)}return t.prototype.onTransactionStarted=function(){},t.prototype.onTransactionCommitted=function(t){return sl.resolve()},t.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){var n=this;return sl.forEach(this.orphanedSequenceNumbers,function(r,i){return n.isPinned(t,r,i).next(function(t){return t?sl.resolve():e(i)})})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=this.persistence.getRemoteDocumentCache();return i.forEachDocumentKey(t,function(o){return n.isPinned(t,o,e).next(function(e){return e?sl.resolve():(r++,i.removeEntry(t,o).next())})}).next(function(){return r})},t.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),sl.resolve()},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(t,n)},t.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),sl.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),sl.resolve()},t.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),sl.resolve()},t.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw $s("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},t.prototype.isPinned=function(t,e,n){var r=this;return sl.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return sl.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return sl.resolve(void 0!==t&&t>n)}])},t.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},t}(),Bf=function(){function t(t,e,n,r,i){this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return t.prototype.reset=function(){this.currentBaseMs=0},t.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},t.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&Ys("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},t.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},t.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},t}();!function(t){t[t.Initial=0]="Initial",t[t.Starting=1]="Starting",t[t.Open=2]="Open",t[t.Error=3]="Error",t[t.Backoff=4]="Backoff"}(Df||(Df={}));var Vf,Uf,jf=1e3,Qf=6e4,Kf=1.5,Gf=function(){function t(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Df.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Bf(t,e,jf,Kf,Qf)}return t.prototype.isStarted=function(){return this.state===Df.Starting||this.state===Df.Open||this.state===Df.Backoff},t.prototype.isOpen=function(){return this.state===Df.Open},t.prototype.start=function(){this.state!==Df.Error?(Zs(this.state===Df.Initial,"Already started"),this.auth()):this.performBackoff()},t.prototype.stop=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Df.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.inhibitBackoff=function(){Zs(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Df.Initial,this.backoff.reset()},t.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},t.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},t.prototype.handleIdleCloseTimer=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){return this.isOpen()?[2,this.close(Df.Initial)]:[2]})})},t.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},t.prototype.close=function(t,e){return ur(this,void 0,void 0,function(){return cr(this,function(n){switch(n.label){case 0:return Zs(this.isStarted(),"Only started streams should be closed."),Zs(t===Df.Error||Sc(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==Df.Error?this.backoff.reset():e&&e.code===nu.RESOURCE_EXHAUSTED?(e(e.toString()),e("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===nu.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(e)];case 1:return n.sent(),[2]}})})},t.prototype.tearDown=function(){},t.prototype.auth=function(){var t=this;Zs(this.state===Df.Initial,"Must be in initial state to auth"),this.state=Df.Starting;var e=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then(function(e){t.closeCount===n&&t.startStream(e)},function(n){e(function(){var e=new ru(nu.UNKNOWN,"Fetching auth token failed: "+n.message);return t.handleStreamClose(e)})})},t.prototype.startStream=function(t){var e=this;Zs(this.state===Df.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return Zs(e.state===Df.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Df.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},t.prototype.performBackoff=function(){var t=this;Zs(this.state===Df.Error,"Should only perform backoff when in Error state"),this.state=Df.Backoff,this.backoff.backoffAndRun(function(){return ur(t,void 0,void 0,function(){return cr(this,function(t){return Zs(this.state===Df.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Df.Initial,this.start(),Zs(this.isStarted(),"PersistentStream should have started"),[2]})})})},t.prototype.handleStreamClose=function(t){return Zs(this.isStarted(),"Can't handle server close on non-started stream"),Ys("PersistentStream","close with error: "+t),this.stream=null,this.close(Df.Error,t)},t.prototype.getCloseGuardedDispatcher=function(t){var e=this;return function(n){e.queue.enqueueAndForget(function(){return e.closeCount===t?n():(Ys("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},t}(),Wf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Wh.ListenStreamConnectionBackoff,Wh.ListenStreamIdle,n,r,o)||this;return a.serializer=i,a}return ar(e,t),e.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},e.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},e.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},e.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},e}(Gf),zf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Wh.WriteStreamConnectionBackoff,Wh.WriteStreamIdle,n,r,o)||this;return a.serializer=i,a.handshakeComplete_=!1,a}return ar(e,t),Object.defineProperty(e.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.handshakeComplete_=!1,t.prototype.start.call(this)},e.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},e.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},e.prototype.onMessage=function(t){if(Zs(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Zs(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},e.prototype.writeHandshake=function(){Zs(this.isOpen(),"Writing handshake requires an opened stream"),Zs(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},e.prototype.writeMutations=function(t){var e=this;Zs(this.isOpen(),"Writing mutations requires an opened stream"),Zs(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Zs(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},e}(Gf),Hf=function(){function t(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}return t.prototype.newPersistentWriteStream=function(t){return new zf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.newPersistentWatchStream=function(t){return new Wf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},t.prototype.lookup=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,documents:t.map(function(t){return e.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",n).then(function(n){var r=ah();n.forEach(function(t){var n=e.serializer.fromMaybeDocument(t);r=r.insert(n.key,n)});var i=[];return t.forEach(function(t){var e=r.get(t);Zs(!!e,"Missing entity in write response for "+t),i.push(e)}),i})},t.prototype.invokeRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeRPC(t,e,r)}).catch(function(t){throw t.code===nu.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t.prototype.invokeStreamingRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeStreamingRPC(t,e,r)}).catch(function(t){throw t.code===nu.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t}(),Yf=function(){function t(t){this.datastore=t,this.readVersions=lh(),this.mutations=[],this.committed=!1}return t.prototype.recordVersion=function(t){var e;if(t instanceof Hu)e=t.version;else{if(!(t instanceof Yu))throw $s("Document in a transaction was a "+t.constructor.name);e=xc.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new ru(nu.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},t.prototype.lookup=function(t){var e=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(t).then(function(t){return t.forEach(function(t){t instanceof Yu||t instanceof Hu?e.recordVersion(t):$s("Document in a transaction was a "+t.constructor.name)}),t})},t.prototype.write=function(t){if(this.committed)throw new ru(nu.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(t)},t.prototype.precondition=function(t){var e=this.readVersions.get(t);return e?Qc.updateTime(e):Qc.NONE},t.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(e&&e.isEqual(xc.forDeletedDoc()))throw new ru(nu.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return e?Qc.updateTime(e):Qc.exists(!0)},t.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t)))},t.prototype.update=function(t,e){this.write(e.toMutations(t,this.preconditionForUpdate(t)))},t.prototype.delete=function(t){this.write([new Hc(t,this.precondition(t))]),this.readVersions=this.readVersions.insert(t,xc.forDeletedDoc())},t.prototype.commit=function(){var t=this,e=this.readVersions;return this.mutations.forEach(function(t){e=e.remove(t.key)}),e.isEmpty()?this.datastore.commit(this.mutations).then(function(){t.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},t}();!function(t){t[t.Unknown=0]="Unknown",t[t.Online=1]="Online",t[t.Offline=2]="Offline"}(Vf||(Vf={})),function(t){t[t.RemoteStore=0]="RemoteStore",t[t.SharedClientState=1]="SharedClientState"}(Uf||(Uf={}));var Xf=function(){function t(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=Vf.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return t.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Vf.Unknown),Zs(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Wh.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,Zs(t.state===Vf.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(Vf.Offline),Promise.resolve()}))},t.prototype.handleWatchStreamFailure=function(t){this.state===Vf.Online?(this.setAndBroadcast(Vf.Unknown),Zs(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Zs(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(Vf.Offline)))},t.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===Vf.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},t.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Xs(e),this.shouldWarnClientIsOffline=!1):Ys("OnlineStateTracker",e)},t.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},t}(),Jf=function(){function t(t,e,n,r){this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new Xf(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return ur(this,void 0,void 0,function(){var t;return cr(this,function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Vf.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},t.prototype.disableNetwork=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Vf.Offline),[2]}})})},t.prototype.disableNetworkInternal=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),this.writePipeline.length>0&&(Ys("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},t.prototype.shutdown=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return Ys("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Vf.Unknown),[2]}})})},t.prototype.listen=function(t){Zs(!ou(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},t.prototype.unlisten=function(t){Zs(ou(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),cu(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Vf.Unknown))},t.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},t.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},t.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},t.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},t.prototype.startWatchStream=function(){Zs(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Nh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},t.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!cu(this.listenTargets)},t.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},t.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},t.prototype.onWatchStreamOpen=function(){return ur(this,void 0,void 0,function(){var t=this;return cr(this,function(e){return su(this.listenTargets,function(e,n){t.sendWatchRequest(n)}),[2]})})},t.prototype.onWatchStreamClose=function(t){return ur(this,void 0,void 0,function(){return cr(this,function(e){return void 0===t&&Zs(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(Vf.Unknown),[2]})})},t.prototype.onWatchStreamChange=function(t,e){return ur(this,void 0,void 0,function(){var n;return cr(this,function(r){switch(r.label){case 0:return this.onlineStateTracker.set(Vf.Online),t instanceof Dh&&t.state===bh.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof Ih?this.watchChangeAggregator.handleDocumentChange(t):t instanceof Ch?this.watchChangeAggregator.handleExistenceFilter(t):(Zs(t instanceof Dh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),e.isEqual(xc.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),e.compareTo(n)>=0?[4,this.raiseWatchSnapshot(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},t.prototype.raiseWatchSnapshot=function(t){var e=this;Zs(!t.isEqual(xc.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(t);return su(n.targetChanges,function(n,r){if(r.resumeToken.length>0){var i=e.listenTargets[n];i&&(e.listenTargets[n]=i.copy({resumeToken:r.resumeToken,snapshotVersion:t}))}}),n.targetMismatches.forEach(function(t){var n=e.listenTargets[t];if(n){e.listenTargets[t]=n.copy({resumeToken:eu()}),e.sendUnwatchRequest(t);var r=new qc(n.query,t,Tc.ExistenceFilterMismatch,n.sequenceNumber);e.sendWatchRequest(r)}}),this.syncEngine.applyRemoteEvent(n)},t.prototype.handleTargetError=function(t){var e=this;Zs(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach(function(t){r=r.then(function(){return ur(e,void 0,void 0,function(){return cr(this,function(e){return ou(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,n)]):[2]})})})}),r},t.prototype.fillWritePipeline=function(){return ur(this,void 0,void 0,function(){var t;return cr(this,function(e){switch(e.label){case 0:return this.canAddToWritePipeline()?[4,this.localStore.nextMutationBatch(this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:-1)]:[3,4];case 1:return null!==(t=e.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(t),[4,this.fillWritePipeline()];case 3:e.sent(),e.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},t.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},t.prototype.outstandingWrites=function(){return this.writePipeline.length},t.prototype.addToWritePipeline=function(t){Zs(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},t.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},t.prototype.startWriteStream=function(){Zs(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},t.prototype.onWriteStreamOpen=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){return this.writeStream.writeHandshake(),[2]})})},t.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var e=0,n=t.writePipeline;e<n.length;e++)t.writeStream.writeMutations(n[e].mutations)}).catch(Sf)},t.prototype.onMutationResult=function(t,e){var n=this;Zs(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=al.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},t.prototype.onWriteStreamClose=function(t){return ur(this,void 0,void 0,function(){var e=this;return cr(this,function(n){return void 0===t&&Zs(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&this.writePipeline.length>0?[2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]:[2]})})},t.prototype.handleHandshakeError=function(t){return ur(this,void 0,void 0,function(){return cr(this,function(e){return nh(t.code)?(Ys("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=eu(),[2,this.localStore.setLastStreamToken(eu()).catch(Sf)]):[2]})})},t.prototype.handleWriteError=function(t){return ur(this,void 0,void 0,function(){var e,n=this;return cr(this,function(r){return nh(i=t.code)&&i!==nu.ABORTED?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,t).then(function(){return n.fillWritePipeline()})]):[2];var i})})},t.prototype.createTransaction=function(){return new Yf(this.datastore)},t.prototype.handleCredentialChange=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Ys("RemoteStore","RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return t.sent(),this.onlineStateTracker.set(Vf.Unknown),[4,this.enableNetwork()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.applyPrimaryState=function(t){return ur(this,void 0,void 0,function(){return cr(this,function(e){switch(e.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(Vf.Unknown),e.label=4;case 4:return[2]}})})},t}(),$f=function(){this.listeners=[]},Zf=function(){function t(t){this.syncEngine=t,this.queries=new Nl(function(t){return t.canonicalId()}),this.onlineState=Vf.Unknown,this.syncEngine.subscribe(this)}return t.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new $f,this.queries.set(e,r)),r.listeners.push(t),t.applyOnlineStateChange(this.onlineState),r.viewSnap&&t.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t,t}):Promise.resolve(r.targetId)},t.prototype.unlisten=function(t){return ur(this,void 0,void 0,function(){var e,n,r,i;return cr(this,function(o){return n=!1,(r=this.queries.get(e=t.query))&&(i=r.listeners.indexOf(t))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},t.prototype.onWatchChange=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e],i=this.queries.get(r.query);if(i){for(var o=0,a=i.listeners;o<a.length;o++)a[o].onViewSnapshot(r);i.viewSnap=r}}},t.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},t.prototype.onOnlineStateChange=function(t){this.onlineState=t,this.queries.forEach(function(e,n){for(var r=0,i=n.listeners;r<i.length;r++)i[r].applyOnlineStateChange(t)})},t}(),tp=function(){function t(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.onlineState=Vf.Unknown,this.options=n||{}}return t.prototype.onViewSnapshot=function(t){if(Zs(t.docChanges.length>0||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==yh.Metadata&&e.push(i)}t=new Sh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(t)&&this.queryObserver.next(t):this.shouldRaiseInitialEvent(t,this.onlineState)&&this.raiseInitialEvent(t),this.snap=t},t.prototype.onError=function(t){this.queryObserver.error(t)},t.prototype.applyOnlineStateChange=function(t){this.onlineState=t,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&this.raiseInitialEvent(this.snap)},t.prototype.shouldRaiseInitialEvent=function(t,e){return Zs(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache||(this.options.waitForSyncWhenOnline&&e!==Vf.Offline?(Zs(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===Vf.Offline)},t.prototype.shouldRaiseEvent=function(t){return t.docChanges.length>0||!!(t.syncStateChanged||this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites)&&!0===this.options.includeMetadataChanges},t.prototype.raiseInitialEvent=function(t){Zs(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=Sh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},t}(),ep=function(){function t(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}return t.fromSnapshot=function(e,n){for(var r=ph(),i=ph(),o=0,a=n.docChanges;o<a.length;o++){var s=a[o];switch(s.type){case yh.Added:r=r.add(s.doc.key);break;case yh.Removed:i=i.add(s.doc.key)}}return new t(e,r,i)},t}(),np=function(t){this.key=t},rp=function(t){this.key=t},ip=function(){function t(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=ph(),this.mutatedKeys=ph(),this.documentSet=new vh(t.docComparator.bind(t))}return Object.defineProperty(t.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),t.prototype.computeDocChanges=function(t,e){var n=this,r=e?e.changeSet:new wh,i=e?e.documentSet:this.documentSet,o=e?e.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(t.inorderTraversal(function(t,e){var c=i.get(t),h=e instanceof Hu?e:null;h&&(Zs(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=n.query.matches(h)?h:null);var l=!!c&&n.mutatedKeys.has(c.key),f=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),p=!1;c&&h?c.data.isEqual(h.data)?l!==f&&(r.track({type:yh.Metadata,doc:h}),p=!0):n.shouldWaitForSyncedDocument(c,h)||(r.track({type:yh.Modified,doc:h}),p=!0,u&&n.query.docComparator(h,u)>0&&(s=!0)):!c&&h?(r.track({type:yh.Added,doc:h}),p=!0):c&&!h&&(r.track({type:yh.Removed,doc:c}),p=!0,u&&(s=!0)),p&&(h?(a=a.add(h),o=f?o.add(t):o.delete(t)):(a=a.delete(t),o=o.delete(t)))}),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),o=o.delete(c.key),r.track({type:yh.Removed,doc:c})}return Zs(!s||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},t.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},t.prototype.applyChanges=function(t,e,n){var r=this;Zs(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){var n=function(t){switch(t){case yh.Added:return 1;case yh.Modified:case yh.Metadata:return 2;case yh.Removed:return 0;default:return $s("Unknown ChangeType: "+t)}};return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?gh.Synced:gh.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new Sh(this.query,t.documentSet,i,o,t.mutatedKeys,s===gh.Local,u,!1),limboChanges:a}:{limboChanges:a}},t.prototype.applyOnlineStateChange=function(t){return this.current&&t===Vf.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new wh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},t.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},t.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return Zs(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},t.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=ph(),this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var n=[];return e.forEach(function(e){t.limboDocuments.has(e)||n.push(new rp(e))}),this.limboDocuments.forEach(function(t){e.has(t)||n.push(new np(t))}),n},t.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=ph();var n=this.computeDocChanges(t);return this.applyChanges(n,!0)},t.prototype.computeInitialSnapshot=function(){return Sh.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===gh.Local)},t}(),op=function(t,e,n){this.query=t,this.targetId=e,this.view=n},ap=function(t){this.key=t},sp=function(){function t(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Nl(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new Ju(Wu.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new Nf,this.mutationUserCallbacks={},this.limboTargetIdGenerator=gl.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Vf.Unknown}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){Zs(null!==t,"SyncEngine listener cannot be null"),Zs(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},t.prototype.listen=function(t){return ur(this,void 0,void 0,function(){var e,n,r,i,o;return cr(this,function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(t))?(this.sharedClientState.addLocalQueryTarget(e=r.targetId),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},t.prototype.initializeViewAndComputeSnapshot=function(t,e){var n=this,r=t.query;return this.localStore.executeQuery(r).then(function(i){return n.localStore.remoteDocumentKeys(t.targetId).then(function(o){var a=new ip(r,o),s=a.computeDocChanges(i),u=Th.createSynthesizedTargetChangeForCurrentChange(t.targetId,e&&n.onlineState!==Vf.Offline),c=a.applyChanges(s,!0===n.isPrimary,u);Zs(0===c.limboChanges.length,"View returned limbo docs before target ack from the server."),Zs(!!c.snapshot,"applyChanges for new view should always return a snapshot");var h=new op(r,t.targetId,a);return n.queryViewsByQuery.set(r,h),n.queryViewsByTarget[t.targetId]=h,c.snapshot})})},t.prototype.synchronizeViewAndComputeSnapshot=function(t){var e=this;return this.localStore.executeQuery(t.query).then(function(n){return e.localStore.remoteDocumentKeys(t.targetId).then(function(r){return ur(e,void 0,void 0,function(){var e;return cr(this,function(i){return e=t.view.synchronizeWithPersistedState(n,r),this.isPrimary&&this.updateTrackedLimbos(t.targetId,e.limboChanges),[2,e]})})})})},t.prototype.unlisten=function(t){return ur(this,void 0,void 0,function(){var e,n=this;return cr(this,function(r){switch(r.label){case 0:return this.assertSubscribed("unlisten()"),Zs(!!(e=this.queryViewsByQuery.get(t)),"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(Sf)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(t,!0)];case 4:r.sent(),r.label=5;case 5:return[2]}})})},t.prototype.write=function(t,e){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(t).then(function(t){return n.sharedClientState.addPendingMutation(t.batchId),n.addMutationCallback(t.batchId,e),n.emitNewSnapsAndNotifyLocalStore(t.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},t.prototype.wrapUpdateFunctionError=function(t){return t},t.prototype.runTransaction=function(t,e){var n=this;void 0===e&&(e=5),Zs(e>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var e=t(r);return!Sc(e)&&e.catch&&e.then?e.catch(function(t){return Promise.reject(n.wrapUpdateFunctionError(t))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(t){return Promise.reject(n.wrapUpdateFunctionError(t))}}().then(function(i){return r.commit().then(function(){return i}).catch(function(r){return 0===e?Promise.reject(r):n.runTransaction(t,e-1)})})},t.prototype.applyRemoteEvent=function(t){var e=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(t).then(function(n){return uu(t.targetChanges,function(t,n){var r=e.limboResolutionsByTarget[t];r&&(Zs(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?r.receivedDocument=!0:n.modifiedDocuments.size>0?Zs(r.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(Zs(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))}),e.emitNewSnapsAndNotifyLocalStore(n,t)}).catch(Sf)},t.prototype.applyOnlineStateChange=function(t,e){if(this.isPrimary&&e===Uf.RemoteStore||!this.isPrimary&&e===Uf.SharedClientState){var n=[];this.queryViewsByQuery.forEach(function(e,r){var i=r.view.applyOnlineStateChange(t);Zs(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)}),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(n),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},t.prototype.rejectListen=function(t,e){return ur(this,void 0,void 0,function(){var n,r,i,o,a,s,u=this;return cr(this,function(c){switch(c.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",e),(r=(n=this.limboResolutionsByTarget[t])&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[t],i=(i=new Ju(Wu.comparator)).insert(r,new Yu(r,xc.forDeletedDoc())),o=ph().add(r),a=new Eh(xc.MIN,{},new Fc(Nu),i,o),[2,this.applyRemoteEvent(a)]):[3,1];case 1:return Zs(!!(s=this.queryViewsByTarget[t]),"Unknown targetId: "+t),[4,this.localStore.releaseQuery(s.query,!1).then(function(){return u.removeAndCleanupQuery(s)}).catch(Sf)];case 2:c.sent(),this.syncEngineListener.onWatchError(s.query,e),c.label=3;case 3:return[2]}})})},t.prototype.applyBatchState=function(t,e,n){return ur(this,void 0,void 0,function(){var r;return cr(this,function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(r=i.sent())?(Ys("SyncEngine","Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.processUserCallback(t,n||null),this.localStore.removeCachedMutationBatchMetadata(t)):$s("Unknown batchState: "+e),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}})})},t.prototype.applySuccessfulWrite=function(t){var e=this;this.assertSubscribed("applySuccessfulWrite()");var n=t.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(t).then(function(t){return e.sharedClientState.updateMutationState(n,"acknowledged"),e.emitNewSnapsAndNotifyLocalStore(t)}).catch(Sf)},t.prototype.rejectFailedWrite=function(t,e){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,e),this.localStore.rejectBatch(t).then(function(r){return n.sharedClientState.updateMutationState(t,"rejected",e),n.emitNewSnapsAndNotifyLocalStore(r)}).catch(Sf)},t.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new Ju(Nu)),n=n.insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},t.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(Zs(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},t.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach(function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)})}},t.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},t.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof np?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof rp?(Ys("SyncEngine","Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):$s("Unknown limbo change: "+JSON.stringify(i))}},t.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){Ys("SyncEngine","New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=Ic.atPath(e.path);this.limboResolutionsByTarget[n]=new ap(e),this.remoteStore.listen(new qc(r,n,Tc.LimboResolution,zh.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},t.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},t.prototype.emitNewSnapsAndNotifyLocalStore=function(t,e){return ur(this,void 0,void 0,function(){var n,r,i,o=this;return cr(this,function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach(function(a,s){i.push(Promise.resolve().then(function(){var e=s.view.computeDocChanges(t);return e.needsRefill?o.localStore.executeQuery(s.query).then(function(t){return s.view.computeDocChanges(t,e)}):e}).then(function(t){var i=s.view.applyChanges(t,!0===o.isPrimary,e&&e.targetChanges[s.targetId]);if(o.updateTrackedLimbos(s.targetId,i.limboChanges),i.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,i.snapshot.fromCache?"not-current":"current"),n.push(i.snapshot);var a=ep.fromSnapshot(s.targetId,i.snapshot);r.push(a)}}))}),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}})})},t.prototype.assertSubscribed=function(t){Zs(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},t.prototype.handleCredentialChange=function(t){return ur(this,void 0,void 0,function(){var e,n;return cr(this,function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?[4,this.localStore.handleUserChange(t)]:[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}})})},t.prototype.applyPrimaryState=function(t){return ur(this,void 0,void 0,function(){var e,n,r,i,o,a,s=this;return cr(this,function(u){switch(u.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return u.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=u.sent(),r=0,i=n;r<i.length;r++)this.remoteStore.listen(i[r]);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,o=[],a=Promise.resolve(),su(this.queryViewsByTarget,function(t,e){s.sharedClientState.isLocalQueryTarget(t)?o.push(t):a=a.then(function(){return s.unlisten(e.query)}),s.remoteStore.unlisten(e.targetId)}),[4,a]);case 4:return u.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(o)];case 5:return u.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:u.sent(),u.label=7;case 7:return[2]}})})},t.prototype.resetLimboDocuments=function(){var t=this;su(this.limboResolutionsByTarget,function(e){t.remoteStore.unlisten(e)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Ju(Wu.comparator)},t.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){for(var e=this,n=Promise.resolve(),r=[],i=[],o=function(t){n=n.then(function(){return ur(e,void 0,void 0,function(){var e,n,o,a;return cr(this,function(s){switch(s.label){case 0:return(n=this.queryViewsByTarget[t])?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return s.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return e=s.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return(o=s.sent()).snapshot&&i.push(o.snapshot),[3,8];case 4:return Zs(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(t)];case 5:return Zs(!!(a=s.sent()),"Query data for target "+t+" not found"),[4,this.localStore.allocateQuery(a)];case 6:return e=s.sent(),[4,this.initializeViewAndComputeSnapshot(e,!1)];case 7:s.sent(),s.label=8;case 8:return r.push(e),[2]}})})})},a=0,s=t;a<s.length;a++)o(s[a]);return n.then(function(){return e.syncEngineListener.onWatchChange(i),r})},t.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},t.prototype.applyTargetState=function(t,e,n){return ur(this,void 0,void 0,function(){var r,i=this;return cr(this,function(o){switch(o.label){case 0:if(this.isPrimary)return Ys("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,5];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return ur(i,void 0,void 0,function(){var r;return cr(this,function(i){switch(i.label){case 0:return r=Eh.createSynthesizedRemoteEventForCurrentChange(t,"current"===e),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 1:return i.sent(),[2]}})})},function(t){return ur(i,void 0,void 0,function(){var e;return cr(this,function(n){switch(n.label){case 0:return function(t){return t.code===nu.DATA_LOSS&&t.message===Ol}(t)?(e=[],su(this.queryViewsByTarget,function(t){return e.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e)]):[3,2];case 1:return n.sent(),[3,3];case 2:throw t;case 3:return[2]}})})})];case 2:return this.removeAndCleanupQuery(r=this.queryViewsByTarget[t]),[4,this.localStore.releaseQuery(r.query,!0)];case 3:return o.sent(),this.syncEngineListener.onWatchError(r.query,n),[3,5];case 4:$s("Unexpected target state: "+e),o.label=5;case 5:return[2]}})})},t.prototype.applyActiveTargetsChange=function(t,e){return ur(this,void 0,void 0,function(){var n,r,i,o,a,s,u,c,h,l=this;return cr(this,function(f){switch(f.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,f.label=1;case 1:return n<r.length?(Zs(!this.queryViewsByTarget[h=r[n]],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(h)]):[3,6];case 2:return Zs(!!(i=f.sent()),"Query data for active target "+h+" not found"),[4,this.localStore.allocateQuery(i)];case 3:return o=f.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 4:f.sent(),this.remoteStore.listen(o),f.label=5;case 5:return n++,[3,1];case 6:a=function(t){var e;return cr(this,function(n){switch(n.label){case 0:return(e=s.queryViewsByTarget[t])?[4,s.localStore.releaseQuery(e.query,!1).then(function(){l.remoteStore.unlisten(t),l.removeAndCleanupQuery(e)}).catch(Sf)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})},s=this,u=0,c=e,f.label=7;case 7:return u<c.length?[5,a(h=c[u])]:[3,10];case 8:f.sent(),f.label=9;case 9:return u++,[3,7];case 10:return[2]}})})},t.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},t.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},t.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?ph().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:ph()},t}(),up=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.GOOGLE_CREDENTIALS=new t("google-credentials-uid"),t.FIRST_PARTY=new t("first-party-uid"),t}(),cp="SharedClientState",hp="firestore_clients",lp="firestore_mutations",fp="firestore_targets",pp="firestore_online_state",dp="firestore_sequence_number",mp=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r,Zs(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n,r){var i=JSON.parse(r),o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),a=void 0;return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(a=new ru(i.error.code,i.error.message)),o?new t(e,n,i.state,a):(Xs(cp,"Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),yp=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n,Zs(void 0!==n==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new ru(r.error.code,r.error.message)),i?new t(e,r.state,o):(Xs(cp,"Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),gp=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.fromWebStorageEntry=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=mh(),a=0;i&&a<r.activeTargetIds.length;++a)i=Ec(r.activeTargetIds[a]),o=o.add(r.activeTargetIds[a]);return i?new t(e,o):(Xs(cp,"Failed to parse client data for instance '"+e+"': "+n),null)},t}(),vp=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.fromWebStorageEntry=function(e){var n=JSON.parse(e);return"object"==typeof n&&void 0!==Vf[n.onlineState]&&"string"==typeof n.clientId?new t(n.clientId,Vf[n.onlineState]):(Xs(cp,"Failed to parse online state: "+e),null)},t}(),bp=function(){function t(){this.activeTargetIds=mh()}return t.prototype.addQueryTarget=function(t){Zs(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),wp=function(){function t(e,n,r,i,o){if(this.queue=e,this.platform=n,this.persistenceKey=r,this.localClientId=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!t.isAvailable(this.platform))throw new ru(nu.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var a=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=o,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=dp+"_"+r,this.activeClients[this.localClientId]=new bp,this.clientStateKeyRe=new RegExp("^"+hp+"_"+a+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+lp+"_"+a+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+fp+"_"+a+"_(\\d+)$"),this.onlineStateKey=pp+"_"+r,this.platform.window.addEventListener("storage",this.storageListener)}return t.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return ur(this,void 0,void 0,function(){var t,e,n,r,i,o,a,s,u,c,h=this;return cr(this,function(l){switch(l.label){case 0:return Zs(!this.started,"WebStorageSharedClientState already started"),Zs(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Zs(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=l.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=gp.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)this.handleWebStorageEvent(c[u]);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return h.shutdown()}),this.started=!0,[2]}})})},t.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){var t=mh();return uu(this.activeClients,function(e,n){t=t.unionWith(n.activeTargetIds)}),t},t.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},t.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},t.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},t.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=yp.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},t.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},t.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},t.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},t.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},t.prototype.setOnlineState=function(t){this.persistOnlineState(t)},t.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return Ys(cp,"READ",t,e),e},t.prototype.setItem=function(t,e){Ys(cp,"SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){Ys(cp,"REMOVE",t),this.storage.removeItem(t)},t.prototype.handleWebStorageEvent=function(t){var e=this;if(t.storageArea===this.storage){if(Ys(cp,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void Xs("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return ur(e,void 0,void 0,function(){var e,n,r,i,o,a;return cr(this,function(s){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return n=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(o=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(o)]}else t.key===this.sequenceNumberKey&&(Zs(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=zh.INVALID;if(null!=t)try{var n=JSON.parse(t);Zs("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){Xs(cp,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue))!==zh.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(t.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),t.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},t.prototype.persistMutationState=function(t,e,n){var r=new mp(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},t.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},t.prototype.persistOnlineState=function(t){this.storage.setItem(this.onlineStateKey,JSON.stringify({clientId:this.localClientId,onlineState:Vf[t]}))},t.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new yp(t,e,n);this.setItem(r,i.toWebStorageJSON())},t.prototype.toWebStorageClientStateKey=function(t){return Zs(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),hp+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageQueryTargetMetadataKey=function(t){return fp+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageMutationBatchKey=function(t){var e=lp+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},t.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},t.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Zs(null!==n,"Cannot parse client state key '"+t+"'"),gp.fromWebStorageEntry(n,e)},t.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Zs(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]);return mp.fromWebStorageEntry(new up(void 0!==n[2]?n[2]:null),r,e)},t.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Zs(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return yp.fromWebStorageEntry(r,e)},t.prototype.fromWebStorageOnlineState=function(t){return vp.fromWebStorageEntry(t)},t.prototype.handleMutationBatchEvent=function(t){return ur(this,void 0,void 0,function(){return cr(this,function(e){return t.user.uid!==this.currentUser.uid?(Ys(cp,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]})})},t.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},t.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(t){return ur(n,void 0,void 0,function(){return cr(this,function(e){return r.has(t)||o.push(t),[2]})})}),r.forEach(function(t){return ur(n,void 0,void 0,function(){return cr(this,function(e){return i.has(t)||a.push(t),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},t.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},t}(),Sp=function(){function t(){this.localState=new bp,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(t){},t.prototype.updateMutationState=function(t,e,n){},t.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},t.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},t.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},t.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.queryState[t]},t.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.start=function(){return this.localState=new bp,Promise.resolve()},t.prototype.handleUserChange=function(t,e,n){},t.prototype.setOnlineState=function(t){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(t){},t}(),Ep=function(){function t(t,e){this.cacheSizeBytes=t,this.experimentalTabSynchronization=e}return t.prototype.lruParams=function(){return ff.withCacheSize(this.cacheSizeBytes)},t}(),Tp=function(){},Ip=function(){function t(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=Au.newId(),this.isShutdown=!1}return t.prototype.start=function(t){var e=this;this.verifyNotShutdown();var n=new Hh,r=new Hh,i=!1;return this.credentials.setChangeListener(function(o){i?e.asyncQueue.enqueueAndForget(function(){return e.handleCredentialChange(o)}):(i=!0,e.initializePersistence(t,r,o).then(function(t){return e.initializeRest(o,t)}).then(n.resolve,n.reject))}),this.asyncQueue.enqueueAndForget(function(){return n.promise}),r.promise},t.prototype.enableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},t.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof Ep?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline storage. Falling back to storage disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},t.prototype.canFallback=function(t){return t instanceof ru?t.code===nu.FAILED_PRECONDITION||t.code===nu.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code},t.prototype.verifyNotShutdown=function(){if(this.isShutdown)throw new ru(nu.FAILED_PRECONDITION,"The client has already been shutdown.")},t.prototype.startIndexedDbPersistence=function(t,e){var n=this,r=wf.buildStoragePrefix(this.databaseInfo),i=new Fh(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return ur(n,void 0,void 0,function(){var n,o;return cr(this,function(a){switch(a.label){case 0:if(e.experimentalTabSynchronization&&!wp.isAvailable(this.platform))throw new ru(nu.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return o=e.lruParams(),e.experimentalTabSynchronization?(this.sharedClientState=new wp(this.asyncQueue,this.platform,r,this.clientId,t),[4,wf.createMultiClientIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return n=a.sent(),[3,4];case 2:return this.sharedClientState=new Sp,[4,wf.createIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o)];case 3:n=a.sent(),a.label=4;case 4:return this.persistence=n,[2,n.referenceDelegate.garbageCollector]}})})})},t.prototype.startMemoryPersistence=function(){return this.persistence=xf.createEagerPersistence(this.clientId),this.sharedClientState=new Sp,Promise.resolve(null)},t.prototype.initializeRest=function(t,e){var n=this;return Ys("FirestoreClient","Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then(function(r){return ur(n,void 0,void 0,function(){var n,i,o,a=this;return cr(this,function(s){switch(s.label){case 0:return this.localStore=new Of(this.persistence,t),e&&(this.lruScheduler=new pf(e,this.asyncQueue,this.localStore)),n=this.platform.newSerializer(this.databaseInfo.databaseId),i=new Hf(this.asyncQueue,r,this.credentials,n),o=function(t){return a.syncEngine.applyOnlineStateChange(t,Uf.SharedClientState)},this.remoteStore=new Jf(this.localStore,i,this.asyncQueue,function(t){return a.syncEngine.applyOnlineStateChange(t,Uf.RemoteStore)}),this.syncEngine=new sp(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=o,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Zf(this.syncEngine),[4,this.sharedClientState.start()];case 1:return s.sent(),[4,this.remoteStore.start()];case 2:return s.sent(),[4,this.persistence.setPrimaryStateListener(function(t){return ur(a,void 0,void 0,function(){return cr(this,function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return e.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}})})})];case 3:return s.sent(),[2]}})})})},t.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),Ys("FirestoreClient","Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},t.prototype.disableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},t.prototype.shutdown=function(){var t=this;return!0===this.isShutdown?Promise.resolve():this.asyncQueue.enqueue(function(){return ur(t,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),this.isShutdown=!0,[2]}})})})},t.prototype.listen=function(t,e,n){var r=this;this.verifyNotShutdown();var i=new tp(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},t.prototype.unlisten=function(t){var e=this;this.verifyNotShutdown(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},t.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Hu)return t;if(t instanceof Yu)return null;throw new ru(nu.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},t.prototype.getDocumentsFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.executeQuery(t)}).then(function(e){var n=ph(),r=new ip(t,n),i=r.computeDocChanges(e);return r.applyChanges(i,!1).snapshot})},t.prototype.write=function(t){var e=this;this.verifyNotShutdown();var n=new Hh;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},t.prototype.databaseId=function(){return this.databaseInfo.databaseId},t.prototype.transaction=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return ur(e,void 0,void 0,function(){return cr(this,function(t){return[2]})})}).then(function(){return e.syncEngine.runTransaction(t)})},t}(),Cp=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},t.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},t.prototype.mute=function(){this.muted=!0},t.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},t}(),Dp=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(e,n,r,i){if(!(t instanceof Array)||t.length<1)throw new ru(nu.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least "+Du(1,"element")+".")}();for(var n=0;n<t.length;++n)if(du("FieldPath","string",n,t[n]),0===t[n].length)throw new ru(nu.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Gu(t)}return t.documentId=function(){return t._DOCUMENT_ID},t.prototype.isEqual=function(e){if(!(e instanceof t))throw Iu("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},t._DOCUMENT_ID=new t(Gu.keyField().canonicalString()),t}(),Ap=new RegExp("[~\\*/\\[\\]]"),Np=function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}},kp=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t){Zs(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(up.UNAUTHENTICATED)},t.prototype.removeChangeListener=function(){Zs(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},t}(),Op=function(){function t(t){var e=this;this.app=t,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return t.prototype.getToken=function(){var t=this;Zs(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then(function(n){if(t.tokenCounter!==e)throw new ru(nu.ABORTED,"getToken aborted due to token change.");return n?(Zs("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new Np(n.accessToken,t.currentUser)):null})},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t){Zs(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.currentUser&&t(this.currentUser)},t.prototype.removeChangeListener=function(){Zs(null!=this.tokenListener,"removeChangeListener() called twice"),Zs(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},t.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Zs(null===t||"string"==typeof t,"Received invalid UID: "+t),new up(t)},t}(),Rp=function(){function t(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=up.FIRST_PARTY}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),t}(),_p=function(){function t(t,e){this.gapi=t,this.sessionIndex=e}return t.prototype.getToken=function(){return Promise.resolve(new Rp(this.gapi,this.sessionIndex))},t.prototype.setChangeListener=function(t){t(up.FIRST_PARTY)},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}();function Mp(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=["next","error","complete"];r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t)}var Pp,xp=function(){function t(t){this._methodName=t}return t.delete=function(){return hu("FieldValue.delete",arguments),Lp.instance},t.serverTimestamp=function(){return hu("FieldValue.serverTimestamp",arguments),qp.instance},t.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return fu("FieldValue.arrayUnion",arguments,1),new Fp(t)},t.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return fu("FieldValue.arrayRemove",arguments,1),new Bp(t)},t.increment=function(t){return du("FieldValue.increment","number",1,t),lu("FieldValue.increment",arguments,1),new Vp(t)},t.prototype.isEqual=function(t){return this===t},t}(),Lp=function(t){function e(){return t.call(this,"FieldValue.delete")||this}return ar(e,t),e.instance=new e,e}(xp),qp=function(t){function e(){return t.call(this,"FieldValue.serverTimestamp")||this}return ar(e,t),e.instance=new e,e}(xp),Fp=function(t){function e(e){var n=t.call(this,"FieldValue.arrayUnion")||this;return n._elements=e,n}return ar(e,t),e}(xp),Bp=function(t){function e(e){var n=t.call(this,"FieldValue.arrayRemove")||this;return n._elements=e,n}return ar(e,t),e}(xp),Vp=function(t){function e(e){var n=t.call(this,"FieldValue.increment")||this;return n._operand=e,n}return ar(e,t),e}(xp),Up=iu(xp,"Use FieldValue.<field>() instead."),jp=/^__.*__$/,Qp=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[];return n.push(null!==this.fieldMask?new Wc(t,this.data,this.fieldMask,e):new Gc(t,this.data,e)),this.fieldTransforms.length>0&&n.push(new zc(t,this.fieldTransforms)),n},t}(),Kp=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[new Wc(t,this.data,this.fieldMask,e)];return this.fieldTransforms.length>0&&n.push(new zc(t,this.fieldTransforms)),n},t}();function Gp(t){switch(t){case Pp.Set:case Pp.MergeSet:case Pp.Update:return!0;case Pp.Argument:return!1;default:throw $s("Unexpected case for UserDataSource: "+t)}}!function(t){t[t.Set=0]="Set",t[t.Update=1]="Update",t[t.MergeSet=2]="MergeSet",t[t.Argument=3]="Argument"}(Pp||(Pp={}));var Wp=function(){function t(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return t.prototype.childContextForField=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(e),r},t.prototype.childContextForFieldPath=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},t.prototype.childContextForArray=function(e){return new t(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},t.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new ru(nu.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find(function(e){return t.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return t.isPrefixOf(e.field)})},t.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},t.prototype.validatePathSegment=function(t){if(Gp(this.dataSource)&&jp.test(t))throw this.createError("Document fields cannot begin and end with __")},t}(),zp=function(t,e){this.databaseId=t,this.key=e},Hp=function(){function t(t){this.preConverter=t}return t.prototype.parseSetData=function(t,e){var n=new Wp(Pp.Set,t,Gu.EMPTY_PATH);Xp("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new Qp(r,null,n.fieldTransforms)},t.prototype.parseMergeData=function(t,e,n){var r=new Wp(Pp.MergeSet,t,Gu.EMPTY_PATH);Xp("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new Fc(Gu.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof Dp)l=h._internalPath;else{if("string"!=typeof h)throw $s("Expected stringOrFieldPath to be a string or a FieldPath");l=$p(t,h)}if(!r.contains(l))throw new ru(nu.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=Vc.fromSet(s),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=Vc.fromArray(r.fieldMask),o=r.fieldTransforms;return new Qp(a,i,o)},t.prototype.parseUpdateData=function(t,e){var n=this,r=new Wp(Pp.Update,t,Gu.EMPTY_PATH);Xp("Data must be an object, but it was:",r,e);var i=new Fc(Gu.comparator),o=mc.EMPTY;uu(e,function(e,a){var s=$p(t,e),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof Lp)i=i.add(s);else{var c=n.parseData(a,u);null!=c&&(i=i.add(s),o=o.set(s,c))}});var a=Vc.fromSet(i);return new Kp(o,a,r.fieldTransforms)},t.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Wp(Pp.Update,t,Gu.EMPTY_PATH),o=[Jp(t,e)],a=[n];if(r.length%2!=0)throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Jp(t,r[s])),a.push(r[s+1]);var u=new Fc(Gu.comparator),c=mc.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof Lp)u=u.add(h);else{var p=this.parseData(f,l);null!=p&&(u=u.add(h),c=c.set(h,p))}}var d=Vc.fromSet(u);return new Kp(c,d,i.fieldTransforms)},t.prototype.parseQueryValue=function(t,e){var n=new Wp(Pp.Argument,t,Gu.EMPTY_PATH),r=this.parseData(e,n);return Zs(null!=r,"Parsed data should not be null."),Zs(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},t.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Zp(t);throw e.createError(n)}},t.prototype.parseData=function(t,e){if(Yp(t=this.runPreConverter(t,e)))return Xp("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof xp)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},t.prototype.parseObject=function(t,e){var n=this,r=new Ju(Nu);return cu(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):uu(t,function(t,i){var o=n.parseData(i,e.childContextForField(t));null!=o&&(r=r.insert(t,o))}),new mc(r)},t.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=this.parseData(o[i],e.childContextForArray(r));null==a&&(a=rc.INSTANCE),n.push(a),r++}return new yc(n)},t.prototype.parseSentinelFieldValue=function(t,e){if(!Gp(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof Lp){if(e.dataSource!==Pp.MergeSet)throw e.dataSource===Pp.Update?(Zs(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof qp)e.fieldTransforms.push(new Uc(e.path,Yc.instance));else if(t instanceof Fp){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new Xc(n);e.fieldTransforms.push(new Uc(e.path,r))}else if(t instanceof Bp){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new Jc(n);e.fieldTransforms.push(new Uc(e.path,i))}else if(t instanceof Vp){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new $c(o);e.fieldTransforms.push(new Uc(e.path,a))}else $s("Unknown FieldValue type: "+t)},t.prototype.parseScalarValue=function(t,e){if(null===t)return rc.INSTANCE;if("number"==typeof t)return Ec(t)?new sc(t):new uc(t);if("boolean"==typeof t)return ic.of(t);if("string"==typeof t)return new cc(t);if(t instanceof Date)return new hc(Fu.fromDate(t));if(t instanceof Fu)return new hc(new Fu(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof qu)return new dc(t);if(t instanceof xu)return new fc(t);if(t instanceof zp)return new pc(t.databaseId,t.key);throw e.createError("Unsupported field value: "+Su(t))},t.prototype.parseArrayTransformElements=function(t,e){var n=this;return e.map(function(e,r){var i=new Wp(Pp.Argument,t,Gu.EMPTY_PATH);return n.parseData(e,i.childContextForArray(r))})},t}();function Yp(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Fu||t instanceof qu||t instanceof xu||t instanceof zp||t instanceof xp)}function Xp(t,e,n){if(!Yp(n)||!wu(n)){var r=Su(n);throw e.createError("an object"===r?t+" a custom object":t+" "+r)}}function Jp(t,e){if(e instanceof Dp)return e._internalPath;if("string"==typeof e)return $p(t,e);throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function $p(t,e){try{return function(t){if(t.search(Ap)>=0)throw new ru(nu.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(Dp.bind.apply(Dp,[void 0].concat(t.split("."))))}catch(e){throw new ru(nu.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=Zp(e);throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function Zp(t){return t instanceof Error?t.message:t.toString()}var td="firestore.googleapis.com",ed=!0,nd=!0,rd=!1,id=ff.COLLECTION_DISABLED,od=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new ru(nu.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=td,this.ssl=ed}else yu("settings","non-empty string","host",t.host),this.host=t.host,gu("settings","boolean","ssl",t.ssl),this.ssl=au(t.ssl,ed);if(Tu("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),gu("settings","object","credentials",t.credentials),this.credentials=t.credentials,gu("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?Xs("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&Xs("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=au(t.timestampsInSnapshots,nd),gu("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=ff.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==id&&t.cacheSizeBytes<ff.MINIMUM_CACHE_SIZE_BYTES)throw new ru(nu.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+ff.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}gu("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?rd:t.experimentalForceLongPolling}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},t}(),ad=function(){},sd=function(){function t(e){var n=this;this._queue=new Xh,this.INTERNAL={delete:function(){return ur(n,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.shutdown()];case 1:return t.sent(),this.clientRunning=!1,[2]}})})}},this.clientRunning=!1;var r=new ad;if("object"==typeof e.options){var i=e;r.firebaseApp=i,r.databaseId=t.databaseIdFromApp(i),r.persistenceKey=r.firebaseApp.name,r.credentials=new Op(i)}else{var o=e;if(!o.projectId)throw new ru(nu.INVALID_ARGUMENT,"Must provide projectId");r.databaseId=new Uu(o.projectId,o.database),r.persistenceKey="[DEFAULT]",r.credentials=new kp}r.settings=new od({}),this._config=r,this._databaseId=r.databaseId}return t.prototype.settings=function(t){if(lu("Firestore.settings",arguments,1),du("Firestore.settings","object",1,t),ou(t,"persistence"))throw new ru(nu.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new od(t);if(this._firestoreClient&&!this._config.settings.isEqual(e))throw new ru(nu.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=e,void 0!==e.credentials&&(this._config.credentials=function(t){if(!t)return new kp;switch(t.type){case"gapi":var e=t.client;return Zs(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new _p(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new ru(nu.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},t.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},t.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},t.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new ru(nu.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new Ep(this._config.settings.cacheSizeBytes,void 0!==t&&au(t.experimentalTabSynchronization,!1)))},t.prototype._clearPersistence=function(){if(this.clientRunning)throw new ru(nu.FAILED_PRECONDITION,"Persistence cannot be cleared while the client is running");var t=wf.buildStoragePrefix(this.makeDatabaseInfo());return wf.clearPersistence(t)},t.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Tp),this._firestoreClient},t.prototype.makeDatabaseInfo=function(){return new Bu(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl,this._config.settings.forceLongPolling)},t.prototype.configureClient=function(t){var e=this;Zs(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),Zs(!this._firestoreClient,"configureClient() called multiple times"),this.clientRunning=!0;var n=this.makeDatabaseInfo();return this._dataConverter=new Hp(function(t){if(t instanceof hd){var n=e._config.databaseId,r=t.firestore._config.databaseId;if(!r.isEqual(n))throw new ru(nu.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new zp(e._config.databaseId,t._key)}return t}),this._firestoreClient=new Ip(tu.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(t)},t.databaseIdFromApp=function(t){var e=t.options;if(!ou(e,"projectId"))throw new ru(nu.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new ru(nu.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Uu(n)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new ru(nu.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return lu("Firestore.collection",arguments,1),du("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new yd(Qu.fromString(t),this)},t.prototype.doc=function(t){return lu("Firestore.doc",arguments,1),du("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),hd.forPath(Qu.fromString(t),this)},t.prototype._collectionGroup=function(t){if(lu("Firestore.collectionGroup",arguments,1),du("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new ru(nu.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new dd(new Ic(Qu.EMPTY_PATH,t),this)},t.prototype.runTransaction=function(t){var e=this;return lu("Firestore.runTransaction",arguments,1),du("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction(function(n){return t(new ud(e,n))})},t.prototype.batch=function(){return this.ensureClientConfigured(),new cd(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(zs()){case qs.DEBUG:return"debug";case qs.ERROR:return"error";case qs.SILENT:return"silent";default:return $s("Unknown log level: "+zs())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(lu("Firestore.setLogLevel",arguments,1),du("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":Hs(qs.DEBUG);break;case"error":Hs(qs.ERROR);break;case"silent":Hs(qs.SILENT);break;default:throw new ru(nu.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},t}(),ud=function(){function t(t,e){this._firestore=t,this._transaction=e}return t.prototype.get=function(t){var e=this;lu("Transaction.get",arguments,1);var n=wd("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return $s("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof Yu)return new fd(e._firestore,n._key,null,!1,!1);if(r instanceof Hu)return new fd(e._firestore,n._key,r,!1,!1);throw $s("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)})},t.prototype.set=function(t,e,n){pu("Transaction.set",arguments,2,3);var r=wd("Transaction.set",t,this._firestore),i=(n=gd("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return"string"==typeof e||e instanceof Dp?(fu("Transaction.update",arguments,3),r=wd("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):(lu("Transaction.update",arguments,2),r=wd("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},t.prototype.delete=function(t){lu("Transaction.delete",arguments,1);var e=wd("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},t}(),cd=function(){function t(t){this._firestore=t,this._mutations=[],this._committed=!1}return t.prototype.set=function(t,e,n){pu("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=wd("WriteBatch.set",t,this._firestore),i=(n=gd("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,Qc.NONE)),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),"string"==typeof e||e instanceof Dp?(fu("WriteBatch.update",arguments,3),r=wd("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):(lu("WriteBatch.update",arguments,2),r=wd("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,Qc.exists(!0))),this},t.prototype.delete=function(t){lu("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=wd("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Hc(e._key,Qc.NONE)),this},t.prototype.commit=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},t.prototype.verifyNotCommitted=function(){if(this._committed)throw new ru(nu.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),hd=function(){function t(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}return t.forPath=function(e,n){if(e.length%2!=0)throw new ru(nu.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new t(new Wu(e),n)},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new yd(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(lu("DocumentReference.collection",arguments,1),du("DocumentReference.collection","non-empty string",1,t),!t)throw new ru(nu.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=Qu.fromString(t);return new yd(this._key.path.child(e),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw Iu("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},t.prototype.set=function(t,e){pu("DocumentReference.set",arguments,1,2);var n=(e=gd("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,Qc.NONE))},t.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return"string"==typeof t||t instanceof Dp?(fu("DocumentReference.update",arguments,2),n=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):(lu("DocumentReference.update",arguments,1),n=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,Qc.exists(!0)))},t.prototype.delete=function(){return lu("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Hc(this._key,Qc.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];pu("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Mp(t[i])||(Tu("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),gu("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return Mp(t[i])?n=t[i]:(du("DocumentReference.onSnapshot","function",i,t[i]),mu("DocumentReference.onSnapshot","function",i+1,t[i+1]),mu("DocumentReference.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Cp({next:function(t){if(e.next){Zs(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n._key);e.next(new fd(n.firestore,n._key,r,t.fromCache,t.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(Ic.atPath(this._key.path),i,t);return function(){i.mute(),n._firestoreClient.unlisten(o)}},t.prototype.get=function(t){var e=this;return pu("DocumentReference.get",arguments,0,1),bd("DocumentReference.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentFromLocalCache(e._key).then(function(t){n(new fd(e.firestore,e._key,t,!0,t instanceof Hu&&t.hasLocalMutations))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new ru(nu.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new ru(nu.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},t}(),ld=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),fd=function(){function t(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}return t.prototype.data=function(t){return pu("DocumentSnapshot.data",arguments,0,1),t=vd("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data,ec.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},t.prototype.get=function(t,e){if(pu("DocumentSnapshot.get",arguments,1,2),e=vd("DocumentSnapshot.get",e),this._document){var n=this._document.data.field(Jp("DocumentSnapshot.get",t));if(void 0!==n)return this.convertValue(n,ec.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new hd(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new ld(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){if(!(e instanceof t))throw Iu("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},t.prototype.convertObject=function(t,e){var n=this,r={};return t.forEach(function(t,i){r[t]=n.convertValue(i,e)}),r},t.prototype.convertValue=function(t,e){if(t instanceof mc)return this.convertObject(t,e);if(t instanceof yc)return this.convertArray(t,e);if(t instanceof pc){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||Xs("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new hd(n,this._firestore)}return t.value(e)},t.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},t}(),pd=function(t){function e(e,n,r,i,o){return t.call(this,e,n,r,i,o)||this}return ar(e,t),e.prototype.data=function(e){var n=t.prototype.data.call(this,e);return Zs("object"==typeof n,"Document in a QueryDocumentSnapshot should exist"),n},e}(fd),dd=function(){function t(t,e){this._query=t,this.firestore=e}return t.prototype.where=function(e,n,r){var i;lu("Query.where",arguments,3),Eu("Query.where",3,r),function(t,e,n,r){if(!e.some(function(t){return t===r}))throw new ru(nu.INVALID_ARGUMENT,"Invalid value "+Su(r)+" provided to function Query.where() for its "+Cu(2)+" argument. Acceptable values: "+e.join(", "))}(0,["<","<=","==",">=",">","array-contains"],0,n);var o=Jp("Query.where",e),a=Dc.fromString(n);if(o.isKeyField()){if(a===Dc.ARRAY_CONTAINS)throw new ru(nu.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof r){if(""===r)throw new ru(nu.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==r.indexOf("/"))throw new ru(nu.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but '"+r+"' contains a slash.");var s=this._query.path.child(Qu.fromString(r));if(!Wu.isDocumentKey(s))throw new ru(nu.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+s+"' is not because it has an odd number of segments ("+s.length+").");i=new pc(this.firestore._databaseId,new Wu(s))}else{if(!(r instanceof hd))throw new ru(nu.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+Su(r)+".");i=new pc(this.firestore._databaseId,r._key)}}else i=this.firestore._dataConverter.parseQueryValue("Query.where",r);var u=Cc.create(o,a,i);return this.validateNewFilter(u),new t(this._query.addFilter(u),this.firestore)},t.prototype.orderBy=function(e,n){var r;if(pu("Query.orderBy",arguments,1,2),mu("Query.orderBy","non-empty string",2,n),void 0===n||"asc"===n)r=Oc.ASCENDING;else{if("desc"!==n)throw new ru(nu.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=Oc.DESCENDING}if(null!==this._query.startAt)throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=Jp("Query.orderBy",e),o=new _c(i,r);return this.validateNewOrderBy(o),new t(this._query.addOrderBy(o),this.firestore)},t.prototype.limit=function(e){if(lu("Query.limit",arguments,1),du("Query.limit","number",1,e),e<=0)throw new ru(nu.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new t(this._query.withLimit(e),this.firestore)},t.prototype.startAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];fu("Query.startAt",arguments,1);var i=this.boundFromDocOrFields("Query.startAt",e,n,!0);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.startAfter=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];fu("Query.startAfter",arguments,1);var i=this.boundFromDocOrFields("Query.startAfter",e,n,!1);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.endBefore=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];fu("Query.endBefore",arguments,1);var i=this.boundFromDocOrFields("Query.endBefore",e,n,!0);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.endAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];fu("Query.endAt",arguments,1);var i=this.boundFromDocOrFields("Query.endAt",e,n,!1);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw Iu("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},t.prototype.boundFromDocOrFields=function(t,e,n,r){if(Eu(t,1,e),e instanceof fd){if(n.length>0)throw new ru(nu.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new ru(nu.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},t.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new pc(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof lc)throw new ru(nu.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(void 0===s){var u=a.field.canonicalString();throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Rc(r,n)},t.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new ru(nu.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new ru(nu.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new ru(nu.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(Qu.fromString(a));if(!Wu.isDocumentKey(s))throw new ru(nu.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Wu(s);i.push(new pc(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new Rc(i,n)},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];pu("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||Mp(t[i])||(Tu("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),gu("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),Mp(t[i])?n=t[i]:(du("Query.onSnapshot","function",i,t[i]),mu("Query.onSnapshot","function",i+1,t[i+1]),mu("Query.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Cp({next:function(t){e.next&&e.next(new md(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},t.prototype.get=function(t){var e=this;return pu("Query.get",arguments,0,1),bd("Query.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentsFromLocalCache(e._query).then(function(t){n(new md(e.firestore,e._query,t))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new ru(nu.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},t.prototype.validateNewFilter=function(t){if(t instanceof Ac)if(t.isInequality()){var e=this._query.getInequalityFilterField();if(null!==e&&!e.isEqual(t.field))throw new ru(nu.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+e.toString()+"' and '"+t.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(t.field,n)}else if(t.op===Dc.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new ru(nu.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},t.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},t.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new ru(nu.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},t}(),md=function(){function t(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new ld(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach(function(e){return t.push(e)}),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;pu("QuerySnapshot.forEach",arguments,1,2),du("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach(function(r){t.call(e,n.convertToDocumentImpl(r))})},Object.defineProperty(t.prototype,"query",{get:function(){return new dd(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(Tu("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),gu("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new ru(nu.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map(function(e){var o=new pd(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key));return Zs(e.type===yh.Added,"Invalid event type for first snapshot"),Zs(!r||n.query.docComparator(r,e.doc)<0,"Got added events in wrong order"),r=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}var o=n.oldDocs;return n.docChanges.filter(function(t){return e||t.type!==yh.Metadata}).map(function(e){var r=new pd(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key)),i=-1,a=-1;return e.type!==yh.Added&&(Zs((i=o.indexOf(e.doc.key))>=0,"Index for document not found"),o=o.delete(e.doc.key)),e.type!==yh.Removed&&(a=(o=o.add(e.doc)).indexOf(e.doc.key)),{type:Sd(e.type),doc:r,oldIndex:i,newIndex:a}})}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},t.prototype.isEqual=function(e){if(!(e instanceof t))throw Iu("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},t.prototype.convertToDocumentImpl=function(t){return new pd(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},t}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(md.prototype.docChanges,t,{get:function(){return function(){throw new ru(nu.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var yd=function(t){function e(e,n){var r=t.call(this,Ic.atPath(e),n)||this;if(e.length%2!=1)throw new ru(nu.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e.canonicalString()+" has "+e.length);return r}return ar(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new hd(new Wu(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.doc=function(t){if(pu("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=Au.newId()),du("CollectionReference.doc","non-empty string",1,t),""===t)throw new ru(nu.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=Qu.fromString(t);return hd.forPath(this._query.path.child(e),this.firestore)},e.prototype.add=function(t){lu("CollectionReference.add",arguments,1),du("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},e}(dd);function gd(t,e){if(void 0===e)return{merge:!1};if(Tu(t,e,["merge","mergeFields"]),gu(t,"boolean","merge",e.merge),n=t,r="mergeFields",i="a string or a FieldPath",a=function(t){return"string"==typeof t||t instanceof Dp},void 0!==(o=e.mergeFields)&&function(t,e,n,r,i){if(!(r instanceof Array))throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+Su(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new ru(nu.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+Su(r[o]))}(n,r,i,o,a),void 0!==e.mergeFields&&void 0!==e.merge)throw new ru(nu.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');var n,r,i,o,a;return e}function vd(t,e){return void 0===e?{}:(Tu(t,e,["serverTimestamps"]),vu(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function bd(t,e){mu(t,"object",1,e),e&&(Tu(t,e,["source"]),vu(t,0,"source",e.source,["default","server","cache"]))}function wd(t,e,n){if(e instanceof hd){if(e.firestore!==n)throw new ru(nu.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw Iu(t,"DocumentReference",1,e)}function Sd(t){switch(t){case yh.Added:return"added";case yh.Modified:case yh.Metadata:return"modified";case yh.Removed:return"removed";default:return $s("Unknown change type: "+t)}}var Ed=iu(sd,"Use firebase.firestore() instead."),Td=iu(ud,"Use firebase.firestore().runTransaction() instead."),Id=iu(cd,"Use firebase.firestore().batch() instead."),Cd=iu(hd,"Use firebase.firestore().doc() instead."),Dd=iu(fd),Ad=iu(pd),Nd=iu(dd),kd=iu(md),Od=iu(yd,"Use firebase.firestore().collection() instead.");Or.INTERNAL.registerService("firestore",function(t){return new sd(t)},function(t){Zs(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}({Firestore:Ed,GeoPoint:qu,Timestamp:Fu,Blob:Lu,Transaction:Td,WriteBatch:Id,DocumentReference:Cd,DocumentSnapshot:Dd,Query:Nd,QueryDocumentSnapshot:Ad,QuerySnapshot:kd,CollectionReference:Od,FieldPath:Dp,FieldValue:Up,setLogLevel:sd.setLogLevel,CACHE_SIZE_UNLIMITED:id}));var Rd,_d,Md=window.fontumiConfig,Pd=function(){return ur(e,void 0,void 0,function(){return cr(this,function(t){return Md.debug&&console.warn("FONTUMI:DEBUG","loading firebase"),Rd||(Rd=Or.initializeApp(window.fontumiConfig.firebase)),_d=Rd.firestore(),Md.debug&&console.warn("FONTUMI:DEBUG","app and db ready"),[2,{app:Rd,db:_d}]})})},xd=function(){function t(){this.userInfo={name:"Yo"},this.fontumi=window.fontumi,this.fontumiConfig=window.fontumiConfig,this.messages=[],this.loading=!0,this.message=""}return t.prototype.replie=function(t){this.sendNewMessage(t.detail)},t.prototype.addMessage=function(t){o(["message added",t]),this.messages=this.messages.concat([t])},t.prototype.sendNewMessage=function(t){return ur(this,void 0,void 0,function(){var e;return cr(this,function(n){switch(n.label){case 0:return[4,this.chat.get()];case 1:return e=n.sent(),this.loading=!0,this.message="",[4,this.chat.update({messages:e.data().messages.concat([{isUser:!0,message:t,name:""}])})];case 2:return n.sent(),this.loading=!0,this.message="",[2]}})})},t.prototype.sendMessage=function(){return ur(this,void 0,void 0,function(){return cr(this,function(t){switch(t.label){case 0:return this.chat&&this.message.trim()&&!this.loading?[4,this.sendNewMessage(this.message)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.componentDidLoad=function(){return ur(this,void 0,void 0,function(){var t,e=this;return cr(this,function(n){switch(n.label){case 0:return o("chat-card loaded"),[4,Pd()];case 1:return n.sent(),t=this,[4,_d.collection("chats").add({projectId:Md.firebase.projectId,dfOn:Md.dfOn,sessionId:(r=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"==t?e:3&e|8).toString(16)})),languageCode:Md.languageCode,user:{name:"",email:""},name:Md.name,messages:[]})];case 2:return t.chat=n.sent(),this.messages=[],this.chat.onSnapshot(function(t){return ur(e,void 0,void 0,function(){var e,n;return cr(this,function(r){return t.data()&&(e=t.data().messages,(n=e[e.length-1])&&(this.addMessage(n),n.isUser||(this.loading=!1),console.log(this.messages))),[2]})})}),[2]}var r})})},t.prototype.render=function(){var t=this;return n("div",null,n("div",{id:"chat-card-content"},this.messages.map(function(t){return n("chat-message",{message:t})}),this.loading&&n("chat-message",{message:{message:[{message:"text",platform:"PLATFORM_UNSPECIFIED",text:{text:["Escribiendo..."]}}],name:null,isUser:!1}})),n("div",{id:"chat-card-footer"},n("div",{style:{"flex-grow":"3"}},n("input",{value:this.message,onInput:function(e){t.message=e.target.value},onKeyDown:function(e){13===e.keyCode&&t.sendMessage()},type:"text",placeholder:"Escribir mensaje"})),n("div",{style:{"flex-grow":"1"}},n("button",{style:{borderColor:this.fontumiConfig.colors.a,color:this.fontumiConfig.colors.a},onClick:function(){return t.sendMessage()}},"Enviar"))))},Object.defineProperty(t,"is",{get:function(){return"chat-card-messages"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{chat:{state:!0},loading:{state:!0},message:{state:!0},messages:{state:!0},userInfo:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"listeners",{get:function(){return[{name:"replie",method:"replie"}]},enumerable:!0,configurable:!0}),t}(),Ld=function(){function t(){}return t.prototype.render=function(){return n("div",{id:"chat-container"},n("chat-card",null),n("div",{id:"chat-background"}))},Object.defineProperty(t,"is",{get:function(){return"chat-container"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"#chat-container.sc-chat-container{min-width:300px;position:fixed;bottom:66px!important;-webkit-transition:opacity .3s ease-out;transition:opacity .3s ease-out;right:0;z-index:1000000!important}\@media (min-width:750px){#chat-container.sc-chat-container{width:400px!important}}\@media (max-width:750px){#chat-container.sc-chat-container{min-width:auto;width:calc(100vw)!important}}"},enumerable:!0,configurable:!0}),t}(),qd=function(){function t(){}return t.prototype.render=function(){return n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"white",width:"30px",x:"0px",y:"0px",viewBox:"0 0 52 52"},n("g",null,n("path",{d:"M26,0C11.664,0,0,11.663,0,26s11.664,26,26,26s26-11.663,26-26S40.336,0,26,0z M26,50C12.767,50,2,39.233,2,26S12.767,2,26,2s24,10.767,24,24S39.233,50,26,50z"}),n("path",{d:"M35.707,16.293c-0.391-0.391-1.023-0.391-1.414,0L26,24.586l-8.293-8.293c-0.391-0.391-1.023-0.391-1.414,0s-0.391,1.023,0,1.414L24.586,26l-8.293,8.293c-0.391,0.391-0.391,1.023,0,1.414C16.488,35.902,16.744,36,17,36s0.512-0.098,0.707-0.293L26,27.414l8.293,8.293C34.488,35.902,34.744,36,35,36s0.512-0.098,0.707-0.293c0.391-0.391,0.391-1.023,0-1.414L27.414,26l8.293-8.293C36.098,17.316,36.098,16.684,35.707,16.293z"})),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null))},Object.defineProperty(t,"is",{get:function(){return"close-icon"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),t}(),Fd=function(){function t(){this.opened=!1,this.closeWelcomeMessage=!0,this.fontumiConfig=window.fontumiConfig}return t.prototype.toggle=function(){this.opened=!this.opened,this.closeWelcomeMessage=!0},t.prototype.hi=function(){console.log("hi")},t.prototype.componentWillLoad=function(){o("chat-wrapper did load")},t.prototype.componentDidLoad=function(){var t,e,n,r,i,o=this;setTimeout(function(){return o.closeWelcomeMessage=!1},1e3),setTimeout(function(){document.getElementById("hubspot-messages-iframe-container")&&document.getElementById("hubspot-messages-iframe-container").remove()},5e3),t=window,e=document,n="script",t.GoogleAnalyticsObject="ga",t.ga=t.ga||function(){(t.ga.q=t.ga.q||[]).push(arguments)},t.ga.l=Date.now(),r=e.createElement(n),i=e.getElementsByTagName(n)[0],r.async=1,r.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(r,i),window.ga("create","UA-40818966-1","auto"),window.ga("send","pageview")},t.prototype.render=function(){var t=this;return n("div",{id:"chat-wrapper"},n("chat-container",{style:{visibility:this.opened?"visible":"hidden",opacity:this.opened?"1":"0"}}),n("div",{onClick:function(){t.el.shadowRoot.querySelector("bubble-button").toggleBtn()},id:"welcome-message",style:{visibility:this.closeWelcomeMessage?"hidden":"visible"}},n("div",{class:"welcome-message"},!1,n("div",{class:"welcome-message-inner"},n("div",{class:"welcome-message-text"},this.fontumiConfig.ui&&this.fontumiConfig.ui.welcomeMessage?this.fontumiConfig.ui.welcomeMessage:"¡Hola!")))),n("bubble-button",null))},Object.defineProperty(t,"is",{get:function(){return"fontumi-chat-wrapper"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{closeWelcomeMessage:{state:!0},el:{elementRef:!0},hi:{method:!0},opened:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"listeners",{get:function(){return[{name:"toggle",method:"toggle"}]},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"\@import url(\"https://fonts.googleapis.com/css?family=Work+Sans:300,400\");.sc-fontumi-chat-wrapper-h{--fontumi-font:sans-serif;--fontumi-shadow:0 0 8px 0 rgba(0,0,0,0.4)!important;--fontumi-flex-padding:10px;--fontumi-border-radius:10px;--fontumi-font:\"Work Sans\",sans-serif}#fontumi-chat.sc-fontumi-chat-wrapper{z-index:10000000}.welcome-message-hidden.sc-fontumi-chat-wrapper{visibility:hidden!important}#welcome-message.sc-fontumi-chat-wrapper{font-family:Inter UI,sans-serif;position:relative;font-size:14px;line-height:22px;color:#617190;max-width:260px;position:fixed;z-index:99999;bottom:25px;right:25px;background:#fff;border-radius:2px;padding:24px;-webkit-box-shadow:0 4px 16px rgba(16,31,59,.16);box-shadow:0 4px 16px rgba(16,31,59,.16)}.welcome-message-close.sc-fontumi-chat-wrapper{cursor:pointer;position:absolute;top:29px;right:24px}.welcome-message-text.sc-fontumi-chat-wrapper{padding-right:40px}.welcome-message-cta.sc-fontumi-chat-wrapper{display:block;color:#fff;background:#7f6df8;background:linear-gradient(65deg,#6954f7 -25%,#9485f9);font-size:12px;letter-spacing:-.1px;font-weight:700;line-height:16px;text-transform:uppercase;text-decoration:none!important;border:none;border-radius:2px;cursor:pointer;-ms-flex-pack:center;justify-content:center;padding:12px 32px;text-align:center;white-space:nowrap}\@media (max-width:641px){#welcome-message.sc-fontumi-chat-wrapper{bottom:0;left:0;right:0;max-width:none;text-align:center}}\@media (max-width:641px){.welcome-message-inner.sc-fontumi-chat-wrapper{max-width:240px;margin-left:auto;margin-right:auto}}"},enumerable:!0,configurable:!0}),t}(),Bd=function(){function t(){}return t.prototype.render=function(){return n("svg",{version:"1.1",id:"Capa_1",xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",fill:"white",width:this.width,viewBox:"0 0 32.192 32.192"},n("g",null,n("path",{d:"M0,17.783l0.02,2.637l0.003,0.004c0.006,0.603,0.498,1.033,1.047,1.027l0.007,0.004l7.489-0.06\n\t\tc0.578-0.005,1.028-0.476,1.022-1.043l-0.021-2.64l-0.366,0.005c0.114-1.096,1.444-1.354,4.096-1.647l6.383-0.055\n\t\tc1.534,0.149,3.022,0.425,3.129,1.617l-0.205,0.001l0.021,2.637l0.001,0.004c0.005,0.605,0.499,1.033,1.049,1.028l0.006,0.005\n\t\tl7.488-0.062c0.579-0.002,1.027-0.474,1.023-1.041l-0.022-2.64l-0.271,0.002c-0.264-1.604-2.91-6.78-15.413-6.828\n\t\tc-12.975-0.047-16.012,5.323-16.17,7.043L0,17.783z"})),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null),n("g",null))},Object.defineProperty(t,"is",{get:function(){return"hangup-icon"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{width:{type:String,attr:"width"}}},enumerable:!0,configurable:!0}),t}(),Vd=function(){function t(){}return t.prototype.render=function(){return n("svg",{width:this.width,fill:"white",viewBox:"0 0 512 512",xmlns:"http://www.w3.org/2000/svg"},n("path",{d:"m472 110c0 5.523438-4.476562 10-10 10s-10-4.476562-10-10 4.476562-10 10-10 10 4.476562 10 10zm0 0"}),n("path",{d:"m266 50c0 5.523438-4.476562 10-10 10s-10-4.476562-10-10 4.476562-10 10-10 10 4.476562 10 10zm0 0"}),n("path",{d:"m316 200c0-33.085938-26.914062-60-60-60s-60 26.914062-60 60 26.914062 60 60 60 60-26.914062 60-60zm-60 40c-22.054688 0-40-17.945312-40-40s17.945312-40 40-40 40 17.945312 40 40-17.945312 40-40 40zm0 0"}),n("path",{d:"m482 40h-177.007812c-4.644532-22.796875-24.847657-40-48.992188-40s-44.347656 17.203125-48.992188 40h-177.007812c-16.542969 0-30 13.457031-30 30v306c0 16.542969 13.457031 30 30 30h176v46h-30c-24.144531 0-44.347656 17.203125-48.992188 40h-31.007812c-5.523438 0-10 4.476562-10 10s4.476562 10 10 10h320c5.523438 0 10-4.476562 10-10s-4.476562-10-10-10h-31.007812c-4.644532-22.796875-24.84375-40-48.992188-40h-30v-46h176c16.542969 0 30-13.457031 30-30v-306c0-16.542969-13.457031-30-30-30zm-226-20c16.542969 0 30 13.457031 30 30s-13.457031 30-30 30-30-13.457031-30-30 13.457031-30 30-30zm-226 40h177.007812c4.644532 22.796875 24.84375 40 48.992188 40s44.347656-17.203125 48.992188-40h177.007812c5.515625 0 10 4.484375 10 10v250h-151.121094c-12.578125-35.691406-46.429687-60-84.878906-60s-72.300781 24.308594-84.878906 60h-151.121094v-250c0-5.515625 4.484375-10 10-10zm289.265625 260h-126.53125c11.394531-24.070312 35.820313-40 63.265625-40s51.871094 15.929688 63.265625 40zm45.015625 172h-216.5625c4.128906-11.640625 15.246094-20 28.28125-20h160c13.035156 0 24.152344 8.359375 28.28125 20zm-78.28125-40h-60v-46h60zm196-66h-452c-5.515625 0-10-4.484375-10-10v-36h472v36c0 5.515625-4.484375 10-10 10zm0 0"}),n("path",{d:"m356 120h66c5.523438 0 10-4.476562 10-10s-4.476562-10-10-10h-66c-5.523438 0-10 4.476562-10 10s4.476562 10 10 10zm0 0"}))},Object.defineProperty(t,"is",{get:function(){return"video-call-icon"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{width:{type:String,attr:"width"}}},enumerable:!0,configurable:!0}),t}();t.BubbleButton=r,t.CallbackIcon=i,t.ChatCard=a,t.ChatCardByfontumi=s,t.ChatCardCall=h,t.ChatCardHeader=l,t.ChatCardMessages=xd,t.ChatContainer=Ld,t.CloseIcon=qd,t.FontumiChatWrapper=Fd,t.HangupIcon=Bd,t.VideoCallIcon=Vd,Object.defineProperty(t,"__esModule",{value:!0})});